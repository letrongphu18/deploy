@model List<TMD.Models.UserTask>
@{
    ViewData["Title"] = "Công việc của tôi";
    Layout = "~/Views/Shared/_LayoutStaff.cshtml";
}
<link href="~/css/tasklist-staff.css" rel="stylesheet" />
<div class="task-page">
    <div class="task-header">
        <div class="task-header-content">
            <div class="task-header-left">
                <h1><i class="fas fa-tasks"></i> Công việc của tôi</h1>
                <p>Quản lý các công việc đã được giao và cập nhật tiến độ.</p>
            </div>
            <div class="task-stats">
                <div class="stat-card">
                    <div class="stat-number" id="statDone">0</div>
                    <div class="stat-label">Hoàn thành</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statInProgress">0</div>
                    <div class="stat-label">Đang làm</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statTotal">0</div>
                    <div class="stat-label">Tổng cộng</div>
                </div>
            </div>
        </div>
    </div>

    <div class="filters-container">
        <div class="filters-grid">
            <div class="filter-item">
                <label><i class="fas fa-list"></i> Trạng thái</label>
                <select class="filter-select" id="filterStatus">
                    <option value="">Tất cả</option>
                    <option value="TODO">Chưa bắt đầu</option>
                    <option value="InProgress">Đang làm</option>
                    <option value="Testing">Chờ test</option>
                    <option value="Done">Hoàn thành</option>
                    <option value="Reopen">Cần sửa lại</option>
                </select>
            </div>
            <div class="filter-item">
                <label><i class="fas fa-flag"></i> Mức độ ưu tiên</label>
                <select class="filter-select" id="filterPriority">
                    <option value="">Tất cả</option>
                    <option value="High">Cao</option>
                    <option value="Medium">Trung bình</option>
                    <option value="Low">Thấp</option>
                </select>
            </div>
            <div class="filter-item">
                <label><i class="fas fa-search"></i> Tìm kiếm</label>
                <input type="text" class="filter-input" id="searchTask" placeholder="Tìm tên công việc...">
            </div>
        </div>
    </div>

    @if (!Model.Any())
    {
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>Chưa có công việc nào</h3>
            <p>Bạn chưa được giao công việc nào. Hãy liên hệ quản lý để được phân công.</p>
        </div>
    }
    else
    {
        <div class="tasks-container" id="taskList">
            @foreach (var userTask in Model)
            {
                var task = userTask.Task;
                var priorityClass = (task.Priority ?? "Medium").ToLower();
                var statusClass = (userTask.Status ?? "TODO").ToLower();
                var statusText = userTask.Status switch
                {
                    "TODO" => "Chưa bắt đầu",
                    "InProgress" => "Đang làm",
                    "Testing" => "Chờ test",
                    "Done" => "Hoàn thành",
                    "Reopen" => "Cần sửa lại",
                    _ => "Chưa bắt đầu"
                };
                var statusIcon = userTask.Status switch
                {
                    "TODO" => "inbox",
                    "InProgress" => "spinner fa-spin",
                    "Testing" => "vial",
                    "Done" => "check-circle",
                    "Reopen" => "redo",
                    _ => "inbox"
                };
                var isOverdue = task.Deadline.HasValue && DateTime.Now > task.Deadline.Value && userTask.Status != "Done";

                <div class="task-item"
                     data-id="@userTask.UserTaskId"
                     data-status="@userTask.Status"
                     data-priority="@(task.Priority ?? "Medium")"
                     data-name="@task.TaskName"
                     onclick="viewTask(@task.TaskId)"
                     style="cursor: pointer;">

                    <div class="priority-badge priority-@priorityClass">
                        <i class="fas fa-flag"></i> @(task.Priority ?? "Medium")
                    </div>

                    <div class="task-content">
                        <div class="task-title">
                            <strong>@task.TaskName</strong>
                            @if (isOverdue)
                            {
                                <span class="badge-overdue">
                                    <i class="fas fa-exclamation-triangle"></i> QUÁ HẠN
                                </span>
                            }
                        </div>
                        <div class="task-meta">
                            <span>
                                <i class="fas fa-calendar-alt"></i>
                                Ngày giao: @task.CreatedAt?.ToString("dd/MM/yyyy")
                            </span>
                            @if (task.Deadline.HasValue)
                            {
                                <span>
                                    <i class="fas fa-hourglass-half"></i>
                                    Hạn: @task.Deadline.Value.ToString("dd/MM/yyyy")
                                </span>
                            }
                        </div>

                        @* ✅ FIX: CHỈ HIỂN THỊ KHI STATUS = REOPEN HOẶC INPROGRESS (SAU KHI REOPEN) *@
                        @if (!string.IsNullOrEmpty(userTask.ReopenReason))
                        {
                            var isCurrentlyReopen = userTask.Status == "Reopen";
                            var boxClass = isCurrentlyReopen ? "reopen-reason-box" : "reopen-reason-box-warning";
                            var labelColor = isCurrentlyReopen ? "var(--danger)" : "var(--warning)";
                            var borderColor = isCurrentlyReopen ? "var(--danger)" : "var(--warning)";
                            var bgColor = isCurrentlyReopen ? "rgba(239, 68, 68, 0.05)" : "rgba(245, 158, 11, 0.05)";

                            <div class="@boxClass" style="background: @bgColor; border-left-color: @borderColor;">
                                <div class="reopen-reason-label" style="color: @labelColor;">
                                    <i class="fas fa-exclamation-circle"></i> 
                                    @if (isCurrentlyReopen)
                                    {
                                        <span>Lý do Reopen:</span>
                                    }
                                    else
                                    {
                                        <span>💡 Lưu ý từ lần Reopen trước:</span>
                                    }
                                </div>
                                <p class="reopen-reason-text">
                                    @userTask.ReopenReason
                                    @if (!isCurrentlyReopen)
                                    {
                                        <br><small style="color: var(--text-secondary); font-style: italic;">
                                            Hãy đảm bảo đã sửa đúng vấn đề này trước khi gửi test lại
                                        </small>
                                    }
                                </p>
                            </div>
                        }
                    </div>

                    <div class="status-badge status-@statusClass">
                        <i class="fas fa-@statusIcon"></i> <span>@statusText</span>
                    </div>

                    <div class="task-actions" onclick="event.stopPropagation();">
                        <button class="action-btn action-btn-view" onclick="viewTask(@task.TaskId)" title="Xem chi tiết">
                            <i class="fas fa-eye"></i>
                        </button>
                        @if (userTask.Status != "Done" && userTask.Status != "Testing")
                        {
                            <button class="action-btn action-btn-edit" onclick="updateTask(@userTask.UserTaskId)" title="Cập nhật">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        }
                    </div>
                </div>
            }
        </div>
        <div class="empty-state hidden" id="emptyFilter">
            <i class="fas fa-search"></i>
            <h3>Không tìm thấy công việc</h3>
            <p>Hãy thử thay đổi tiêu chí tìm kiếm hoặc bộ lọc.</p>
        </div>
    }
</div>

<!-- Modal: Chi Tiết Công Việc -->
<div class="modal" id="detailModal">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-info-circle"></i> Chi Tiết Công Việc</h5>
            <button class="modal-close" onclick="closeModal('detailModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="detailContent">
            <div class="loading">
                <div class="spinner"></div>
                <p class="mt-2">Đang tải...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('detailModal')">Đóng</button>
        </div>
    </div>
</div>

<!-- Modal: Cập Nhật Tiến Độ -->
<div class="modal" id="updateModal">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-history"></i> Cập Nhật Tiến Độ</h5>
            <button class="modal-close" onclick="closeModal('updateModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="updateTaskId">
            <input type="hidden" id="currentStatus">
            <div class="form-group">
                <label class="form-label">Trạng thái hiện tại</label>
                <input type="text" class="form-control" id="currentStatusText" disabled>
            </div>

            <div class="form-group">
                <label class="form-label">
                    Cập nhật thành <span class="required">*</span>
                </label>
                <select class="form-control" id="newStatus">
                    <option value="">-- Chọn trạng thái --</option>
                </select>
            </div>

            <div class="form-group hidden" id="reportLinkGroup">
                <label class="form-label">Link báo cáo</label>
                <input type="text" class="form-control" id="reportLink" placeholder="https://...">
                <small class="form-text">Tùy chọn - Link đến báo cáo hoặc tài liệu liên quan</small>
            </div>

            <div class="form-group hidden" id="testerGroup">
                <label class="form-label">
                    Chọn Tester <span class="required">*</span>
                </label>
                <select class="form-control" id="testerId">
                    <option value="">-- Chọn Tester --</option>
                </select>
                <small class="form-text">Bắt buộc khi gửi test</small>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('updateModal')">Hủy</button>
            <button class="btn btn-primary" onclick="submitUpdate()">
                <i class="fas fa-check"></i> Cập nhật
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let userPermissions = null;
        let allTesters = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await loadPermissions();
            calculateStats();
            setupFilters();
            setupModalClose();
        });

        async function loadPermissions() {
            try {
                const res = await fetch('/Staff/GetUserPermissions');
                const data = await res.json();
                if (data.success) {
                    userPermissions = data.permissions;
                    console.log('✅ Permissions loaded:', userPermissions);

                    if (userPermissions.canSendToTesting) {
                        await loadTesters();
                    }
                } else {
                    showError('Không thể tải thông tin quyền: ' + data.message);
                }
            } catch (err) {
                console.error('Error loading permissions:', err);
                showError('Lỗi khi tải thông tin quyền');
            }
        }

        async function loadTesters() {
            try {
                const res = await fetch('/Staff/GetTesters');
                const data = await res.json();
                if (data.success && data.testers) {
                    allTesters = data.testers;
                    const select = document.getElementById('testerId');
                    select.innerHTML = '<option value="">-- Chọn Tester --</option>';
                    data.testers.forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t.userId;
                        opt.textContent = `${t.fullName} (${t.departmentName})`;
                        select.appendChild(opt);
                    });
                }
            } catch (err) {
                console.error('Error loading testers:', err);
            }
        }

        function calculateStats() {
            const items = document.querySelectorAll('.task-item');
            let done = 0, inProgress = 0;

            items.forEach(item => {
                const status = (item.dataset.status || '').toLowerCase();
                if (status === 'done') done++;
                else if (['inprogress', 'testing', 'reopen'].includes(status)) inProgress++;
            });
            document.getElementById('statDone').textContent = done;
            document.getElementById('statInProgress').textContent = inProgress;
            document.getElementById('statTotal').textContent = items.length;
        }

        function setupFilters() {
            document.getElementById('filterStatus').addEventListener('change', filterTasks);
            document.getElementById('filterPriority').addEventListener('change', filterTasks);
            document.getElementById('searchTask').addEventListener('input', filterTasks);
        }

        function filterTasks() {
            const status = document.getElementById('filterStatus').value.toLowerCase();
            const priority = document.getElementById('filterPriority').value.toLowerCase();
            const search = document.getElementById('searchTask').value.toLowerCase().trim();

            const items = document.querySelectorAll('.task-item');
            const emptyFilter = document.getElementById('emptyFilter');
            let visible = 0;

            items.forEach(item => {
                const itemStatus = (item.dataset.status || '').toLowerCase();
                const itemPriority = (item.dataset.priority || '').toLowerCase();
                const itemName = (item.dataset.name || '').toLowerCase();

                const match = (!status || itemStatus === status) &&
                              (!priority || itemPriority === priority) &&
                              (!search || itemName.includes(search));

                if (match) {
                    item.style.display = 'flex';
                    visible++;
                } else {
                    item.style.display = 'none';
                }
            });

            if (emptyFilter) {
                emptyFilter.classList.toggle('hidden', visible > 0);
            }
        }

        function openModal(id) {
            document.getElementById(id).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
            document.body.style.overflow = '';
        }

        function setupModalClose() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });
        }

        // ✅ FIX: Sử dụng taskId thay vì userTaskId
        async function viewTask(taskId) {
            openModal('detailModal');
            const content = document.getElementById('detailContent');
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p class="mt-2">Đang tải chi tiết...</p>
                </div>
            `;
            try {
                const res = await fetch(`/Staff/GetTaskDetail?taskId=${taskId}`);
                const data = await res.json();

                if (data.success) {
                    const t = data.task;
                    const statusClass = `status-${(t.status || 'todo').toLowerCase()}`;
                    const priorityClass = `priority-${(t.priority || 'medium').toLowerCase()}`;

                    let reopenSection = '';
                    if (t.reopenReason) {
                        const isCurrentlyReopen = t.status === 'Reopen';
                        const labelText = isCurrentlyReopen ? 'Lý do Reopen' : 'Lưu ý từ lần Reopen trước';
                        const bgColor = isCurrentlyReopen ? 'rgba(239, 68, 68, 0.05)' : 'rgba(245, 158, 11, 0.05)';
                        const borderColor = isCurrentlyReopen ? 'var(--danger)' : 'var(--warning)';
                        const textColor = isCurrentlyReopen ? 'var(--danger)' : 'var(--warning)';
                        
                        reopenSection = `
                            <div class="form-group">
                                <label class="form-label" style="color: ${textColor};">
                                    <i class="fas fa-exclamation-circle"></i> ${labelText}
                                </label>
                                <div style="padding: 1rem; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: var(--radius-md); line-height: 1.6;">
                                    ${t.reopenReason}
                                    ${!isCurrentlyReopen ? '<br><small style="color: var(--text-secondary); font-style: italic;">💡 Hãy đảm bảo đã sửa đúng vấn đề này trước khi gửi test lại</small>' : ''}
                                </div>
                            </div>
                        `;
                    }

                    content.innerHTML = `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="font-size: 1.375rem; font-weight: 700; margin-bottom: 1rem;">
                                ${t.taskName}
                            </h4>
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem;">
                                <div class="status-badge ${statusClass}">
                                    <i class="fas fa-circle"></i> ${getStatusText(t.status)}
                                </div>
                                <div class="priority-badge ${priorityClass}">
                                    <i class="fas fa-flag"></i> ${t.priority}
                                </div>
                                ${t.isOverdue ? '<span class="badge-overdue"><i class="fas fa-exclamation-triangle"></i> QUÁ HẠN</span>' : ''}
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-align-left"></i> Mô tả</label>
                            <div style="padding: 1rem; background: var(--light-bg); border-radius: var(--radius-md); line-height: 1.6;">
                                ${t.description || '<em style="color: var(--text-secondary);">Không có mô tả</em>'}
                            </div>
                        </div>

                        ${reopenSection}

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-laptop-code"></i> Nền tảng</label>
                            <input type="text" class="form-control" value="${t.platform}" disabled>
                        </div>

                        ${t.reportLink ? `
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-link"></i> Link báo cáo</label>
                            <a href="${t.reportLink}" target="_blank" class="btn btn-secondary" style="width: 100%; justify-content: center;">
                                <i class="fas fa-external-link-alt me-1"></i> Mở Link
                            </a>
                        </div>
                        ` : ''}

                        ${t.testerName ? `
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-user-check"></i> Tester phụ trách</label>
                            <input type="text" class="form-control" value="${t.testerName}" disabled>
                        </div>
                        ` : ''}

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-calendar-alt"></i> Ngày giao</label>
                                <input type="text" class="form-control" value="${t.createdAt || 'N/A'}" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-hourglass-half"></i> Hạn chót</label>
                                <input type="text" class="form-control" value="${t.deadlineStr}" disabled>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-clock"></i> Cập nhật lần cuối</label>
                            <input type="text" class="form-control" value="${t.updatedAt}" disabled>
                        </div>
                    `;
                } else {
                    content.innerHTML = `<p style="color: var(--danger); text-align: center;">${data.message}</p>`;
                }
            } catch (err) {
                console.error('Error:', err);
                content.innerHTML = `<p style="color: var(--danger); text-align: center;">Lỗi kết nối: ${err.message}</p>`;
            }
        }

        async function updateTask(id) {
            if (!userPermissions) {
                showWarning('Vui lòng đợi hệ thống tải thông tin quyền...');
                return;
            }

            try {
                const item = document.querySelector(`.task-item[data-id="${id}"]`);
                const currentStatus = item ? item.dataset.status : 'TODO';
                const currentStatusText = item ? item.querySelector('.status-badge span').textContent : '';

                document.getElementById('updateTaskId').value = id;
                document.getElementById('currentStatus').value = currentStatus;
                document.getElementById('currentStatusText').value = currentStatusText;
                document.getElementById('reportLink').value = '';
                document.getElementById('reportLinkGroup').classList.add('hidden');
                document.getElementById('testerGroup').classList.add('hidden');
                document.getElementById('testerId').value = '';

                const select = document.getElementById('newStatus');
                select.innerHTML = '<option value="">-- Chọn trạng thái --</option>';

                let options = [];
                const isDev = userPermissions.canSendToTesting;

                if (currentStatus === 'Testing' || currentStatus === 'Done') {
                    if (currentStatus === 'Testing') {
                        showInfo('Công việc đang ở trạng thái **Chờ test**. Vui lòng đợi Tester phản hồi.');
                    } else {
                        showInfo('Công việc đã **Hoàn thành** và không thể thay đổi trạng thái.');
                    }
                    return;
                }

                if (currentStatus === 'TODO') {
                    options.push('InProgress');
                    if (isDev) {
                        options.push('Testing');
                    }
                }
                else if (currentStatus === 'InProgress') {
                    if (isDev) {
                        options.push('Testing');
                    }
                    options.push('Done');
                }
                else if (currentStatus === 'Reopen') {
                    options.push('InProgress');
                }

                const statusMap = {
                    'InProgress': 'Đang làm',
                    'Testing': 'Chờ test',
                    'Done': 'Hoàn thành',
                    'Reopen': 'Cần sửa lại'
                };

                [...new Set(options)].forEach(status => {
                    const opt = document.createElement('option');
                    opt.value = status;
                    opt.textContent = statusMap[status] || status;
                    select.appendChild(opt);
                });

                if (select.options.length <= 1) {
                    showInfo('Không có trạng thái nào hợp lệ để chuyển tiếp công việc này.');
                    return;
                }

                openModal('updateModal');
            } catch (err) {
                console.error('Error:', err);
                showError('Đã xảy ra lỗi khi chuẩn bị cập nhật tiến độ.');
            }
        }

        document.getElementById('newStatus').addEventListener('change', function() {
            const status = this.value;
            const reportLinkGroup = document.getElementById('reportLinkGroup');
            const testerGroup = document.getElementById('testerGroup');

            if (['InProgress', 'Done'].includes(status)) {
                reportLinkGroup.classList.remove('hidden');
            } else {
                reportLinkGroup.classList.add('hidden');
            }

            if (userPermissions?.canSendToTesting && status === 'Testing') {
                testerGroup.classList.remove('hidden');
            } else {
                testerGroup.classList.add('hidden');
            }
        });
        async function submitUpdate() {
        const taskId = document.getElementById('updateTaskId').value;
        const status = document.getElementById('newStatus').value;
        const reportLink = document.getElementById('reportLink').value.trim();
        const testerId = document.getElementById('testerId').value;
                if (!status) {
                    showWarning('Vui lòng chọn trạng thái mới.');
                    return;
                }

                if (status === 'Testing' && userPermissions.canSendToTesting && !testerId) {
                    showWarning('Vui lòng chọn Tester khi chuyển sang trạng thái "Chờ test".');
                    return;
                }

                const payload = {
                    UserTaskId: parseInt(taskId),
                    Status: status,
                    ReportLink: reportLink || null,
                    TesterId: status === 'Testing' ? (testerId ? parseInt(testerId) : null) : null
                };

                showLoading('Đang cập nhật...');

                try {
                    const res = await fetch('/Staff/UpdateTaskProgress', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();
                    if (data.success) {
                        await showSuccess('Cập nhật thành công!', data.message);
                        location.reload();
                    } else {
                        showError(data.message);
                    }
                } catch (err) {
                    console.error('Error:', err);
                    showError('Lỗi kết nối: ' + err.message);
                }
            }

            function getStatusText(status) {
                const map = {
                    'TODO': 'Chưa bắt đầu',
                    'InProgress': 'Đang làm',
                    'Testing': 'Chờ test',
                    'Done': 'Hoàn thành',
                    'Reopen': 'Cần sửa lại'
                };
                return map[status] || status;
            }

            function showLoading(title = 'Đang xử lý...') {
                Swal.fire({
                    title: title,
                    text: 'Vui lòng đợi giây lát',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => Swal.showLoading()
                });
            }

            async function showSuccess(title, text) {
                return Swal.fire({
                    icon: 'success',
                    title: title,
                    text: text,
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#10b981'
                });
            }

            function showError(message) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: message,
                    confirmButtonText: 'Đóng',
                    confirmButtonColor: '#ef4444'
                });
            }

            function showWarning(message) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Cảnh báo',
                    text: message,
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#f59e0b'
                });
            }

            function showInfo(message) {
                Swal.fire({
                    icon: 'info',
                    title: 'Thông báo',
                    html: message,
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#3b82f6'
                });
            }
    </script>
}