@{
    ViewData["Title"] = "Staff Dashboard";
    Layout = "~/Views/Shared/_LayoutStaff.cshtml";
    var user = ViewBag.User as TMD.Models.User;
}

<link href="~/css/staff-dashboard.css" rel="stylesheet" />

<div class="sd-container">
    <!-- WELCOME HEADER -->
    <div class="sd-page-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="sd-welcome-content">
                    <h2 class="sd-page-title">
                        <i class="fas fa-hand-sparkles me-2"></i>
                        Chào mừng trở lại, <strong>@user.FullName</strong>!
                    </h2>
                    <p class="sd-page-subtitle">
                        <i class="fas fa-briefcase"></i> @user.Role?.RoleName
                        @if (user.Department != null)
                        {
                            <span class="mx-2">•</span>
                            <i class="fas fa-building"></i> @user.Department.DepartmentName
                        }
                    </p>
                </div>
            </div>
            <div class="col-md-4 d-flex justify-content-end align-items-center">
                <div class="sd-current-time me-3">
                    <div id="currentDate" class="sd-date-display"></div>
                    <div id="currentTime" class="sd-time-display"></div>
                    <small class="sd-text-muted">Thời gian server</small>
                </div>

                <!-- Quick Requests -->
               @*  <div class="sd-quick-requests ms-3">
                    <div class="btn-group">
                        <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#overtimeModal">
                            <i class="fas fa-clock me-1"></i> Tăng ca
                        </button>
                        <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#leaveModal">
                            <i class="fas fa-umbrella-beach me-1"></i> Nghỉ phép
                        </button>
                        <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#lateModal">
                            <i class="fas fa-user-clock me-1"></i> Đi trễ
                        </button>
                    </div>
                </div> *@
            </div>
        </div>
    </div>

    <!-- STATISTICS -->
    <div class="row g-3 mb-4">
        <div class="col-md-3 col-6">
            <div class="sd-stats-card sd-stats-primary">
                <div class="sd-stats-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="sd-stats-content">
                    <div class="sd-stats-label">Ngày chấm công</div>
                    <div class="sd-stats-value">@(ViewBag.AttendanceThisMonth ?? 0)</div>
                </div>
                <div class="sd-stats-trend">
                    <i class="fas fa-chart-line"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="sd-stats-card sd-stats-success">
                <div class="sd-stats-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="sd-stats-content">
                    <div class="sd-stats-label">Tổng giờ làm</div>
                    <div class="sd-stats-value">@(ViewBag.TotalHoursThisMonth?.ToString("F0") ?? "0")h</div>
                </div>
                <div class="sd-stats-trend">
                    <i class="fas fa-arrow-up"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="sd-stats-card sd-stats-warning">
                <div class="sd-stats-icon">
                    <i class="fas fa-sign-in-alt"></i>
                </div>
                <div class="sd-stats-content">
                    <div class="sd-stats-label">Lần đăng nhập</div>
                    <div class="sd-stats-value">@ViewBag.ThisMonthLogins</div>
                </div>
                <div class="sd-stats-trend">
                    <i class="fas fa-user-check"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="sd-stats-card sd-stats-info">
                <div class="sd-stats-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="sd-stats-content">
                    <div class="sd-stats-label">Thành viên</div>
                    <div class="sd-stats-value">@(ViewBag.DepartmentUserCount ?? 0)</div>
                </div>
                <div class="sd-stats-trend">
                    <i class="fas fa-user-friends"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- CHECK-IN/OUT SECTION -->
        <div class="col-lg-8">
            <div class="sd-card">
                <div class="sd-card-header">
                    <h5>
                        <i class="fas fa-user-clock me-2"></i> Chấm công hôm nay
                    </h5>
                </div>
                <div class="sd-card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <!-- Photo Options -->
                            <div class="sd-photo-options mb-3">
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="photoMode" id="modeCamera" value="camera" checked>
                                    <label class="btn btn-outline-primary" for="modeCamera">
                                        <i class="fas fa-camera"></i> Chụp ảnh
                                    </label>
                                    <input type="radio" class="btn-check" name="photoMode" id="modeUpload" value="upload">
                                    <label class="btn btn-outline-primary" for="modeUpload">
                                        <i class="fas fa-upload"></i> Tải ảnh lên
                                    </label>
                                </div>
                            </div>

                            <!-- Camera Mode -->
                            <div id="cameraMode" class="photo-mode">
                                <div class="sd-camera-container">
                                    <div class="sd-camera-preview" id="cameraPreview">
                                        <video id="video" autoplay playsinline></video>
                                        <canvas id="canvas" style="display: none;"></canvas>
                                        <img id="capturedImage" style="display: none;" />
                                        <div class="sd-camera-overlay"></div>
                                    </div>
                                    <div class="sd-camera-controls">
                                        <button class="sd-btn-camera" id="btnCapture" onclick="capturePhoto()">
                                            <i class="fas fa-camera"></i>
                                        </button>
                                        <button class="sd-btn-camera sd-btn-warning" id="btnRetake" onclick="retakePhoto()" style="display: none;">
                                            <i class="fas fa-redo"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Upload Mode -->
                            <div id="uploadMode" class="photo-mode" style="display: none;">
                                <div class="sd-upload-container">
                                    <div class="sd-upload-preview" id="uploadPreview">
                                        <div class="sd-upload-placeholder" id="uploadPlaceholder">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <p>Kéo thả ảnh vào đây hoặc nhấn để chọn</p>
                                            <input type="file" id="fileInput" accept="image/jpeg,image/jpg,image/png" style="display: none;">
                                        </div>
                                        <img id="uploadedImage" style="display: none;" />
                                    </div>
                                    <div class="sd-upload-controls">
                                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                            <i class="fas fa-folder-open"></i> Chọn ảnh
                                        </button>
                                        <button class="btn btn-warning ms-2" id="btnClearUpload" onclick="clearUploadedImage()" style="display: none;">
                                            <i class="fas fa-times"></i> Xóa
                                        </button>
                                    </div>
                                    <small class="sd-text-muted d-block mt-2 text-center">
                                        Chấp nhận: JPG, JPEG, PNG (Tối đa 10MB)
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="sd-attendance-info">
                                <!-- Status Display -->
                                <div id="attendanceStatus" class="sd-attendance-status mb-3">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <span class="ms-2">Đang kiểm tra trạng thái...</span>
                                </div>

                                <!-- Location Info -->
                                <div class="sd-location-box mb-3">
                                    <h6><i class="fas fa-map-marker-alt me-2"></i> Vị trí hiện tại</h6>
                                    <div id="locationInfo">
                                        <div class="alert alert-info">
                                            <i class="fas fa-spinner fa-spin"></i> Đang lấy vị trí GPS...
                                        </div>
                                    </div>
                                </div>

                                <!-- Notes -->
                                <div class="mb-3">
                                    <label class="sd-form-label">Ghi chú (tùy chọn)</label>
                                    <textarea id="attendanceNotes" class="sd-form-control" rows="2" placeholder="Thêm ghi chú nếu cần..."></textarea>
                                </div>

                                <!-- Check-in Button -->
                                <div id="checkInSection" style="display: none;">
                                    <button class="btn btn-success btn-lg w-100" onclick="checkIn()" id="btnCheckIn" disabled>
                                        <i class="fas fa-sign-in-alt"></i> Check In Ngay
                                    </button>
                                </div>

                                <!-- Check-out Section -->
                                <div id="checkOutSection" style="display: none;">
                                    <div class="sd-check-info mb-3"></div>
                                    <button class="btn btn-danger btn-lg w-100" onclick="checkOut()" id="btnCheckOut" disabled>
                                        <i class="fas fa-sign-out-alt"></i> Check Out Ngay
                                    </button>
                                </div>

                                <!-- Completed Section -->
                                <div id="completedSection" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CÔNG VIỆC CỦA TÔI -->
        <div class="col-lg-4">
            <div class="sd-card">
                <div class="sd-card-header">
                    <h5>
                        <i class="fas fa-tasks me-2"></i> Công việc của tôi
                    </h5>
                    <a href="/Staff/MyTasks" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-list me-1"></i> Xem tất cả
                    </a>
                </div>
                <div class="sd-card-body p-0">
                    <div id="myTasksToday" class="sd-task-container">
                        <div class="sd-loading text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 sd-text-muted">Đang tải công việc...</p>
                        </div>
                    </div>
                    <div id="taskLoadMore" style="display: none;" class="p-3 border-top bg-light">
                        <button class="btn btn-sm btn-outline-primary w-100" onclick="loadMoreTasks()">
                            <i class="fas fa-chevron-down me-1"></i> <span id="loadMoreText">Xem thêm</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QUICK ACTIONS -->
    <div class="row g-3 mt-2">
        <div class="col-md-4 col-6">
            <a href="/Staff/AttendanceHistory" class="sd-quick-action-card">
                <div class="sd-quick-action-icon">
                    <i class="fas fa-history"></i>
                </div>
                <div class="sd-quick-action-content">
                    <h6>Lịch sử chấm công</h6>
                    <p>Xem chi tiết chấm công</p>
                </div>
            </a>
        </div>
        <div class="col-md-4 col-6">
            <a href="/Staff/MyTasks" class="sd-quick-action-card">
                <div class="sd-quick-action-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <div class="sd-quick-action-content">
                    <h6>Quản lý công việc</h6>
                    <p>Cập nhật tiến độ task</p>
                </div>
            </a>
        </div>
        <div class="col-md-4 col-6">
            <a href="/Staff/Profile" class="sd-quick-action-card">
                <div class="sd-quick-action-icon">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="sd-quick-action-content">
                    <h6>Hồ sơ cá nhân</h6>
                    <p>Xem và chỉnh sửa</p>
                </div>
            </a>
        </div>
    </div>
</div>

<!-- ====== IMPROVED OVERTIME MODAL ====== -->
<div class="modal fade" id="overtimeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title">
                    <i class="fas fa-clock me-2"></i>Đề xuất tăng ca
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Lưu ý:</strong> Hệ thống sẽ tự động tính số giờ tăng ca dựa trên bản ghi chấm công của bạn.
                </div>
                <form id="overtimeForm">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-calendar-day me-1"></i>Ngày tăng ca *
                        </label>
                        <input type="date" class="form-control" id="overtimeWorkDate" required>
                        <small class="text-muted">Chọn ngày đã check-out có giờ tăng ca</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-comment-dots me-1"></i>Lý do *
                        </label>
                        <textarea class="form-control" id="overtimeReason" rows="3"
                                  placeholder="Ví dụ: Hoàn thành dự án X, xử lý công việc khẩn cấp..."
                                  required></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-tasks me-1"></i>Mô tả công việc (tùy chọn)
                        </label>
                        <textarea class="form-control" id="overtimeTaskDesc" rows="2"
                                  placeholder="Mô tả chi tiết công việc đã làm..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Đóng
                </button>
                <button type="button" class="btn btn-warning" onclick="submitOvertimeRequest()">
                    <i class="fas fa-paper-plane me-1"></i>Gửi đề xuất
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ====== IMPROVED LEAVE MODAL ====== -->
<div class="modal fade" id="leaveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-umbrella-beach me-2"></i>Đề xuất nghỉ phép
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Lưu ý:</strong> Số ngày sẽ được tự động tính dựa trên khoảng thời gian bạn chọn.
                </div>
                <form id="leaveForm">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-tag me-1"></i>Loại nghỉ *
                        </label>
                        <select class="form-select" id="leaveType" required>
                            <option value="">-- Chọn loại nghỉ --</option>
                            <option value="Nghỉ phép năm">Nghỉ phép năm</option>
                            <option value="Nghỉ ốm">Nghỉ ốm</option>
                            <option value="Nghỉ việc riêng">Nghỉ việc riêng</option>
                            <option value="Nghỉ không lương">Nghỉ không lương</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-calendar-check me-1"></i>Từ ngày *
                            </label>
                            <input type="date" class="form-control" id="leaveStartDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-calendar-times me-1"></i>Đến ngày *
                            </label>
                            <input type="date" class="form-control" id="leaveEndDate" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-comment-dots me-1"></i>Lý do *
                        </label>
                        <textarea class="form-control" id="leaveReason" rows="3"
                                  placeholder="Lý do nghỉ phép..."
                                  required></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-paperclip me-1"></i>Tài liệu đính kèm (URL)
                        </label>
                        <input type="url" class="form-control" id="leaveProof"
                               placeholder="https://drive.google.com/...">
                        <small class="text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            Nếu có giấy khám/chứng từ, upload lên Drive và dán link tại đây
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Đóng
                </button>
                <button type="button" class="btn btn-info" onclick="submitLeaveRequest()">
                    <i class="fas fa-paper-plane me-1"></i>Gửi đề xuất
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ====== IMPROVED LATE MODAL ====== -->
<div class="modal fade" id="lateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-clock me-2"></i>Đề xuất đi trễ
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Lưu ý:</strong> Nên gửi đề xuất trước khi đến công ty để quản lý biết và sắp xếp công việc.
                </div>
                <form id="lateForm">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-calendar-day me-1"></i>Ngày *
                        </label>
                        <input type="date" class="form-control" id="lateRequestDate" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-clock me-1"></i>Dự kiến đến lúc *
                        </label>
                        <input type="time" class="form-control" id="lateExpectedTime" required>
                        <small class="text-muted">Chọn giờ:phút dự kiến bạn sẽ đến</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-comment-dots me-1"></i>Lý do *
                        </label>
                        <textarea class="form-control" id="lateReason" rows="3"
                                  placeholder="Ví dụ: Tắc đường, việc gia đình khẩn cấp..."
                                  required></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-paperclip me-1"></i>Tài liệu đính kèm (URL)
                        </label>
                        <input type="url" class="form-control" id="lateProof"
                               placeholder="https://...">
                        <small class="text-muted">Tùy chọn: Link ảnh/file minh chứng</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Đóng
                </button>
                <button type="button" class="btn btn-danger" onclick="submitLateRequest()">
                    <i class="fas fa-paper-plane me-1"></i>Gửi đề xuất
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ========== GLOBAL VARIABLES ==========
        let stream = null;
        let capturedBlob = null;
        let uploadedFile = null;
        let latitude = null;
        let longitude = null;
        let currentAddress = '';
        let isGettingLocation = false;
        let isLocationLocked = false; // <<< ĐÂY LÀ CỜ GIÚP GPS KHÔNG BỊ MẤT
        let checkInTimeValue = null;

        // Lấy giờ chuẩn từ Server (ViewBag) - Đảm bảo đã cập nhật StaffController.cs
        const STANDARD_START_TIME = "@ViewBag.StandardStartTime";
        const STANDARD_END_TIME = "@ViewBag.StandardEndTime";

        // ========== TIME UPDATE ==========
        function updateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('vi-VN', options);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('vi-VN');
        }
        setInterval(updateTime, 1000);
        updateTime();

        // ========== PHOTO MODE SWITCH ==========
        document.querySelectorAll('input[name="photoMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'camera') {
                    document.getElementById('cameraMode').style.display = 'block';
                    document.getElementById('uploadMode').style.display = 'none';
                    uploadedFile = null;
                    clearUploadedImage();
                    initCamera();
                } else {
                    document.getElementById('cameraMode').style.display = 'none';
                    document.getElementById('uploadMode').style.display = 'block';
                    retakePhoto();
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        stream = null;
                    }
                }
                updateButtonsState();
            });
        });

        // ========== CAMERA INIT & CAPTURE ==========
        async function initCamera() {
            if (stream) return;
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                document.getElementById('video').srcObject = stream;
            } catch (err) {
                console.error('Camera error:', err);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi Camera',
                    text: 'Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập hoặc chuyển sang chế độ tải ảnh.',
                    confirmButtonText: 'Chuyển sang tải ảnh'
                }).then(() => {
                    document.getElementById('modeUpload').checked = true;
                    document.getElementById('modeUpload').dispatchEvent(new Event('change'));
                });
            }
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const capturedImage = document.getElementById('capturedImage');

            const MAX_WIDTH = 1024;
            let width = video.videoWidth;
            let height = video.videoHeight;

            if (width > MAX_WIDTH) {
                height = height * (MAX_WIDTH / width);
                width = MAX_WIDTH;
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, width, height);

            canvas.toBlob(blob => {
                capturedBlob = blob;
                capturedImage.src = URL.createObjectURL(blob);
                capturedImage.style.display = 'block';
                video.style.display = 'none';
                document.getElementById('btnCapture').style.display = 'none';
                document.getElementById('btnRetake').style.display = 'inline-block';
                updateButtonsState();
            }, 'image/jpeg', 0.8);
        }

        function retakePhoto() {
            document.getElementById('video').style.display = 'block';
            document.getElementById('capturedImage').style.display = 'none';
            document.getElementById('btnCapture').style.display = 'inline-block';
            document.getElementById('btnRetake').style.display = 'none';
            capturedBlob = null;
            updateButtonsState();
            initCamera();
        }

        // ========== LOCATION LOGIC (FIX GPS STABILITY) ==========
        async function getLocation(isRetry = false) {
            // Chỉ chạy khi chưa có vị trí (hoặc bị lỗi) HOẶC khi người dùng bấm nút làm mới
            if (isLocationLocked && !isRetry) return;
            if (isGettingLocation) return;

            if (!navigator.geolocation) {
                showLocationError('Trình duyệt không hỗ trợ GPS');
                return;
            }

            isGettingLocation = true;

            document.getElementById('locationInfo').innerHTML = `
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        <div><strong>Đang lấy vị trí GPS...</strong></div>
                    </div>
                </div>
            `;

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    });
                });

                latitude = position.coords.latitude;
                longitude = position.coords.longitude;
                const accuracy = position.coords.accuracy;

                await getAddressFromServer(latitude, longitude, accuracy);

                isGettingLocation = false;
                isLocationLocked = true; // KHÓA VỊ TRÍ: Giúp vị trí không bị mất

            } catch (error) {
                console.error('Location error:', error);
                isGettingLocation = false;
                isLocationLocked = false;

                let msg = 'Không thể lấy vị trí.';
                if (error.code === 1) msg = 'Vui lòng cho phép truy cập vị trí.';
                else if (error.code === 3) msg = 'Hết thời gian chờ lấy vị trí.';

                showLocationError(msg, true);
            }
        }

        function showLocationError(msg, showRetry = false) {
            document.getElementById('locationInfo').innerHTML = `
                <div class="alert alert-warning">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <i class="fas fa-exclamation-triangle"></i> ${msg}
                        </div>
                        ${showRetry ? `<button class="btn btn-sm btn-outline-warning" onclick="getLocation(true)" title="Thử lại vị trí"><i class="fas fa-sync-alt"></i></button>` : ''}
                    </div>
                </div>
            `;
            latitude = null;
            longitude = null;
            updateButtonsState();
        }

        async function getAddressFromServer(lat, lng, accuracy) {
            try {
                const response = await fetch(`/Staff/GetAddressFromCoordinatesApi?latitude=${lat}&longitude=${lng}`);
                const data = await response.json();
                currentAddress = (data.success && data.address) ? data.address : `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            } catch (err) {
                currentAddress = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
            displayLocationSuccess(accuracy);
        }

        function displayLocationSuccess(accuracy) {
            document.getElementById('locationInfo').innerHTML = `
                <div class="alert alert-success">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong><i class="fas fa-check-circle"></i> Đã lấy vị trí</strong>
                            <p class="mb-0 mt-1 small"><i class="fas fa-map-marker-alt text-danger"></i> ${currentAddress}</p>
                            <small class="text-muted">Độ chính xác: ±${Math.round(accuracy)}m</small>
                        </div>
                        <button class="btn btn-sm btn-light text-primary" onclick="getLocation(true)" title="Làm mới vị trí">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            `;
            updateButtonsState();
        }

        // ... (Giữ nguyên các hàm File Upload và updateButtonsState) ...
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                uploadedFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('uploadPlaceholder').style.display = 'none';
                    document.getElementById('uploadedImage').src = e.target.result;
                    document.getElementById('uploadedImage').style.display = 'block';
                    document.getElementById('btnClearUpload').style.display = 'inline-block';
                    updateButtonsState();
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('uploadPlaceholder').addEventListener('click', () => document.getElementById('fileInput').click());

        function clearUploadedImage() {
            uploadedFile = null;
            document.getElementById('uploadedImage').style.display = 'none';
            document.getElementById('uploadPlaceholder').style.display = 'flex';
            document.getElementById('btnClearUpload').style.display = 'none';
            document.getElementById('fileInput').value = '';
            updateButtonsState();
        }

        function updateButtonsState() {
            const hasPhoto = capturedBlob !== null || uploadedFile !== null;
            const hasLocation = latitude !== null && longitude !== null;

            const btnCheckIn = document.getElementById('btnCheckIn');
            const btnCheckOut = document.getElementById('btnCheckOut');

            if (btnCheckIn) btnCheckIn.disabled = !(hasPhoto && hasLocation);
            if (btnCheckOut) btnCheckOut.disabled = !(hasPhoto && hasLocation);
        }

        function getCurrentTimeStr() {
            const now = new Date();
            return now.toTimeString().split(' ')[0].substring(0, 5); // HH:mm
        }

        // ========== CHECK IN POPUP & API CALL LOGIC (ĐÃ SỬA) ==========
        async function checkIn() {
            const photoFile = capturedBlob || uploadedFile;
            if (!photoFile || !latitude || !longitude) {
                Swal.fire('Thiếu thông tin', 'Vui lòng chụp ảnh và đợi lấy vị trí GPS', 'warning');
                return;
            }

            const nowStr = getCurrentTimeStr();
            let statusHtml = '';
            if (nowStr > STANDARD_START_TIME) {
                statusHtml = `<span class="badge bg-danger fs-6">Đi trễ</span> <small class="text-muted">(Chuẩn: ${STANDARD_START_TIME})</small>`;
            } else {
                statusHtml = `<span class="badge bg-success fs-6">Đúng giờ</span>`;
            }

            // POPUP XÁC NHẬN CHECK-IN
            const result = await Swal.fire({
                title: 'Xác nhận Check-in',
                html: `
                    <div class="text-start p-3 bg-light rounded">
                        <p class="mb-2"><i class="fas fa-clock text-primary me-2"></i><strong>Thời gian:</strong> ${nowStr}</p>
                        <p class="mb-2"><i class="fas fa-info-circle text-info me-2"></i><strong>Trạng thái:</strong> ${statusHtml}</p>
                        <p class="mb-0"><i class="fas fa-map-marker-alt text-danger me-2"></i><strong>Vị trí:</strong><br>${currentAddress}</p>
                    </div>
                    <div class="mt-3 text-center">
                        <img src="${photoFile === capturedBlob ? URL.createObjectURL(capturedBlob) : document.getElementById('uploadedImage').src}"
                             style="max-height: 150px; border-radius: 8px; border: 1px solid #ddd;">
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-check"></i> Xác nhận Check-in',
                cancelButtonText: 'Hủy bỏ',
                confirmButtonColor: '#198754',
                cancelButtonColor: '#6c757d',
                reverseButtons: true
            });

            // <<< ĐÂY LÀ LOGIC BẮT BUỘC XÁC NHẬN
            if (!result.isConfirmed) return;

            // Gửi dữ liệu (CHỈ CHẠY KHI ĐÃ XÁC NHẬN)
            const formData = new FormData();
            formData.append('Photo', photoFile, 'checkin.jpg');
            formData.append('Latitude', latitude);
            formData.append('Longitude', longitude);
            formData.append('Address', currentAddress);
            formData.append('Notes', document.getElementById('attendanceNotes').value);

            Swal.fire({ title: 'Đang Check-in...', text: 'Vui lòng đợi giây lát', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            try {
                const response = await fetch('/Staff/CheckIn', { method: 'POST', body: formData });
                const data = await response.json();
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Check-in thành công!',
                        html: data.message.replace(/\n/g, '<br>'),
                        confirmButtonText: 'Tuyệt vời'
                    }).then(() => location.reload());
                } else {
                    Swal.fire('Lỗi', data.message, 'error');
                }
            } catch (err) {
                Swal.fire('Lỗi kết nối', err.message, 'error');
            }
        }

        // ========== CHECK OUT POPUP & API CALL LOGIC (ĐÃ SỬA) ==========
        async function checkOut() {
            const photoFile = capturedBlob || uploadedFile;
            if (!photoFile || !latitude || !longitude) {
                Swal.fire('Thiếu thông tin', 'Vui lòng chụp ảnh và đợi lấy vị trí GPS', 'warning');
                return;
            }

            const nowStr = getCurrentTimeStr();
            let statusHtml = '';
            if (nowStr < STANDARD_END_TIME) {
                statusHtml = `<span class="badge bg-warning text-dark fs-6">Về sớm</span> <small class="text-muted">(Chuẩn: ${STANDARD_END_TIME})</small>`;
            } else {
                statusHtml = `<span class="badge bg-success fs-6">Đúng giờ</span>`;
            }

            // POPUP XÁC NHẬN CHECK-OUT
            const result = await Swal.fire({
                title: 'Xác nhận Check-out',
                html: `
                    <div class="text-start p-3 bg-light rounded">
                        <p class="mb-2"><i class="fas fa-clock text-primary me-2"></i><strong>Thời gian:</strong> ${nowStr}</p>
                        <p class="mb-2"><i class="fas fa-info-circle text-info me-2"></i><strong>Trạng thái:</strong> ${statusHtml}</p>
                        <p class="mb-0"><i class="fas fa-map-marker-alt text-danger me-2"></i><strong>Vị trí:</strong><br>${currentAddress}</p>
                    </div>
                    <div class="mt-3 text-center">
                        <img src="${photoFile === capturedBlob ? URL.createObjectURL(capturedBlob) : document.getElementById('uploadedImage').src}"
                             style="max-height: 150px; border-radius: 8px; border: 1px solid #ddd;">
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-sign-out-alt"></i> Xác nhận Check-out',
                cancelButtonText: 'Hủy bỏ',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                reverseButtons: true
            });

            // <<< ĐÂY LÀ LOGIC BẮT BUỘC XÁC NHẬN
            if (!result.isConfirmed) return;

            const formData = new FormData();
            formData.append('Photo', photoFile, 'checkout.jpg');
            formData.append('Latitude', latitude);
            formData.append('Longitude', longitude);
            formData.append('Address', currentAddress);
            formData.append('Notes', document.getElementById('attendanceNotes').value);

            Swal.fire({ title: 'Đang Check-out...', text: 'Đang tổng hợp công...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            try {
                const response = await fetch('/Staff/CheckOut', { method: 'POST', body: formData });
                const data = await response.json();
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Check-out thành công!',
                        html: data.message.replace(/\n/g, '<br>'),
                        confirmButtonText: 'Hẹn gặp lại'
                    }).then(() => location.reload());
                } else {
                    Swal.fire('Lỗi', data.message, 'error');
                }
            } catch (err) {
                Swal.fire('Lỗi kết nối', err.message, 'error');
            }
        }

        // ========== ATTENDANCE STATUS AND WORKING HOURS ==========
        async function checkAttendanceStatus() {
             try {
                const response = await fetch('/Staff/GetTodayAttendance');
                const data = await response.json();

                const statusDiv = document.getElementById('attendanceStatus');
                const checkInSection = document.getElementById('checkInSection');
                const checkOutSection = document.getElementById('checkOutSection');
                const completedSection = document.getElementById('completedSection');

                if (data.hasCheckedIn) {
                    statusDiv.style.display = 'none';
                    if (data.hasCheckedOut) {
                        checkInSection.style.display = 'none';
                        checkOutSection.style.display = 'none';
                        completedSection.style.display = 'block';
                        completedSection.innerHTML = `
                            <div class="alert alert-success">
                                <h5><i class="fas fa-check-double"></i> Đã hoàn tất!</h5>
                                <hr>
                                <div class="row text-center">
                                    <div class="col-6">
                                        <small>Check-in</small>
                                        <br><strong>${data.checkInTime}</strong>
                                    </div>
                                    <div class="col-6">
                                        <small>Check-out</small>
                                        <br><strong>${data.checkOutTime}</strong>
                                    </div>
                                </div>
                            </div>
                        `;
                        if (stream) {
                            stream.getTracks().forEach(track => track.stop());
                            stream = null;
                        }
                    } else {
                        checkInSection.style.display = 'none';
                        checkOutSection.style.display = 'block';
                        checkInTimeValue = data.checkInTime;
                        updateWorkingHours();
                    }
                } else {
                    statusDiv.style.display = 'none';
                    checkInSection.style.display = 'block';
                }
                updateButtonsState();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function updateWorkingHours() {
            if (!checkInTimeValue) return;
            const updateHours = () => {
                const now = new Date();
                const checkIn = new Date(`${now.toDateString()} ${checkInTimeValue}`);
                const diff = now - checkIn;
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                const el = document.querySelector('.sd-check-info');
                if (el) {
                    el.innerHTML = `
                        <div class="alert alert-info">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-sign-in-alt me-2"></i>
                                    <strong>Đã check-in:</strong> <code>${checkInTimeValue}</code>
                                </div>
                                <div class="badge bg-primary fs-6">
                                    <i class="fas fa-clock me-1"></i>
                                    ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}
                                </div>
                            </div>
                        </div>
                    `;
                }
            };
            updateHours();
            setInterval(updateHours, 1000);
        }

        // ... (Bạn nên copy các hàm liên quan đến task: loadMyTasks, renderTasks, updateTaskStatus, v.v. từ file Dashboard.cshtml cũ của bạn vào đây) ...

        // ========== INIT ON LOAD ==========
        window.onload = async function() {
            console.log('🚀 Initializing Staff Dashboard...');
            await initCamera();
            await getLocation();
            await checkAttendanceStatus();
            // if (typeof loadMyTasks === "function") await loadMyTasks();
            console.log('✅ Dashboard initialized');
        };

        // ========== CLEANUP ==========
        window.onbeforeunload = function() {
            if (stream) stream.getTracks().forEach(track => track.stop());
        };
    </script>
}