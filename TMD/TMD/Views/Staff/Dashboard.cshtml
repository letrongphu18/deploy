@{
    ViewData["Title"] = "Staff Dashboard";
    Layout = "~/Views/Shared/_LayoutStaff.cshtml";
    var user = ViewBag.User as TMD.Models.User;
}

<link href="~/css/staff-dashboard.css" rel="stylesheet" />

<div class="sd-container">
    <!-- WELCOME HEADER -->
    <div class="sd-page-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="sd-welcome-content">
                    <h2 class="sd-page-title">
                        <i class="fas fa-hand-sparkles me-2"></i>
                        Chào mừng trở lại, <strong>@user.FullName</strong>!
                    </h2>
                    <p class="sd-page-subtitle">
                        <i class="fas fa-briefcase"></i> @user.Role?.RoleName
                        @if (user.Department != null)
                        {
                            <span class="mx-2">•</span>
                            <i class="fas fa-building"></i> @user.Department.DepartmentName
                        }
                    </p>
                </div>
            </div>
            <div class="col-md-4 d-flex justify-content-end align-items-center">
                <div class="sd-current-time me-3">
                    <div id="currentDate" class="sd-date-display"></div>
                    <div id="currentTime" class="sd-time-display"></div>
                    <small class="sd-text-muted">Thời gian server</small>
                </div>
            </div>
        </div>
    </div>

    <!-- STATISTICS -->
    <div class="row g-3 mb-4">
        <div class="col-md-3 col-6">
            <div class="sd-stats-card sd-stats-primary">
                <div class="sd-stats-icon"><i class="fas fa-calendar-check"></i></div>
                <div class="sd-stats-content">
                    <div class="sd-stats-label">Ngày chấm công</div>
                    <div class="sd-stats-value">@(ViewBag.AttendanceThisMonth ?? 0)</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="sd-stats-card sd-stats-success">
                <div class="sd-stats-icon"><i class="fas fa-clock"></i></div>
                <div class="sd-stats-content">
                    <div class="sd-stats-label">Tổng giờ làm</div>
                    <div class="sd-stats-value">@(ViewBag.TotalHoursThisMonth?.ToString("F0") ?? "0")h</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="sd-stats-card sd-stats-warning">
                <div class="sd-stats-icon"><i class="fas fa-sign-in-alt"></i></div>
                <div class="sd-stats-content">
                    <div class="sd-stats-label">Lần đăng nhập</div>
                    <div class="sd-stats-value">@ViewBag.ThisMonthLogins</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="sd-stats-card sd-stats-info">
                <div class="sd-stats-icon"><i class="fas fa-users"></i></div>
                <div class="sd-stats-content">
                    <div class="sd-stats-label">Thành viên</div>
                    <div class="sd-stats-value">@(ViewBag.DepartmentUserCount ?? 0)</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- CHECK-IN/OUT SECTION -->
        <div class="col-lg-8">
            <div class="sd-card">
                <div class="sd-card-header">
                    <h5><i class="fas fa-user-clock me-2"></i> Chấm công hôm nay</h5>
                </div>
                <div class="sd-card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <!-- Photo Options -->
                            <div class="sd-photo-options mb-3">
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="photoMode" id="modeCamera" value="camera" checked>
                                    <label class="btn btn-outline-primary" for="modeCamera">
                                        <i class="fas fa-camera"></i> Chụp ảnh
                                    </label>
                                    <input type="radio" class="btn-check" name="photoMode" id="modeUpload" value="upload">
                                    <label class="btn btn-outline-primary" for="modeUpload">
                                        <i class="fas fa-upload"></i> Tải ảnh lên
                                    </label>
                                </div>
                            </div>

                            <!-- Camera Mode -->
                            <div id="cameraMode" class="photo-mode">
                                <div class="sd-camera-container">
                                    <div class="sd-camera-preview" id="cameraPreview">
                                        <video id="video" autoplay playsinline></video>
                                        <canvas id="canvas" style="display: none;"></canvas>
                                        <img id="capturedImage" style="display: none;" />
                                        <div class="sd-camera-overlay"></div>
                                    </div>
                                    <div class="sd-camera-controls">
                                        <button class="sd-btn-camera" id="btnCapture" onclick="capturePhoto()">
                                            <i class="fas fa-camera"></i>
                                        </button>
                                        <button class="sd-btn-camera sd-btn-warning" id="btnRetake" onclick="retakePhoto()" style="display: none;">
                                            <i class="fas fa-redo"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Upload Mode -->
                            <div id="uploadMode" class="photo-mode" style="display: none;">
                                <div class="sd-upload-container">
                                    <div class="sd-upload-preview" id="uploadPreview">
                                        <div class="sd-upload-placeholder" id="uploadPlaceholder">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <p>Kéo thả ảnh vào đây hoặc nhấn để chọn</p>
                                            <input type="file" id="fileInput" accept="image/jpeg,image/jpg,image/png" style="display: none;">
                                        </div>
                                        <img id="uploadedImage" style="display: none;" />
                                    </div>
                                    <div class="sd-upload-controls">
                                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                            <i class="fas fa-folder-open"></i> Chọn ảnh
                                        </button>
                                        <button class="btn btn-warning ms-2" id="btnClearUpload" onclick="clearUploadedImage()" style="display: none;">
                                            <i class="fas fa-times"></i> Xóa
                                        </button>
                                    </div>
                                    <small class="sd-text-muted d-block mt-2 text-center">
                                        Chấp nhận: JPG, JPEG, PNG (Tối đa 10MB)
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="sd-attendance-info">
                                <!-- Status Display -->
                                <div id="attendanceStatus" class="sd-attendance-status mb-3">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <span class="ms-2">Đang kiểm tra trạng thái...</span>
                                </div>

                                <!-- Location Info -->
                                <div class="sd-location-box mb-3">
                                    <h6><i class="fas fa-map-marker-alt me-2"></i> Vị trí hiện tại</h6>
                                    <div id="locationInfo">
                                        <div class="alert alert-info">
                                            <i class="fas fa-spinner fa-spin"></i> Đang lấy vị trí GPS...
                                        </div>
                                    </div>
                                </div>

                                <!-- Notes -->
                                <div class="mb-3">
                                    <label class="sd-form-label">Ghi chú (tùy chọn)</label>
                                    <textarea id="attendanceNotes" class="sd-form-control" rows="2" placeholder="Thêm ghi chú nếu cần..."></textarea>
                                </div>

                                <!-- Check-in Button -->
                                <div id="checkInSection" style="display: none;">
                                    <button class="btn btn-success btn-lg w-100" onclick="checkIn()" id="btnCheckIn" disabled>
                                        <i class="fas fa-sign-in-alt"></i> Check In Ngay
                                    </button>
                                </div>

                                <!-- Check-out Section -->
                                <div id="checkOutSection" style="display: none;">
                                    <div class="sd-check-info mb-3"></div>
                                    <button class="btn btn-danger btn-lg w-100" onclick="checkOut()" id="btnCheckOut" disabled>
                                        <i class="fas fa-sign-out-alt"></i> Check Out Ngay
                                    </button>
                                </div>

                                <!-- Completed Section -->
                                <div id="completedSection" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CÔNG VIỆC CỦA TÔI -->
        <div class="col-lg-4">
            <div class="sd-card">
                <div class="sd-card-header">
                    <h5><i class="fas fa-tasks me-2"></i> Công việc của tôi</h5>
                    <a href="/Staff/MyTasks" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-list me-1"></i> Xem tất cả
                    </a>
                </div>
                <div class="sd-card-body p-0">
                    <div id="myTasksToday" class="sd-task-container">
                        <div class="sd-loading text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 sd-text-muted">Đang tải công việc...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QUICK ACTIONS -->
    <div class="row g-3 mt-2">
        <div class="col-md-4 col-6">
            <a href="/Staff/AttendanceHistory" class="sd-quick-action-card">
                <div class="sd-quick-action-icon"><i class="fas fa-history"></i></div>
                <div class="sd-quick-action-content">
                    <h6>Lịch sử chấm công</h6>
                    <p>Xem chi tiết chấm công</p>
                </div>
            </a>
        </div>
        <div class="col-md-4 col-6">
            <a href="/Staff/MyTasks" class="sd-quick-action-card">
                <div class="sd-quick-action-icon"><i class="fas fa-clipboard-list"></i></div>
                <div class="sd-quick-action-content">
                    <h6>Quản lý công việc</h6>
                    <p>Cập nhật tiến độ task</p>
                </div>
            </a>
        </div>
        <div class="col-md-4 col-6">
            <a href="/Staff/Profile" class="sd-quick-action-card">
                <div class="sd-quick-action-icon"><i class="fas fa-user-circle"></i></div>
                <div class="sd-quick-action-content">
                    <h6>Hồ sơ cá nhân</h6>
                    <p>Xem và chỉnh sửa</p>
                </div>
            </a>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ========== GLOBAL VARIABLES ==========
        let stream = null;
        let capturedBlob = null;
        let uploadedFile = null;
        let latitude = null;
        let longitude = null;
        let currentAddress = '';
        let isGettingLocation = false;
        let isLocationLocked = false;
        let checkInTimeValue = null;
        let cameraErrorShown = false;
        const STANDARD_START_TIME = "@ViewBag.StandardStartTime";
        const STANDARD_END_TIME = "@ViewBag.StandardEndTime";

        // ========== TIME UPDATE ==========
        function updateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('vi-VN', options);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('vi-VN');
        }
        setInterval(updateTime, 1000);
        updateTime();

        // ========== PHOTO MODE SWITCH ==========
        document.querySelectorAll('input[name="photoMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'camera') {
                    document.getElementById('cameraMode').style.display = 'block';
                    document.getElementById('uploadMode').style.display = 'none';
                    uploadedFile = null;
                    clearUploadedImage();
                    initCamera();
                } else {
                    document.getElementById('cameraMode').style.display = 'none';
                    document.getElementById('uploadMode').style.display = 'block';
                    retakePhoto();
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        stream = null;
                    }
                }
                updateButtonsState();
            });
        });

        // ========== CAMERA INIT & CAPTURE ==========
        // async function initCamera() {
        //     if (stream) return;
        //     try {
        //         stream = await navigator.mediaDevices.getUserMedia({
        //             video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
        //         });
        //         document.getElementById('video').srcObject = stream;
        //     } catch (err) {
        //         console.error('Camera error:', err);
        //         Swal.fire({
        //             icon: 'error',
        //             title: 'Lỗi Camera',
        //             text: 'Không thể truy cập camera. Chuyển sang chế độ tải ảnh.',
        //             confirmButtonText: 'OK'
        //         }).then(() => {
        //             document.getElementById('modeUpload').checked = true;
        //             document.getElementById('modeUpload').dispatchEvent(new Event('change'));
        //         });
        //     }
        // }
                async function initCamera() {
            if (stream) return;

            // ✅ NẾU ĐÃ LỖI CAMERA RỒI THÌ KHÔNG THỬ LẠI NỮA
            if (cameraErrorShown) {
                return;
            }

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                document.getElementById('video').srcObject = stream;
            } catch (err) {
                console.error('Camera error:', err);

                // ✅ CHỈ HIỆN POPUP 1 LẦN DUY NHẤT
                if (!cameraErrorShown) {
                    cameraErrorShown = true;

                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi Camera',
                        text: 'Không thể truy cập camera. Tự động chuyển sang chế độ tải ảnh.',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        document.getElementById('modeUpload').checked = true;
                        document.getElementById('modeUpload').dispatchEvent(new Event('change'));
                    });
                }
            }
        }
        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const capturedImage = document.getElementById('capturedImage');

            const MAX_WIDTH = 1024;
            let width = video.videoWidth;
            let height = video.videoHeight;

            if (width > MAX_WIDTH) {
                height = height * (MAX_WIDTH / width);
                width = MAX_WIDTH;
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, width, height);

            canvas.toBlob(blob => {
                capturedBlob = blob;
                capturedImage.src = URL.createObjectURL(blob);
                capturedImage.style.display = 'block';
                video.style.display = 'none';
                document.getElementById('btnCapture').style.display = 'none';
                document.getElementById('btnRetake').style.display = 'inline-block';
                updateButtonsState();
            }, 'image/jpeg', 0.8);
        }

                function retakePhoto() {
            document.getElementById('video').style.display = 'block';
            document.getElementById('capturedImage').style.display = 'none';
            document.getElementById('btnCapture').style.display = 'inline-block';
            document.getElementById('btnRetake').style.display = 'none';
            capturedBlob = null;
            updateButtonsState();

            // ✅ CHỈ INIT CAMERA LẠI NẾU CHƯA CÓ LỖI
            if (!cameraErrorShown) {
                initCamera();
            }
        }

        // ========== LOCATION LOGIC (GPS BẮTBUỘC) ==========
        async function getLocation(isRetry = false) {
            if (isLocationLocked && !isRetry) return;
            if (isGettingLocation) return;

            if (!navigator.geolocation) {
                showLocationError('Trình duyệt không hỗ trợ GPS');
                return;
            }

            isGettingLocation = true;

            document.getElementById('locationInfo').innerHTML = `
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        <div><strong>Đang lấy vị trí GPS...</strong></div>
                    </div>
                </div>
            `;

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    });
                });

                latitude = position.coords.latitude;
                longitude = position.coords.longitude;
                const accuracy = position.coords.accuracy;

                await getAddressFromServer(latitude, longitude, accuracy);

                isGettingLocation = false;
                isLocationLocked = true;

            } catch (error) {
                console.error('Location error:', error);
                isGettingLocation = false;
                isLocationLocked = false;

                let msg = 'Không thể lấy vị trí.';
                if (error.code === 1) msg = 'Vui lòng cho phép truy cập vị trí.';
                else if (error.code === 3) msg = 'Hết thời gian chờ lấy vị trí.';

                showLocationError(msg, true);
            }
        }

        function showLocationError(msg, showRetry = false) {
            document.getElementById('locationInfo').innerHTML = `
                <div class="alert alert-warning">
                    <div class="d-flex justify-content-between align-items-start">
                        <div><i class="fas fa-exclamation-triangle"></i> ${msg}</div>
                        ${showRetry ? `<button class="btn btn-sm btn-outline-warning" onclick="getLocation(true)"><i class="fas fa-sync-alt"></i></button>` : ''}
                    </div>
                </div>
            `;
            latitude = null;
            longitude = null;
            updateButtonsState();
        }

        async function getAddressFromServer(lat, lng, accuracy) {
            try {
                const response = await fetch(`/Staff/GetAddressFromCoordinatesApi?latitude=${lat}&longitude=${lng}`);
                const data = await response.json();
                currentAddress = (data.success && data.address) ? data.address : `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            } catch (err) {
                currentAddress = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
            displayLocationSuccess(accuracy);
        }

        function displayLocationSuccess(accuracy) {
            document.getElementById('locationInfo').innerHTML = `
                <div class="alert alert-success">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong><i class="fas fa-check-circle"></i> Đã lấy vị trí</strong>
                            <p class="mb-0 mt-1 small"><i class="fas fa-map-marker-alt text-danger"></i> ${currentAddress}</p>
                            <small class="text-muted">Độ chính xác: ±${Math.round(accuracy)}m</small>
                        </div>
                        <button class="btn btn-sm btn-light text-primary" onclick="getLocation(true)"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
            `;
            updateButtonsState();
        }

        // ========== FILE UPLOAD ==========
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                uploadedFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('uploadPlaceholder').style.display = 'none';
                    document.getElementById('uploadedImage').src = e.target.result;
                    document.getElementById('uploadedImage').style.display = 'block';
                    document.getElementById('btnClearUpload').style.display = 'inline-block';
                    updateButtonsState();
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('uploadPlaceholder').addEventListener('click', () => document.getElementById('fileInput').click());

        function clearUploadedImage() {
            uploadedFile = null;
            document.getElementById('uploadedImage').style.display = 'none';
            document.getElementById('uploadPlaceholder').style.display = 'flex';
            document.getElementById('btnClearUpload').style.display = 'none';
            document.getElementById('fileInput').value = '';
            updateButtonsState();
        }

        function updateButtonsState() {
            // ✅ Ảnh tùy chọn - không cần kiểm tra
            const hasLocation = latitude !== null && longitude !== null;

            const btnCheckIn = document.getElementById('btnCheckIn');
            const btnCheckOut = document.getElementById('btnCheckOut');

            if (btnCheckIn) btnCheckIn.disabled = !hasLocation;
            if (btnCheckOut) btnCheckOut.disabled = !hasLocation;
        }

        function getCurrentTimeStr() {
            const now = new Date();
            return now.toTimeString().split(' ')[0].substring(0, 5);
        }

        // ========== CHECK IN POPUP & API CALL ==========
               async function checkIn() {
            if (!latitude || !longitude) {
                Swal.fire('Thiếu thông tin', 'Vui lòng đợi lấy vị trí GPS', 'warning');
                return;
            }

            const photoFile = capturedBlob || uploadedFile;
            const nowStr = getCurrentTimeStr();
            let statusHtml = '';
            if (nowStr > STANDARD_START_TIME) {
                statusHtml = `<span class="badge bg-danger fs-6">Đi trễ</span> <small class="text-muted">(Chuẩn: ${STANDARD_START_TIME})</small>`;
            } else {
                statusHtml = `<span class="badge bg-success fs-6">Đúng giờ</span>`;
            }

            const result = await Swal.fire({
                title: 'Xác nhận Check-in',
                html: `
                    <div class="text-start p-3 bg-light rounded">
                        <p class="mb-2"><i class="fas fa-clock text-primary me-2"></i><strong>Thời gian:</strong> ${nowStr}</p>
                        <p class="mb-2"><i class="fas fa-info-circle text-info me-2"></i><strong>Trạng thái:</strong> ${statusHtml}</p>
                        <p class="mb-0"><i class="fas fa-map-marker-alt text-danger me-2"></i><strong>Vị trí:</strong><br>${currentAddress}</p>
                    </div>
                    ${photoFile ? `<div class="mt-3 text-center">
                        <img src="${photoFile === capturedBlob ? URL.createObjectURL(capturedBlob) : document.getElementById('uploadedImage').src}"
                             style="max-height: 150px; border-radius: 8px; border: 1px solid #ddd;">
                    </div>` : '<p class="text-muted mt-3">Không có ảnh check-in</p>'}
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-check"></i> Xác nhận Check-in',
                cancelButtonText: 'Hủy bỏ',
                confirmButtonColor: '#198754',
                cancelButtonColor: '#6c757d',
                reverseButtons: true
            });

            if (!result.isConfirmed) return;

            // ✅ FIXED: Không gửi Address nữa
            const formData = new FormData();
            if (photoFile) formData.append('Photo', photoFile, 'checkin.jpg');
            formData.append('Latitude', latitude);
            formData.append('Longitude', longitude);
            // ❌ ĐÃ XÓA: formData.append('Address', currentAddress);
            formData.append('Notes', document.getElementById('attendanceNotes').value);

            Swal.fire({ title: 'Đang Check-in...', text: 'Vui lòng đợi', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            try {
                const response = await fetch('/Staff/CheckIn', { method: 'POST', body: formData });
                const data = await response.json();
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Check-in thành công!',
                        html: data.message.replace(/\n/g, '<br>'),
                        confirmButtonText: 'OK'
                    }).then(() => location.reload());
                } else {
                    Swal.fire('Lỗi', data.message, 'error');
                }
            } catch (err) {
                Swal.fire('Lỗi kết nối', err.message, 'error');
            }
        }


        // ========== CHECK OUT POPUP & API CALL ==========
               async function checkOut() {
            if (!latitude || !longitude) {
                Swal.fire('Thiếu thông tin', 'Vui lòng đợi lấy vị trí GPS', 'warning');
                return;
            }

            const photoFile = capturedBlob || uploadedFile;
            const nowStr = getCurrentTimeStr();
            let statusHtml = '';
            if (nowStr < STANDARD_END_TIME) {
                statusHtml = `<span class="badge bg-warning text-dark fs-6">Về sớm</span> <small class="text-muted">(Chuẩn: ${STANDARD_END_TIME})</small>`;
            } else {
                statusHtml = `<span class="badge bg-success fs-6">Đúng giờ</span>`;
            }

            const result = await Swal.fire({
                title: 'Xác nhận Check-out',
                html: `
                    <div class="text-start p-3 bg-light rounded">
                        <p class="mb-2"><i class="fas fa-clock text-primary me-2"></i><strong>Thời gian:</strong> ${nowStr}</p>
                        <p class="mb-2"><i class="fas fa-info-circle text-info me-2"></i><strong>Trạng thái:</strong> ${statusHtml}</p>
                        <p class="mb-0"><i class="fas fa-map-marker-alt text-danger me-2"></i><strong>Vị trí:</strong><br>${currentAddress}</p>
                    </div>
                    ${photoFile ? `<div class="mt-3 text-center">
                        <img src="${photoFile === capturedBlob ? URL.createObjectURL(capturedBlob) : document.getElementById('uploadedImage').src}"
                             style="max-height: 150px; border-radius: 8px; border: 1px solid #ddd;">
                    </div>` : '<p class="text-muted mt-3">Không có ảnh check-out</p>'}
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-sign-out-alt"></i> Xác nhận Check-out',
                cancelButtonText: 'Hủy bỏ',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                reverseButtons: true
            });

            if (!result.isConfirmed) return;

            // ✅ FIXED: Không gửi Address nữa
            const formData = new FormData();
            if (photoFile) formData.append('Photo', photoFile, 'checkout.jpg');
            formData.append('Latitude', latitude);
            formData.append('Longitude', longitude);
            // ❌ ĐÃ XÓA: formData.append('Address', currentAddress);
            formData.append('Notes', document.getElementById('attendanceNotes').value);

            Swal.fire({ title: 'Đang Check-out...', text: 'Đang tổng hợp công...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            try {
                const response = await fetch('/Staff/CheckOut', { method: 'POST', body: formData });
                const data = await response.json();
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Check-out thành công!',
                        html: data.message.replace(/\n/g, '<br>'),
                        confirmButtonText: 'OK'
                    }).then(() => location.reload());
                } else {
                    Swal.fire('Lỗi', data.message, 'error');
                }
            } catch (err) {
                Swal.fire('Lỗi kết nối', err.message, 'error');
            }
        }

        // ========== ATTENDANCE STATUS ==========
        async function checkAttendanceStatus() {
            try {
                const response = await fetch('/Staff/GetTodayAttendance');
                const data = await response.json();

                const statusDiv = document.getElementById('attendanceStatus');
                const checkInSection = document.getElementById('checkInSection');
                const checkOutSection = document.getElementById('checkOutSection');
                const completedSection = document.getElementById('completedSection');

                if (data.hasCheckedIn) {
                    statusDiv.style.display = 'none';
                    if (data.hasCheckedOut) {
                        checkInSection.style.display = 'none';
                        checkOutSection.style.display = 'none';
                        completedSection.style.display = 'block';
                        completedSection.innerHTML = `
                            <div class="alert alert-success">
                                <h5><i class="fas fa-check-double"></i> Đã hoàn tất!</h5>
                                <hr>
                                <div class="row text-center">
                                    <div class="col-6">
                                        <small>Check-in</small><br><strong>${data.checkInTime}</strong>
                                    </div>
                                    <div class="col-6">
                                        <small>Check-out</small><br><strong>${data.checkOutTime}</strong>
                                    </div>
                                </div>
                            </div>
                        `;
                        if (stream) {
                            stream.getTracks().forEach(track => track.stop());
                            stream = null;
                        }
                    } else {
                        checkInSection.style.display = 'none';
                        checkOutSection.style.display = 'block';
                        checkInTimeValue = data.checkInTime;
                        updateWorkingHours();
                    }
                } else {
                    statusDiv.style.display = 'none';
                    checkInSection.style.display = 'block';
                }
                updateButtonsState();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function updateWorkingHours() {
            if (!checkInTimeValue) return;
            const updateHours = () => {
                const now = new Date();
                const checkIn = new Date(`${now.toDateString()} ${checkInTimeValue}`);
                const diff = now - checkIn;
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                const el = document.querySelector('.sd-check-info');
                if (el) {
                    el.innerHTML = `
                        <div class="alert alert-info">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-sign-in-alt me-2"></i>
                                    <strong>Đã check-in:</strong> <code>${checkInTimeValue}</code>
                                </div>
                                <div class="badge bg-primary fs-6">
                                    <i class="fas fa-clock me-1"></i>
                                    ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}
                                </div>
                            </div>
                        </div>
                    `;
                }
            };
            updateHours();
            setInterval(updateHours, 1000);
        }

        // ========== INIT ON LOAD ==========
        window.onload = async function() {
            console.log('🚀 Initializing Staff Dashboard...');
            await initCamera();
            await getLocation();
            await checkAttendanceStatus();
            console.log('✅ Dashboard initialized');
        };

        // ========== CLEANUP ==========
        window.onbeforeunload = function() {
            if (stream) stream.getTracks().forEach(track => track.stop());
        };
    </script>
}