@{
    ViewData["Title"] = "Tin nhắn";
    var currentUserId = Context.Session.GetInt32("UserId");
}

<!-- ✅ LINK TO EXTERNAL CSS FILE -->
<link href="~/css/chat.css" rel="stylesheet" />

<style>
    /* ✅ ADDITIONAL STYLES FOR TABS */
    .chat-sidebar-tabs {
        display: flex;
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
        margin-bottom: 1rem;
    }

    body.staff-dark-mode .chat-sidebar-tabs,
    body.dark-mode .chat-sidebar-tabs {
        background: #0f172a;
        border-bottom-color: #334155;
    }

    .chat-sidebar-tab {
        flex: 1;
        padding: 12px;
        text-align: center;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        color: #64748b;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
        position: relative;
        background: transparent;
        border: none;
        border-radius: 0;
    }

        .chat-sidebar-tab:hover {
            background: rgba(99, 102, 241, 0.05);
            color: #6366f1;
        }

        .chat-sidebar-tab.active {
            color: #6366f1;
            border-bottom-color: #6366f1;
            background: white;
        }

    body.staff-dark-mode .chat-sidebar-tab.active,
    body.dark-mode .chat-sidebar-tab.active {
        background: #1e293b;
    }

    .chat-sidebar-tab-badge {
        position: absolute;
        top: 8px;
        right: 20px;
        background: #ef4444;
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: 700;
        display: none;
    }

        .chat-sidebar-tab-badge.show {
            display: inline-block;
        }

    .user-item {
        padding: 12px;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 4px;
        transition: all 0.2s;
        border: 2px solid transparent;
    }

        .user-item:hover {
            background: rgba(99, 102, 241, 0.05);
            border-color: rgba(99, 102, 241, 0.2);
        }

        .user-item img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e2e8f0;
        }

    .user-item-info {
        flex: 1;
        min-width: 0;
    }

    .user-item-name {
        font-weight: 700;
        font-size: 14px;
        margin-bottom: 4px;
        color: #1e293b;
    }

    body.staff-dark-mode .user-item-name,
    body.dark-mode .user-item-name {
        color: #e2e8f0;
    }

    .user-item-meta {
        font-size: 13px;
        color: #64748b;
    }

    .user-online-indicator {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 12px;
        height: 12px;
        background: #10b981;
        border: 2px solid white;
        border-radius: 50%;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
    }
</style>

<!-- PAGE WRAPPER -->
<div class="chat-page-wrapper">

    <!-- PAGE HEADER -->
    <div class="chat-page-header">
        <h2 class="chat-page-title">
            <i class="fas fa-comments"></i>
            Tin nhắn
        </h2>
        <p class="chat-page-subtitle">Trò chuyện trực tiếp với đồng nghiệp trong hệ thống</p>
    </div>

    <!-- MAIN CHAT CONTAINER -->
    <div class="chat-container">

        <!-- SIDEBAR -->
        <div class="chat-sidebar">
            <div class="chat-sidebar-header">
                <h4><i class="fas fa-inbox me-2"></i>Danh sách</h4>

                <!-- ✅ TABS -->
                <div class="chat-sidebar-tabs">
                    <button class="chat-sidebar-tab active" onclick="switchSidebarTab(event, 'recent')">
                        Gần đây
                        <span class="chat-sidebar-tab-badge" id="recentTabBadge">0</span>
                    </button>
                    <button class="chat-sidebar-tab" onclick="switchSidebarTab(event, 'online')">
                        Online
                        <span class="chat-sidebar-tab-badge show" id="onlineTabBadge">0</span>
                    </button>
                    <button class="chat-sidebar-tab" onclick="switchSidebarTab(event, 'all')">
                        Tất cả
                    </button>
                </div>

                <div class="chat-search">
                    <input type="text" id="searchConversations" placeholder="Tìm kiếm...">
                    <i class="fas fa-search"></i>
                </div>
            </div>

            <div class="conversations-list" id="conversationsList">
                <div class="text-center py-5" style="color: var(--chat-text-muted);">
                    <i class="fas fa-spinner fa-spin fa-3x mb-3" style="opacity: 0.3;"></i>
                    <p style="font-size: 0.875rem;">Đang tải...</p>
                </div>
            </div>
        </div>

        <!-- MAIN CHAT AREA -->
        <div class="chat-main">

            <!-- EMPTY STATE -->
            <div id="emptyState" class="empty-state">
                <i class="fas fa-comment-dots"></i>
                <h5>Chọn một cuộc trò chuyện để bắt đầu</h5>
                <p>Hoặc chọn người dùng từ danh sách để bắt đầu chat</p>
            </div>

            <!-- CHAT AREA (Hidden by default) -->
            <div id="chatArea" style="display: none; flex: 1; display: flex; flex-direction: column;">

                <!-- HEADER -->
                <div class="chat-header">
                    <div class="chat-header-avatar">
                        <img id="chatAvatar" src="/images/default-avatar.png" alt="Avatar">
                    </div>
                    <div class="chat-header-info">
                        <h5 id="chatName">User Name</h5>
                        <div class="chat-header-status" id="chatStatus" style="color: #9ca3af;">Offline</div>
                    </div>
                </div>

                <!-- MESSAGES -->
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be loaded here -->
                </div>

                <!-- TYPING INDICATOR -->
                <div id="typingIndicatorContainer" style="display: none; padding: 0 2rem;">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>

                <!-- INPUT AREA -->
                <div class="chat-input-area">
                    <form class="chat-input-form" id="chatForm">
                        <input type="text" id="messageInput" placeholder="Nhập tin nhắn..." autocomplete="off">
                        <button type="submit" class="chat-send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script>
        const currentUserId = @currentUserId;
        let chatConnection;
        let currentConversationId = null;
        let currentReceiverId = null;
        let typingTimeout;
        let currentSidebarTab = 'recent';
        let allConversations = [];
        let allUsers = [];

        // ✅ Initialize SignalR Connection
        async function initChatHub() {
            try {
                chatConnection = new signalR.HubConnectionBuilder()
                    .withUrl("/chatHub")
                    .withAutomaticReconnect()
                    .build();

                chatConnection.on("ReceiveMessage", (messageData) => {
                    console.log('📨 Received message:', messageData);

                    if (currentConversationId === messageData.conversationId) {
                        appendMessage(messageData);
                        markConversationAsRead(messageData.conversationId);
                    } else {
                        // Show notification for messages in other conversations
                        console.log('📬 New message in different conversation');
                    }

                    loadSidebarData();
                });

                chatConnection.on("MessageSent", (messageData) => {
                    console.log('✅ Message sent confirmation:', messageData);
                    // Message already appended by optimistic UI, no need to append again
                    loadSidebarData(); // Just reload sidebar to update last message
                });

                chatConnection.on("UserOnline", (userId) => {
                    console.log('✅ User online:', userId);
                    updateUserOnlineStatus(userId, true);
                    loadSidebarData();
                });

                chatConnection.on("UserOffline", (userId) => {
                    console.log('❌ User offline:', userId);
                    updateUserOnlineStatus(userId, false);
                    loadSidebarData();
                });

                chatConnection.on("UserTyping", (userId, isTyping) => {
                    if (userId === currentReceiverId) {
                        document.getElementById('typingIndicatorContainer').style.display = isTyping ? 'block' : 'none';
                    }
                });

                chatConnection.on("MessagesRead", (conversationId, readerId) => {
                    if (currentConversationId === conversationId) {
                        document.querySelectorAll('.message.sent .message-time').forEach(el => {
                            if (!el.querySelector('.fa-check-double')) {
                                el.innerHTML += ' <i class="fas fa-check-double" style="color: var(--chat-info);"></i>';
                            }
                        });
                    }
                });

                chatConnection.on("Error", (errorMessage) => {
                    console.error('❌ SignalR Error:', errorMessage);
                    alert(errorMessage);
                });

                await chatConnection.start();
                console.log('✅ Chat Hub Connected');
            } catch (error) {
                console.error('❌ Failed to connect to Chat Hub:', error);
                setTimeout(initChatHub, 3000);
            }
        }

        // ✅ Switch sidebar tab
        window.switchSidebarTab = function(event, tab) {
            event.preventDefault();
            event.stopPropagation();

            currentSidebarTab = tab;

            document.querySelectorAll('.chat-sidebar-tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');

            renderSidebarList();
        };

        // ✅ Load sidebar data (conversations + users)
        async function loadSidebarData() {
            try {
                // Load conversations
                const convResponse = await fetch('/Chat/GetConversations');
                const convData = await convResponse.json();

                if (convData.success) {
                    allConversations = convData.conversations || [];
                }

                // Load all users
                const usersResponse = await fetch('/Chat/SearchUsers?query=');
                const usersData = await usersResponse.json();

                if (usersData.success || usersData.users) {
                    allUsers = usersData.users || [];
                }

                renderSidebarList();
                updateSidebarBadges();
            } catch (error) {
                console.error('❌ Error loading sidebar data:', error);
                showSidebarError();
            }
        }

        // ✅ Render sidebar list based on tab
        function renderSidebarList() {
            const list = document.getElementById('conversationsList');
            const searchQuery = document.getElementById('searchConversations').value.toLowerCase();

            let filtered = [];
            let emptyMessage = 'Không có kết quả';

            if (currentSidebarTab === 'recent') {
                filtered = allConversations;

                if (searchQuery) {
                    filtered = filtered.filter(c =>
                        c.otherUser.fullName.toLowerCase().includes(searchQuery)
                    );
                }

                emptyMessage = searchQuery ? 'Không tìm thấy cuộc trò chuyện' : 'Chưa có tin nhắn nào';

                if (filtered.length === 0) {
                    list.innerHTML = `
                        <div class="text-center py-5" style="color: var(--chat-text-muted);">
                            <i class="fas fa-comments fa-3x mb-3" style="opacity: 0.3;"></i>
                            <p style="font-size: 0.875rem;">${emptyMessage}</p>
                        </div>`;
                    return;
                }

                list.innerHTML = filtered.map(conv => `
                    <div class="conversation-item ${conv.conversationId === currentConversationId ? 'active' : ''}"
                         onclick="openConversation(${conv.conversationId}, ${conv.otherUser.userId}, '${escapeHtml(conv.otherUser.fullName)}', '${conv.otherUser.avatar || '/images/default-avatar.png'}', ${conv.isOnline})">
                        <div class="conversation-avatar">
                            <img src="${conv.otherUser.avatar || '/images/default-avatar.png'}" alt="Avatar">
                            ${conv.isOnline ? '<div class="online-indicator"></div>' : ''}
                        </div>
                        <div class="conversation-content">
                            <div class="conversation-name">
                                <span>${escapeHtml(conv.otherUser.fullName)}</span>
                                ${conv.unreadCount > 0 ? `<span class="unread-badge">${conv.unreadCount}</span>` : ''}
                            </div>
                            ${conv.lastMessage ? `
                                <div class="conversation-preview">
                                    ${conv.lastMessage.senderId === currentUserId ? 'Bạn: ' : ''}
                                    ${escapeHtml(conv.lastMessage.content)}
                                </div>
                            ` : '<div class="conversation-preview">Bắt đầu trò chuyện</div>'}
                        </div>
                    </div>
                `).join('');

            } else if (currentSidebarTab === 'online') {
                filtered = allConversations.filter(c => c.isOnline);

                if (searchQuery) {
                    filtered = filtered.filter(c =>
                        c.otherUser.fullName.toLowerCase().includes(searchQuery)
                    );
                }

                emptyMessage = searchQuery ? 'Không tìm thấy người online' : 'Không có ai online';

                if (filtered.length === 0) {
                    list.innerHTML = `
                        <div class="text-center py-5" style="color: var(--chat-text-muted);">
                            <i class="fas fa-user-slash fa-3x mb-3" style="opacity: 0.3;"></i>
                            <p style="font-size: 0.875rem;">${emptyMessage}</p>
                        </div>`;
                    return;
                }

                list.innerHTML = filtered.map(conv => `
                    <div class="conversation-item ${conv.conversationId === currentConversationId ? 'active' : ''}"
                         onclick="openConversation(${conv.conversationId}, ${conv.otherUser.userId}, '${escapeHtml(conv.otherUser.fullName)}', '${conv.otherUser.avatar || '/images/default-avatar.png'}', ${conv.isOnline})">
                        <div class="conversation-avatar">
                            <img src="${conv.otherUser.avatar || '/images/default-avatar.png'}" alt="Avatar">
                            <div class="online-indicator"></div>
                        </div>
                        <div class="conversation-content">
                            <div class="conversation-name">
                                <span>${escapeHtml(conv.otherUser.fullName)}</span>
                            </div>
                            <div class="conversation-preview">
                                Đang hoạt động
                            </div>
                        </div>
                    </div>
                `).join('');

            } else if (currentSidebarTab === 'all') {
                filtered = allUsers;

                if (searchQuery) {
                    filtered = filtered.filter(u =>
                        u.fullName.toLowerCase().includes(searchQuery) ||
                        (u.email && u.email.toLowerCase().includes(searchQuery))
                    );
                }

                emptyMessage = searchQuery ? 'Không tìm thấy người dùng' : 'Không có người dùng nào';

                if (filtered.length === 0) {
                    list.innerHTML = `
                        <div class="text-center py-5" style="color: var(--chat-text-muted);">
                            <i class="fas fa-users fa-3x mb-3" style="opacity: 0.3;"></i>
                            <p style="font-size: 0.875rem;">${emptyMessage}</p>
                        </div>`;
                    return;
                }

                list.innerHTML = filtered.map(user => `
                    <div class="user-item" onclick="startChatWithUser(${user.userId})">
                        <div style="position: relative;">
                            <img src="${user.avatar || '/images/default-avatar.png'}" alt="Avatar">
                            ${user.isOnline ? '<div class="user-online-indicator"></div>' : ''}
                        </div>
                        <div class="user-item-info">
                            <div class="user-item-name">${escapeHtml(user.fullName)}</div>
                            <div class="user-item-meta">
                                ${escapeHtml(user.departmentName || 'N/A')} • ${escapeHtml(user.roleName)}
                                ${user.isOnline ? ' • <span style="color: #10b981;">Online</span>' : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // ✅ Update sidebar badges
        function updateSidebarBadges() {
            const totalUnread = allConversations.reduce((sum, c) => sum + c.unreadCount, 0);
            const onlineCount = allConversations.filter(c => c.isOnline).length;

            const recentBadge = document.getElementById('recentTabBadge');
            const onlineBadge = document.getElementById('onlineTabBadge');

            if (totalUnread > 0) {
                recentBadge.textContent = totalUnread > 99 ? '99+' : totalUnread;
                recentBadge.classList.add('show');
            } else {
                recentBadge.classList.remove('show');
            }

            if (onlineCount > 0) {
                onlineBadge.textContent = onlineCount;
                onlineBadge.classList.add('show');
            } else {
                onlineBadge.classList.remove('show');
            }
        }

        // ✅ Show sidebar error
        function showSidebarError() {
            const list = document.getElementById('conversationsList');
            list.innerHTML = `
                <div class="text-center py-5" style="color: var(--chat-text-muted);">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3" style="opacity: 0.3;"></i>
                    <p style="font-size: 0.875rem;">Không thể tải dữ liệu</p>
                    <button onclick="loadSidebarData()" style="margin-top:10px; padding:8px 16px; background:#6366f1; color:white; border:none; border-radius:8px; cursor:pointer;">
                        Tải lại
                    </button>
                </div>
            `;
        }

        // ✅ Start chat with user from "All" tab
        window.startChatWithUser = async function(userId) {
            try {
                const response = await fetch('/Chat/StartConversation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userId)
                });

                const data = await response.json();

                if (data.success) {
                    await loadSidebarData();

                    // Switch to recent tab
                    currentSidebarTab = 'recent';
                    document.querySelectorAll('.chat-sidebar-tab').forEach(t => t.classList.remove('active'));
                    document.querySelector('.chat-sidebar-tab').classList.add('active');
                    renderSidebarList();

                    // Open conversation
                    openConversation(
                        data.conversationId,
                        data.otherUser.userId,
                        data.otherUser.fullName,
                        data.otherUser.avatar || '/images/default-avatar.png',
                        data.otherUser.isOnline
                    );
                } else {
                    alert('Không thể tạo cuộc trò chuyện. Vui lòng thử lại.');
                }
            } catch (error) {
                console.error('Error starting chat:', error);
                alert('Đã xảy ra lỗi. Vui lòng thử lại.');
            }
        };

        // Open conversation
        window.openConversation = async function(conversationId, receiverId, name, avatar, isOnline) {
            currentConversationId = conversationId;
            currentReceiverId = receiverId;

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('chatArea').style.display = 'flex';

            document.getElementById('chatName').textContent = name;
            document.getElementById('chatAvatar').src = avatar;
            document.getElementById('chatStatus').textContent = isOnline ? 'Đang hoạt động' : 'Offline';
            document.getElementById('chatStatus').style.color = isOnline ? '#10b981' : '#9ca3af';

            // Update active state
            document.querySelectorAll('.conversation-item, .user-item').forEach(el => el.classList.remove('active'));
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }

            await loadMessages(conversationId);
            await markConversationAsRead(conversationId);
        };

        // Load messages
        async function loadMessages(conversationId) {
            try {
                const response = await fetch(`/Chat/GetMessages?conversationId=${conversationId}`);
                const data = await response.json();

                const container = document.getElementById('chatMessages');
                container.innerHTML = data.messages.map(msg => createMessageHTML(msg)).join('');

                container.scrollTop = container.scrollHeight;
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Create message HTML
        function createMessageHTML(msg) {
            const isSent = msg.senderId === currentUserId;
            const time = new Date(msg.sentAt).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            return `
                <div class="message ${isSent ? 'sent' : 'received'}">
                    <div class="message-avatar">
                        <img src="${msg.senderAvatar || '/images/default-avatar.png'}" alt="Avatar">
                    </div>
                    <div class="message-content">
                        <div class="message-bubble">${escapeHtml(msg.message || msg.messageContent || msg.content)}</div>
                        <div class="message-time">${time}</div>
                    </div>
                </div>
            `;
        }

        // Append new message
        function appendMessage(messageData) {
            const container = document.getElementById('chatMessages');
            const newMessage = {
                senderId: messageData.senderId,
                senderAvatar: messageData.senderAvatar,
                message: messageData.message || messageData.content,
                sentAt: messageData.sentAt || new Date()
            };
            container.innerHTML += createMessageHTML(newMessage);
            container.scrollTop = container.scrollHeight;
        }

        // ✅ Send message - FIXED WITH OPTIMISTIC UI
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message || !currentReceiverId) {
                console.warn('⚠️ No message or receiver');
                return;
            }

            // ✅ OPTIMISTIC UI - Show message immediately
            const tempMessage = {
                senderId: currentUserId,
                senderAvatar: document.getElementById('chatAvatar').src,
                message: message,
                sentAt: new Date()
            };
            appendMessage(tempMessage);
            input.value = '';

            try {
                console.log('📤 Sending message:', message, 'to:', currentReceiverId);

                await chatConnection.invoke("SendMessage", currentReceiverId, message, null, null);

                // Stop typing indicator
                clearTimeout(typingTimeout);
                await chatConnection.invoke("NotifyTyping", currentReceiverId, currentUserId, false);

                console.log('✅ Message sent successfully');
            } catch (error) {
                console.error('❌ Error sending message:', error);
                alert('Không thể gửi tin nhắn: ' + error.message);

                // Remove the optimistically added message on error
                const messages = document.getElementById('chatMessages');
                if (messages.lastChild) {
                    messages.lastChild.remove();
                }
            }
        });

        // Typing indicator
        document.getElementById('messageInput').addEventListener('input', async (e) => {
            if (!currentReceiverId || !chatConnection) return;

            clearTimeout(typingTimeout);

            if (e.target.value.trim()) {
                try {
                    await chatConnection.invoke("NotifyTyping", currentReceiverId, currentUserId, true);

                    typingTimeout = setTimeout(async () => {
                        await chatConnection.invoke("NotifyTyping", currentReceiverId, currentUserId, false);
                    }, 2000);
                } catch (error) {
                    console.error('Error notifying typing:', error);
                }
            } else {
                try {
                    await chatConnection.invoke("NotifyTyping", currentReceiverId, currentUserId, false);
                } catch (error) {
                    console.error('Error notifying typing:', error);
                }
            }
        });

        // Mark as read
        async function markConversationAsRead(conversationId) {
            try {
                await chatConnection.invoke("MarkAsRead", conversationId);
                loadSidebarData();
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        }

        // Search handler
        document.getElementById('searchConversations').addEventListener('input', () => {
            renderSidebarList();
        });

        // Helper functions
        function updateUserOnlineStatus(userId, isOnline) {
            if (userId === currentReceiverId) {
                document.getElementById('chatStatus').textContent = isOnline ? 'Đang hoạt động' : 'Offline';
                document.getElementById('chatStatus').style.color = isOnline ? '#10b981' : '#9ca3af';
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ✅ Initialize - CHECK URL PARAMS
        document.addEventListener('DOMContentLoaded', async () => {
            await initChatHub();
            await loadSidebarData();

            // Check if conversationId in URL
            const urlParams = new URLSearchParams(window.location.search);
            const conversationId = urlParams.get('conversationId');

            if (conversationId) {
                // Find conversation and open it
                const conv = allConversations.find(c => c.conversationId == conversationId);
                if (conv) {
                    openConversation(
                        conv.conversationId,
                        conv.otherUser.userId,
                        conv.otherUser.fullName,
                        conv.otherUser.avatar || '/images/default-avatar.png',
                        conv.isOnline
                    );
                }
            }
        });
    </script>
}