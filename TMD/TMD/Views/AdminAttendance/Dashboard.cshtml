@{
    ViewData["Title"] = "Admin Attendance";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var admin = ViewBag.Admin as TMD.Models.User;
}

<link href="~/css/staff-dashboard.css" rel="stylesheet" />

<div class="sd-container">
    <!-- WELCOME HEADER -->
    <div class="sd-page-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="sd-welcome-content">
                    <h2 class="sd-page-title">
                        <i class="fas fa-clock me-2"></i>
                        Chấm công Admin - @admin.FullName
                    </h2>
                    <p class="sd-page-subtitle">
                        <i class="fas fa-lock"></i> Quản trị viên hệ thống
                        @if (admin.Department != null)
                        {
                            <span class="mx-2">•</span>
                            <i class="fas fa-building"></i> @admin.Department.DepartmentName
                        }
                    </p>
                </div>
            </div>
            <div class="col-md-4 d-flex justify-content-end align-items-center">
                <div class="sd-current-time me-3">
                    <div id="currentDate" class="sd-date-display"></div>
                    <div id="currentTime" class="sd-time-display"></div>
                    <small class="sd-text-muted">Thời gian server</small>
                </div>
            </div>
        </div>
    </div>

    <!-- STATISTICS -->
    <div class="row g-3 mb-4">
        <div class="col-md-3 col-6">
            <div class="sd-stats-card sd-stats-primary">
                <div class="sd-stats-icon"><i class="fas fa-calendar-check"></i></div>
                <div class="sd-stats-content">
                    <div class="sd-stats-label">Ngày chấm công</div>
                    <div class="sd-stats-value">@(ViewBag.ThisMonthAttendances ?? 0)</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="sd-stats-card sd-stats-success">
                <div class="sd-stats-icon"><i class="fas fa-clock"></i></div>
                <div class="sd-stats-content">
                    <div class="sd-stats-label">Tổng giờ làm</div>
                    <div class="sd-stats-value">@(ViewBag.ThisMonthWorkHours?.ToString("F0") ?? "0")h</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="sd-stats-card sd-stats-warning">
                <div class="sd-stats-icon"><i class="fas fa-check"></i></div>
                <div class="sd-stats-content">
                    <div class="sd-stats-label">Đúng giờ</div>
                    <div class="sd-stats-value">@ViewBag.OnTimeCount</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="sd-stats-card sd-stats-danger">
                <div class="sd-stats-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="sd-stats-content">
                    <div class="sd-stats-label">Đi trễ</div>
                    <div class="sd-stats-value">@ViewBag.LateCount</div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="row g-4">
        <!-- CHECK-IN/OUT SECTION -->
        <div class="col-lg-8">
            <div class="sd-card">
                <div class="sd-card-header">
                    <h5><i class="fas fa-user-clock me-2"></i> Chấm công hôm nay</h5>
                </div>
                <div class="sd-card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <!-- Photo Options -->
                            <div class="sd-photo-options mb-3">
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="photoMode" id="modeCamera" value="camera" checked>
                                    <label class="btn btn-outline-primary" for="modeCamera">
                                        <i class="fas fa-camera"></i> Chụp ảnh
                                    </label>
                                    <input type="radio" class="btn-check" name="photoMode" id="modeUpload" value="upload">
                                    <label class="btn btn-outline-primary" for="modeUpload">
                                        <i class="fas fa-upload"></i> Tải ảnh lên
                                    </label>
                                </div>
                            </div>

                            <!-- Camera Mode -->
                            <div id="cameraMode" class="photo-mode">
                                <div class="sd-camera-container">
                                    <div class="sd-camera-preview" id="cameraPreview">
                                        <video id="video" autoplay playsinline></video>
                                        <canvas id="canvas" style="display: none;"></canvas>
                                        <img id="capturedImage" style="display: none;" />
                                        <div class="sd-camera-overlay"></div>
                                    </div>
                                    <div class="sd-camera-controls">
                                        <button class="sd-btn-camera" id="btnCapture" onclick="capturePhoto()">
                                            <i class="fas fa-camera"></i>
                                        </button>
                                        <button class="sd-btn-camera sd-btn-warning" id="btnRetake" onclick="retakePhoto()" style="display: none;">
                                            <i class="fas fa-redo"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Upload Mode -->
                            <div id="uploadMode" class="photo-mode" style="display: none;">
                                <div class="sd-upload-container">
                                    <div class="sd-upload-preview" id="uploadPreview">
                                        <div class="sd-upload-placeholder" id="uploadPlaceholder">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <p>Kéo thả ảnh vào đây hoặc nhấn để chọn</p>
                                            <input type="file" id="fileInput" accept="image/jpeg,image/jpg,image/png" style="display: none;">
                                        </div>
                                        <img id="uploadedImage" style="display: none;" />
                                    </div>
                                    <div class="sd-upload-controls">
                                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                            <i class="fas fa-folder-open"></i> Chọn ảnh
                                        </button>
                                        <button class="btn btn-warning ms-2" id="btnClearUpload" onclick="clearUploadedImage()" style="display: none;">
                                            <i class="fas fa-times"></i> Xóa
                                        </button>
                                    </div>
                                    <small class="sd-text-muted d-block mt-2 text-center">
                                        Chấp nhận: JPG, JPEG, PNG (Tối đa 10MB)
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="sd-attendance-info">
                                <!-- Status Display -->
                                <div id="attendanceStatus" class="sd-attendance-status mb-3">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <span class="ms-2">Đang kiểm tra trạng thái...</span>
                                </div>

                                <!-- Location Info -->
                                <div class="sd-location-box mb-3">
                                    <h6><i class="fas fa-map-marker-alt me-2"></i> Vị trí hiện tại</h6>
                                    <div id="locationInfo">
                                        <div class="alert alert-info">
                                            <i class="fas fa-spinner fa-spin"></i> Đang lấy vị trí GPS...
                                        </div>
                                    </div>
                                </div>

                                <!-- Notes -->
                                <div class="mb-3">
                                    <label class="sd-form-label">Ghi chú (tùy chọn)</label>
                                    <textarea id="attendanceNotes" class="sd-form-control" rows="2" placeholder="Thêm ghi chú nếu cần..."></textarea>
                                </div>

                                <!-- Check-in Button -->
                                <div id="checkInSection" style="display: none;">
                                    <button class="btn btn-success btn-lg w-100" onclick="checkIn()" id="btnCheckIn" disabled>
                                        <i class="fas fa-sign-in-alt"></i> Check In Ngay
                                    </button>
                                </div>

                                <!-- Check-out Section -->
                                <div id="checkOutSection" style="display: none;">
                                    <div class="sd-check-info mb-3"></div>
                                    <button class="btn btn-danger btn-lg w-100" onclick="checkOut()" id="btnCheckOut" disabled>
                                        <i class="fas fa-sign-out-alt"></i> Check Out Ngay
                                    </button>
                                </div>

                                <!-- Completed Section -->
                                <div id="completedSection" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- INFO SECTION -->
        <div class="col-lg-4">
            <div class="sd-card">
                <div class="sd-card-header">
                    <h5><i class="fas fa-info-circle me-2"></i> Thông tin hôm nay</h5>
                </div>
                <div class="sd-card-body">
                    <div class="mb-3">
                        <small class="sd-text-muted d-block mb-2">CHUẨN CHECK-IN</small>
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-clock me-2"></i>
                            <strong>@ViewBag.StandardStartTime</strong>
                        </div>
                    </div>

                    <div class="mb-3">
                        <small class="sd-text-muted d-block mb-2">CHUẨN CHECK-OUT</small>
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-clock me-2"></i>
                            <strong>@ViewBag.StandardEndTime</strong>
                        </div>
                    </div>

                    <div class="divider my-3"></div>

                    <div id="todayInfo">
                        <div class="alert alert-info text-center">
                            <i class="fas fa-spinner fa-spin"></i> Đang tải thông tin...
                        </div>
                    </div>

                    <div class="mt-3">
                        <a href="/Admin/AttendanceHistory" class="btn btn-sm btn-outline-primary w-100">
                            <i class="fas fa-history me-1"></i> Xem lịch sử chấm công
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
                 // ========== ADMIN DASHBOARD - FIXED CHECK-IN/OUT LOGIC ==========
        // Thay thế phần script trong AdminAttendance/Dashboard.cshtml

        // ========== GLOBAL VARIABLES ==========
        let stream = null;
        let capturedBlob = null;
        let uploadedFile = null;
        let latitude = null;
        let longitude = null;
        let currentAddress = '';
        let isGettingLocation = false;
        let isLocationLocked = false;
        let checkInTimeValue = null;
        let cameraErrorShown = false;

        // ✅ GIỚI HẠN THỜI GIAN MỚI
        const SERVER_START_STR = "@ViewBag.StandardStartTime";
        const SERVER_END_STR = "@ViewBag.StandardEndTime";

        const STANDARD_START_TIME = SERVER_START_STR || "09:00";
        const STANDARD_END_TIME = SERVER_END_STR || "22:00"; // ✅ Checkout tối đa 22:00

        // ========== HELPER: TIME CONVERSION ==========
        function getMinutes(timeStr) {
            if (!timeStr) return 0;
            const cleanTime = timeStr.split(' ')[0].substring(0, 5);
            const parts = cleanTime.split(':');
            const hours = parseInt(parts[0], 10) || 0;
            const minutes = parseInt(parts[1], 10) || 0;
            return (hours * 60) + minutes;
        }

        // ✅ KIỂM TRA THỨ 7, CHỦ NHẬT
        function isWeekend() {
            const day = new Date().getDay();
            return day === 0 || day === 6; // 0 = CN, 6 = T7
        }

        function isSaturday() {
            return new Date().getDay() === 6;
        }

        function isSunday() {
            return new Date().getDay() === 0;
        }

        // ========== TIME UPDATE ==========
        function updateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('vi-VN', options);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('vi-VN');
        }
        setInterval(updateTime, 1000);
        updateTime();

        // ========== PHOTO MODE SWITCH ==========
        document.querySelectorAll('input[name="photoMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'camera') {
                    document.getElementById('cameraMode').style.display = 'block';
                    document.getElementById('uploadMode').style.display = 'none';
                    uploadedFile = null;
                    clearUploadedImage();
                    initCamera();
                } else {
                    document.getElementById('cameraMode').style.display = 'none';
                    document.getElementById('uploadMode').style.display = 'block';
                    retakePhoto();
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        stream = null;
                    }
                }
                updateButtonsState();
            });
        });

        // ========== CAMERA LOGIC ==========
        async function initCamera() {
            if (stream) return;
            if (cameraErrorShown) return;

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                document.getElementById('video').srcObject = stream;
            } catch (err) {
                console.warn('Camera không khả dụng:', err.message);
                // ✅ KHÔNG BẮT BUỘC CAMERA - chỉ log warning
                cameraErrorShown = true;
            }
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const capturedImage = document.getElementById('capturedImage');

            const MAX_WIDTH = 1024;
            let width = video.videoWidth;
            let height = video.videoHeight;
            if (width > MAX_WIDTH) {
                height = height * (MAX_WIDTH / width);
                width = MAX_WIDTH;
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, width, height);
            canvas.toBlob(blob => {
                capturedBlob = blob;
                capturedImage.src = URL.createObjectURL(blob);
                capturedImage.style.display = 'block';
                video.style.display = 'none';
                document.getElementById('btnCapture').style.display = 'none';
                document.getElementById('btnRetake').style.display = 'inline-block';
                updateButtonsState();
            }, 'image/jpeg', 0.8);
        }

        function retakePhoto() {
            document.getElementById('video').style.display = 'block';
            document.getElementById('capturedImage').style.display = 'none';
            document.getElementById('btnCapture').style.display = 'inline-block';
            document.getElementById('btnRetake').style.display = 'none';
            capturedBlob = null;
            updateButtonsState();
            if (!cameraErrorShown) initCamera();
        }

        // ========== LOCATION LOGIC ==========
        async function getLocation(isRetry = false) {
            if (isLocationLocked && !isRetry) return;
            if (isGettingLocation) return;

            if (!navigator.geolocation) {
                showLocationWarning('Trình duyệt không hỗ trợ GPS - vẫn có thể check-in');
                return;
            }

            isGettingLocation = true;
            document.getElementById('locationInfo').innerHTML = `
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2"></div>
                        <div><strong>Đang lấy vị trí...</strong></div>
                    </div>
                </div>`;

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true, timeout: 10000, maximumAge: 0
                    });
                });
                latitude = position.coords.latitude;
                longitude = position.coords.longitude;
                const accuracy = position.coords.accuracy;

                await getAddressFromServer(latitude, longitude, accuracy);

                isGettingLocation = false;
                isLocationLocked = true;
            } catch (error) {
                console.warn('Không lấy được GPS:', error.message);
                isGettingLocation = false;
                isLocationLocked = false;

                // ✅ KHÔNG BẮT BUỘC GPS - chỉ hiển thị warning
                showLocationWarning('Không lấy được GPS - vẫn có thể check-in (không có vị trí)', true);
            }
        }

        function showLocationWarning(msg, showRetry = false) {
            document.getElementById('locationInfo').innerHTML = `
                <div class="alert alert-warning">
                    <div class="d-flex justify-content-between align-items-start">
                        <div><i class="fas fa-exclamation-triangle"></i> ${msg}</div>
                        ${showRetry ? `<button class="btn btn-sm btn-outline-warning" onclick="getLocation(true)"><i class="fas fa-sync-alt"></i></button>` : ''}
                    </div>
                </div>`;
            // ✅ QUAN TRỌNG: Vẫn cho phép check-in
            updateButtonsState();
        }

        async function getAddressFromServer(lat, lng, accuracy) {
            try {
                // ✅ API cho ADMIN
                const response = await fetch(`/AdminAttendance/GetAddressFromCoordinatesApi?latitude=${lat}&longitude=${lng}`);
                const data = await response.json();
                currentAddress = (data.success && data.address) ? data.address : `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            } catch (err) {
                currentAddress = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
            displayLocationSuccess(accuracy);
        }

        function displayLocationSuccess(accuracy) {
            document.getElementById('locationInfo').innerHTML = `
                <div class="alert alert-success">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong><i class="fas fa-check-circle"></i> Đã lấy vị trí</strong>
                            <p class="mb-0 mt-1 small"><i class="fas fa-map-marker-alt text-danger"></i> ${currentAddress}</p>
                            <small class="text-muted">Độ chính xác: ±${Math.round(accuracy)}m</small>
                        </div>
                        <button class="btn btn-sm btn-light text-primary" onclick="getLocation(true)"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>`;
            updateButtonsState();
        }

        // ========== FILE UPLOAD ==========
        const fileInput = document.getElementById('fileInput');
        if(fileInput) {
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    uploadedFile = file;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('uploadPlaceholder').style.display = 'none';
                        const img = document.getElementById('uploadedImage');
                        img.src = e.target.result;
                        img.style.display = 'block';
                        document.getElementById('btnClearUpload').style.display = 'inline-block';
                        updateButtonsState();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        if(uploadPlaceholder) uploadPlaceholder.addEventListener('click', () => document.getElementById('fileInput').click());

        function clearUploadedImage() {
            uploadedFile = null;
            document.getElementById('uploadedImage').style.display = 'none';
            document.getElementById('uploadPlaceholder').style.display = 'flex';
            document.getElementById('btnClearUpload').style.display = 'none';
            document.getElementById('fileInput').value = '';
            updateButtonsState();
        }

        // ✅ CẬP NHẬT: LUÔN CHO PHÉP CHECK-IN/OUT (không cần GPS + ảnh bắt buộc)
        function updateButtonsState() {
            const btnIn = document.getElementById('btnCheckIn');
            const btnOut = document.getElementById('btnCheckOut');

            // ✅ LUÔN ENABLE (không yêu cầu GPS hay ảnh)
            if (btnIn) btnIn.disabled = false;
            if (btnOut) btnOut.disabled = false;
        }

        function getCurrentTimeStr() {
            return new Date().toTimeString().substring(0, 5); // HH:mm
        }

        // ========== CHECK IN FUNCTION ==========
        async function checkIn() {
            const nowStr = getCurrentTimeStr();
            const currentMin = getMinutes(nowStr);

            // ✅ LOGIC MỚI: CHỈ TRỄ KHI > 09:01
            const lateThreshold = getMinutes("09:01"); // 9 giờ 1 phút

            console.log("ADMIN CHECK-IN LOGIC:");
            console.log(`- Giờ hiện tại: ${nowStr} -> ${currentMin} phút`);
            console.log(`- Ngưỡng trễ: 09:01 -> ${lateThreshold} phút`);

            let statusHtml = '';
            let warningHtml = '';

            // ✅ KIỂM TRA CUỐI TUẦN
            if (isSunday()) {
                warningHtml = `<div class="alert alert-danger mt-2"><i class="fas fa-calendar-times"></i> <strong>Chủ nhật:</strong> Làm việc sẽ tính tăng ca</div>`;
            } else if (isSaturday()) {
                warningHtml = `<div class="alert alert-warning mt-2"><i class="fas fa-calendar-day"></i> <strong>Thứ 7:</strong> Chỉ làm buổi sáng, chiều = tăng ca</div>`;
            }

            // ✅ LOGIC TRỄ: > 09:01
            if (currentMin > lateThreshold) {
                const lateMin = currentMin - lateThreshold;
                statusHtml = `<span class="badge bg-danger fs-6">Đi trễ ${lateMin} phút</span> <small class="text-muted">(Giờ chuẩn: 09:00)</small>`;
            } else {
                statusHtml = `<span class="badge bg-success fs-6">Đúng giờ</span>`;
            }

            const photoFile = capturedBlob || uploadedFile;
            const hasLocation = latitude !== null && longitude !== null;

            const result = await Swal.fire({
                title: 'Xác nhận Check-in',
                html: `
                    <div class="text-start p-3 bg-light rounded">
                        <p class="mb-2"><i class="fas fa-clock text-primary me-2"></i><strong>Giờ Check-in:</strong> ${nowStr}</p>
                        <p class="mb-2"><i class="fas fa-info-circle text-info me-2"></i><strong>Trạng thái:</strong> ${statusHtml}</p>
                        <p class="mb-2"><i class="fas fa-map-marker-alt text-danger me-2"></i><strong>Vị trí:</strong><br>${hasLocation ? currentAddress : '<em class="text-muted">Không có GPS</em>'}</p>
                        ${!photoFile ? '<p class="mb-0 text-warning"><i class="fas fa-camera"></i> Không có ảnh check-in</p>' : ''}
                        ${warningHtml}
                    </div>
                    ${photoFile ? `<div class="mt-3 text-center"><img src="${photoFile === capturedBlob ? URL.createObjectURL(capturedBlob) : document.getElementById('uploadedImage').src}" style="max-height: 150px; border-radius: 8px;"></div>` : ''}
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Check-in ngay',
                cancelButtonText: 'Hủy'
            });

            if (result.isConfirmed) {
                // ✅ API ADMIN
                await submitAttendance('/AdminAttendance/CheckIn', photoFile, 'Check-in thành công!');
            }
        }

        // ========== CHECK OUT FUNCTION ==========
        async function checkOut() {
            const nowStr = getCurrentTimeStr();
            const currentMin = getMinutes(nowStr);
            const standardMin = getMinutes(STANDARD_END_TIME); // 22:00

            console.log("ADMIN CHECK-OUT LOGIC:");
            console.log(`- Giờ hiện tại: ${nowStr} -> ${currentMin} phút`);
            console.log(`- Giờ chuẩn CheckOut: ${STANDARD_END_TIME} -> ${standardMin} phút`);

            let statusHtml = '';
            let warningHtml = '';

            // ✅ KIỂM TRA CUỐI TUẦN
            if (isSunday()) {
                warningHtml = `<div class="alert alert-info mt-2"><i class="fas fa-coins"></i> <strong>Chủ nhật:</strong> Tính tăng ca toàn bộ</div>`;
            } else if (isSaturday()) {
                // ✅ THỨ 7: CHIỀU = TĂNG CA
                const noonMin = getMinutes("12:00");
                if (currentMin > noonMin) {
                    warningHtml = `<div class="alert alert-info mt-2"><i class="fas fa-coins"></i> <strong>Thứ 7 chiều:</strong> Làm việc sẽ tính tăng ca</div>`;
                }
            }

            // ✅ LOGIC VỀ SỚM: < 22:00
            if (currentMin < standardMin) {
                statusHtml = `<span class="badge bg-warning text-dark fs-6">Về sớm</span> <small class="text-muted">(Chuẩn: ${STANDARD_END_TIME})</small>`;
            } else {
                statusHtml = `<span class="badge bg-success fs-6">Đúng giờ</span>`;
            }

            const photoFile = capturedBlob || uploadedFile;
            const hasLocation = latitude !== null && longitude !== null;

            const result = await Swal.fire({
                title: 'Xác nhận Check-out',
                html: `
                    <div class="text-start p-3 bg-light rounded">
                        <p class="mb-2"><i class="fas fa-clock text-primary me-2"></i><strong>Giờ Check-out:</strong> ${nowStr}</p>
                        <p class="mb-2"><i class="fas fa-info-circle text-info me-2"></i><strong>Trạng thái:</strong> ${statusHtml}</p>
                        <p class="mb-2"><i class="fas fa-map-marker-alt text-danger me-2"></i><strong>Vị trí:</strong><br>${hasLocation ? currentAddress : '<em class="text-muted">Không có GPS</em>'}</p>
                        ${!photoFile ? '<p class="mb-0 text-warning"><i class="fas fa-camera"></i> Không có ảnh check-out</p>' : ''}
                        ${warningHtml}
                    </div>
                    ${photoFile ? `<div class="mt-3 text-center"><img src="${photoFile === capturedBlob ? URL.createObjectURL(capturedBlob) : document.getElementById('uploadedImage').src}" style="max-height: 150px; border-radius: 8px;"></div>` : ''}
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Check-out ngay',
                cancelButtonText: 'Hủy'
            });

            if (result.isConfirmed) {
                // ✅ API ADMIN
                await submitAttendance('/AdminAttendance/CheckOut', photoFile, 'Check-out thành công!');
            }
        }

        // ========== SUBMIT HELPER ==========
        async function submitAttendance(url, photoFile, successMsg) {
            const formData = new FormData();

            // ✅ ẢNH VÀ GPS TÙY CHỌN
            if (photoFile) formData.append('Photo', photoFile, 'attendance.jpg');

            // ✅ NẾU KHÔNG CÓ GPS, GỬI 0,0
            formData.append('Latitude', latitude || 0);
            formData.append('Longitude', longitude || 0);

            const notes = document.getElementById('attendanceNotes');
            if(notes) formData.append('Notes', notes.value);

            Swal.fire({ title: 'Đang xử lý...', didOpen: () => Swal.showLoading() });

            try {
                const response = await fetch(url, { method: 'POST', body: formData });
                const data = await response.json();
                if (data.success) {
                    Swal.fire('Thành công', successMsg, 'success').then(() => location.reload());
                } else {
                    Swal.fire('Lỗi', data.message, 'error');
                }
            } catch (err) {
                Swal.fire('Lỗi kết nối', err.message, 'error');
            }
        }

        // ========== ATTENDANCE STATUS ==========
        async function checkAttendanceStatus() {
            try {
                // ✅ API ADMIN
                const response = await fetch('/AdminAttendance/GetTodayAttendance');
                const data = await response.json();

                const checkInSection = document.getElementById('checkInSection');
                const checkOutSection = document.getElementById('checkOutSection');
                const completedSection = document.getElementById('completedSection');
                const attendanceStatus = document.getElementById('attendanceStatus');

                // ✅ ẨN LOADING
                if (attendanceStatus) attendanceStatus.style.display = 'none';

                if(checkInSection) checkInSection.style.display = 'none';
                if(checkOutSection) checkOutSection.style.display = 'none';
                if(completedSection) completedSection.style.display = 'none';

                if (data.hasCheckedIn) {
                    if (data.hasCheckedOut) {
                        if(completedSection) {
                            completedSection.style.display = 'block';
                            completedSection.innerHTML = `
                                <div class="alert alert-success">
                                    <h5><i class="fas fa-check-double"></i> Đã hoàn tất hôm nay</h5>
                                    <hr>
                                    <div class="row text-center">
                                        <div class="col-6">Check-in<br><strong>${data.checkInTime}</strong></div>
                                        <div class="col-6">Check-out<br><strong>${data.checkOutTime}</strong></div>
                                    </div>
                                </div>`;
                        }
                        if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
                    } else {
                        if(checkOutSection) checkOutSection.style.display = 'block';
                        checkInTimeValue = data.checkInTime;
                        startCountingWorkTime();
                    }
                } else {
                    if(checkInSection) checkInSection.style.display = 'block';
                }
                updateButtonsState();
            } catch (error) {
                console.error(error);
                // ✅ ẨN LOADING NGAY CẢ KHI LỖI
                const attendanceStatus = document.getElementById('attendanceStatus');
                if (attendanceStatus) attendanceStatus.style.display = 'none';

                // ✅ HIỆN NÚT CHECK-IN NẾU LỖI
                const checkInSection = document.getElementById('checkInSection');
                if(checkInSection) checkInSection.style.display = 'block';
                updateButtonsState();
            }
        }

        function startCountingWorkTime() {
            if (!checkInTimeValue) return;
            const update = () => {
                const now = new Date();
                const checkIn = new Date(`${now.toDateString()} ${checkInTimeValue}`);
                if(isNaN(checkIn)) return;

                const diff = now - checkIn;
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);

                const el = document.querySelector('.sd-check-info');
                if (el) {
                    el.innerHTML = `
                        <div class="alert alert-info d-flex justify-content-between">
                            <span>Đã làm việc:</span>
                            <span class="badge bg-primary">${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}</span>
                        </div>`;
                }
            };
            update();
            setInterval(update, 1000);
        }

        // ========== INIT ==========
        window.onload = async function() {
            await initCamera();
            await getLocation(); // Không bắt buộc
            await checkAttendanceStatus();

            // ✅ LUÔN ENABLE NÚT NGAY TỪ ĐẦU
            updateButtonsState();
        };

        window.onbeforeunload = function() {
            if (stream) stream.getTracks().forEach(track => track.stop());
        };
    </script>
}