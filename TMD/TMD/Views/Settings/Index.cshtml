@model List<AIHUBOS.Models.SystemSetting>
@{
    ViewData["Title"] = "Cấu Hình Hệ Thống";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/css/setting.css" rel="stylesheet" />

<div class="settings-page">
    <div class="container-fluid px-4">
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h2 class="mb-2">
                        <i class="fas fa-cog text-white"></i>
                        Quản Lý Cấu Hình Hệ Thống
                    </h2>
                    <p class="text-white-50 mb-0">
                        Tùy chỉnh cấu hình lương, chấm công và các thiết lập khác
                    </p>
                </div>
                <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                    <button class="btn btn-custom btn-save-all disabled" id="btnSaveAll" disabled>
                        <i class="fas fa-save"></i> Lưu Thay Đổi
                        <span class="badge bg-white text-success ms-2" id="modifiedCount">0</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="color: var(--primary);">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="text-muted mb-1">Tổng Cấu Hình</div>
                <h3 class="mb-0" style="color: var(--primary);">@Model.Count</h3>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="color: var(--success);">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="text-muted mb-1">Lương</div>
                <h3 class="mb-0" style="color: var(--success);">@Model.Count(s => s.Category == "Salary")</h3>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="color: var(--info);">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="text-muted mb-1">Chấm Công</div>
                <h3 class="mb-0" style="color: var(--info);">@Model.Count(s => s.Category == "Attendance")</h3>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="color: var(--warning);">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="text-muted mb-1">Đang Bật</div>
                <h3 class="mb-0" style="color: var(--warning);">@Model.Count(s => s.IsEnabled)</h3>
            </div>
        </div>

        <div class="save-indicator" id="saveIndicator" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Bạn có thay đổi chưa lưu!</strong>
        </div>

        <div class="tabs-container">
            <ul class="nav nav-tabs nav-tabs-custom" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#salary-tab">
                        <i class="fas fa-money-bill-wave"></i> Lương
                        <span class="badge bg-success ms-1">@Model.Count(s => s.Category == "Salary")</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#attendance-tab">
                        <i class="fas fa-clock"></i> Chấm Công
                        <span class="badge bg-info ms-1">@Model.Count(s => s.Category == "Attendance")</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#layout-tab">
                        <i class="fas fa-code"></i> Layout Editor
                        <span class="badge bg-warning ms-1">2</span>
                    </a>
                </li>
            </ul>

            <div class="tab-content tab-content-custom">
                <div class="tab-pane fade show active" id="salary-tab">
                    <div class="settings-toolbar">
                        <div>
                            <button class="btn btn-custom btn-add" onclick="openCreateModal('Salary')">
                                <i class="fas fa-plus"></i> Thêm Cấu Hình
                            </button>
                            <button class="btn btn-custom btn-trash" onclick="openTrashModal()">
                                <i class="fas fa-trash"></i> Thùng Rác
                                <span class="badge bg-white text-warning ms-1" id="trashCount">0</span>
                            </button>
                        </div>
                        <div>
                            <input type="text" class="form-control-custom" id="searchSalary"
                                   placeholder="🔍 Tìm kiếm cấu hình..."
                                   style="width: 300px;">
                        </div>
                    </div>

                    <div id="salarySettingsList">
                        @if (!Model.Any(s => s.Category == "Salary"))
                        {
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <i class="fas fa-inbox"></i>
                                </div>
                                <h5>Chưa có cấu hình lương nào</h5>
                                <p>Nhấn "Thêm Cấu Hình" để bắt đầu</p>
                            </div>
                        }
                        else
                        {
                            @foreach (var setting in Model.Where(s => s.Category == "Salary").OrderBy(s => s.SettingKey))
                            {
                                <div class="setting-card @(setting.IsEnabled ? "" : "disabled")"
                                     data-key="@setting.SettingKey">
                                    <div class="setting-header">
                                        <div>
                                            <div class="setting-title">
                                                <i class="fas fa-money-bill-wave text-success"></i>
                                                @setting.Description
                                            </div>
                                            <span class="setting-key">@setting.SettingKey</span>
                                        </div>
                                        <div>
                                            <span class="status-badge @(setting.IsEnabled ? "status-enabled" : "status-disabled")">
                                                <i class="fas @(setting.IsEnabled ? "fa-check-circle" : "fa-ban")"></i>
                                                @(setting.IsEnabled ? "BẬT" : "TẮT")
                                            </span>
                                        </div>
                                    </div>

                                    <div class="setting-description">
                                        @if (!string.IsNullOrEmpty(setting.ApplyMethod))
                                        {
                                            <i class="fas fa-info-circle"></i>
                                            <strong>Cách áp dụng:</strong> @GetApplyMethodText(setting.ApplyMethod)
                                        }
                                    </div>

                                    <div class="setting-meta">
                                        <div class="meta-item">
                                            <i class="fas fa-database"></i>
                                            <span class="meta-badge">@setting.DataType</span>
                                        </div>
                                        @if (setting.Unit != null)
                                        {
                                            <div class="meta-item">
                                                <i class="fas fa-tag"></i>
                                                <span class="meta-badge">@setting.Unit</span>
                                            </div>
                                        }
                                        @if (setting.UpdatedAt.HasValue)
                                        {
                                            <div class="meta-item">
                                                <i class="fas fa-clock"></i>
                                                @setting.UpdatedAt.Value.ToString("dd/MM/yyyy HH:mm")
                                            </div>
                                        }
                                    </div>

                                    <div class="input-group-custom">
                                        <input type="@(setting.DataType == "Number" || setting.DataType == "Decimal" ? "number" : "text")"
                                               class="input-custom setting-input"
                                               data-key="@setting.SettingKey"
                                               data-id="@setting.SettingId"
                                               value="@setting.SettingValue"
                                               step="@(setting.DataType == "Decimal" ? "0.01" : "1")"
                                        @(setting.IsEnabled ? "" : "disabled")
                                               placeholder="Nhập giá trị..." />
                                    </div>

                                    <div class="btn-group-actions">
                                        <button class="btn-custom btn-toggle @(setting.IsEnabled ? "enabled" : "disabled")"
                                                onclick="toggleSettingStatus(@setting.SettingId, '@setting.SettingKey')">
                                            <i class="fas @(setting.IsEnabled ? "fa-toggle-on" : "fa-toggle-off")"></i>
                                            @(setting.IsEnabled ? "Đang Bật" : "Đang Tắt")
                                        </button>
                                        <button class="btn-custom btn-edit"
                                                onclick='openEditModal(@setting.SettingId, "@setting.SettingKey", "@setting.SettingValue", "@setting.Description", "@setting.DataType", "@setting.Category", "@setting.ApplyMethod")'>
                                            <i class="fas fa-edit"></i> Sửa
                                        </button>
                                        <button class="btn-custom btn-delete"
                                                onclick="moveToTrash(@setting.SettingId)">
                                            <i class="fas fa-trash"></i> Xóa
                                        </button>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>

                <div class="tab-pane fade" id="attendance-tab">
                    <div class="settings-toolbar">
                        <div>
                            <button class="btn btn-custom btn-add" onclick="openCreateModal('Attendance')">
                                <i class="fas fa-plus"></i> Thêm Cấu Hình
                            </button>
                        </div>
                        <div>
                            <input type="text" class="form-control-custom" id="searchAttendance"
                                   placeholder="🔍 Tìm kiếm cấu hình..."
                                   style="width: 300px;">
                        </div>
                    </div>

                    <div id="attendanceSettingsList">
                        @if (!Model.Any(s => s.Category == "Attendance"))
                        {
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <i class="fas fa-inbox"></i>
                                </div>
                                <h5>Chưa có cấu hình chấm công nào</h5>
                                <p>Nhấn "Thêm Cấu Hình" để bắt đầu</p>
                            </div>
                        }
                        else
                        {
                            @foreach (var setting in Model.Where(s => s.Category == "Attendance").OrderBy(s => s.SettingKey))
                            {
                                <div class="setting-card @(setting.IsEnabled ? "" : "disabled")"
                                     data-key="@setting.SettingKey">
                                    <div class="setting-header">
                                        <div>
                                            <div class="setting-title">
                                                <i class="fas fa-clock text-info"></i>
                                                @setting.Description
                                            </div>
                                            <span class="setting-key">@setting.SettingKey</span>
                                        </div>
                                        <div>
                                            <span class="status-badge @(setting.IsEnabled ? "status-enabled" : "status-disabled")">
                                                <i class="fas @(setting.IsEnabled ? "fa-check-circle" : "fa-ban")"></i>
                                                @(setting.IsEnabled ? "BẬT" : "TẮT")
                                            </span>
                                        </div>
                                    </div>

                                    <div class="setting-meta">
                                        <div class="meta-item">
                                            <i class="fas fa-database"></i>
                                            <span class="meta-badge">@setting.DataType</span>
                                        </div>
                                        @if (setting.UpdatedAt.HasValue)
                                        {
                                            <div class="meta-item">
                                                <i class="fas fa-clock"></i>
                                                @setting.UpdatedAt.Value.ToString("dd/MM/yyyy HH:mm")
                                            </div>
                                        }
                                    </div>

                                    <div class="input-group-custom">
                                        @if (setting.SettingKey.Contains("TIME"))
                                        {
                                            <input type="time" class="input-custom setting-input"
                                                   data-key="@setting.SettingKey"
                                                   data-id="@setting.SettingId"
                                                   value="@setting.SettingValue"
                                            @(setting.IsEnabled ? "" : "disabled") />
                                        }
                                        else
                                        {
                                            <input type="@(setting.DataType == "Number" ? "number" : "text")"
                                                   class="input-custom setting-input"
                                                   data-key="@setting.SettingKey"
                                                   data-id="@setting.SettingId"
                                                   value="@setting.SettingValue"
                                            @(setting.IsEnabled ? "" : "disabled")
                                                   placeholder="Nhập giá trị..." />
                                        }
                                    </div>

                                    <div class="btn-group-actions">
                                        <button class="btn-custom btn-toggle @(setting.IsEnabled ? "enabled" : "disabled")"
                                                onclick="toggleSettingStatus(@setting.SettingId, '@setting.SettingKey')">
                                            <i class="fas @(setting.IsEnabled ? "fa-toggle-on" : "fa-toggle-off")"></i>
                                            @(setting.IsEnabled ? "Đang Bật" : "Đang Tắt")
                                        </button>
                                        <button class="btn-custom btn-edit"
                                                onclick='openEditModal(@setting.SettingId, "@setting.SettingKey", "@setting.SettingValue", "@setting.Description", "@setting.DataType", "@setting.Category", "")'>
                                            <i class="fas fa-edit"></i> Sửa
                                        </button>
                                        <button class="btn-custom btn-delete"
                                                onclick="moveToTrash(@setting.SettingId)">
                                            <i class="fas fa-trash"></i> Xóa
                                        </button>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>

                <div class="tab-pane fade" id="layout-tab">
                    <div class="settings-toolbar">
                        <div>
                            <button class="btn btn-custom btn-edit" onclick="loadLayout('admin')">
                                <i class="fas fa-desktop"></i> Load Admin Layout
                            </button>
                            <button class="btn btn-custom btn-edit" onclick="loadLayout('staff')">
                                <i class="fas fa-user"></i> Load Staff Layout
                            </button>
                        </div>
                        <div>
                            <button class="btn btn-custom btn-add" onclick="saveLayout()">
                                <i class="fas fa-save"></i> Lưu Layout
                            </button>
                            <button class="btn btn-custom btn-trash" onclick="openBackupModal()">
                                <i class="fas fa-history"></i> Backup Files
                            </button>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="form-group-custom">
                                <label class="form-label-custom">
                                    <i class="fas fa-file-code"></i>
                                    <span id="currentLayoutName">Chọn layout để chỉnh sửa</span>
                                </label>
                                <textarea id="layoutEditor" class="form-control-custom"
                                          rows="25"
                                          style="font-family: 'Courier New', monospace; font-size: 14px;"
                                          placeholder="Nhấn Load Admin Layout hoặc Load Staff Layout để bắt đầu..."></textarea>
                                <div class="form-help-text mt-2">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Lưu ý:</strong> Backup tự động được tạo trước khi lưu
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="layoutInfo" class="alert alert-info mt-3" style="display: none;">
                        <i class="fas fa-info-circle"></i>
                        <strong>File:</strong> <span id="fileName"></span> |
                        <strong>Sửa lần cuối:</strong> <span id="lastModified"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    string GetApplyMethodText(string method)
    {
        return method switch
        {
            "BASE" => "Lương cơ bản",
            "FIXED_MONTHLY" => "Cộng cố định mỗi tháng",
            "PER_WORKDAY" => "Cộng theo số ngày làm việc",
            "MULTIPLIER" => "Hệ số nhân",
            "PER_LATE_INSTANCE" => "Trừ theo số lần đi trễ",
            "PERCENT_DEDUCTION" => "Trừ theo phần trăm",
            "CONDITIONAL" => "Theo điều kiện đặc biệt",
            _ => method ?? "Không xác định"
        };
    }
}

<div class="modal fade modal-custom" id="createModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> Thêm Cấu Hình Mới
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createForm">
                    <input type="hidden" id="createCategoryHidden">

                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group-custom">
                                <label class="form-label-custom">
                                    <i class="fas fa-file-signature"></i>
                                    Tên Cấu Hình <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control-custom" id="createDescription"
                                       placeholder="VD: Phụ cấp ăn trưa"
                                       onblur="autoGenerateKey()">
                                <div class="form-help-text">
                                    <i class="fas fa-info-circle"></i> Nhập tên mô tả cho cấu hình
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group-custom">
                                <label class="form-label-custom">
                                    <i class="fas fa-layer-group"></i> Danh Mục
                                </label>
                                <select class="form-control-custom" id="createCategory">
                                    <option value="Salary">💰 Lương</option>
                                    <option value="Attendance">🕐 Chấm Công</option>
                                    <option value="General">⚙️ Chung</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group-custom">
                        <label class="form-label-custom">
                            <i class="fas fa-key"></i> Key (Tự Động Tạo)
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control-custom" id="createKey"
                                   readonly style="background-color: #f3f4f6; font-family: 'Courier New', monospace; font-weight: bold;">
                            <button class="btn btn-custom btn-edit" type="button" onclick="autoGenerateKey()" style="margin-left: 10px;">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>
                        <div class="form-help-text" id="keyStatus"></div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group-custom">
                                <label class="form-label-custom">
                                    <i class="fas fa-money-bill"></i>
                                    Giá Trị <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control-custom" id="createValue"
                                       placeholder="VD: 500000" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group-custom">
                                <label class="form-label-custom">
                                    <i class="fas fa-database"></i> Loại Dữ Liệu
                                </label>
                                <select class="form-control-custom" id="createDataType">
                                    <option value="String">Text</option>
                                    <option value="Number">Số Nguyên</option>
                                    <option value="Decimal" selected>Số Thập Phân</option>
                                    <option value="Boolean">Boolean</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group-custom" id="applyMethodGroup">
                        <label class="form-label-custom">
                            <i class="fas fa-cogs"></i> Cách Áp Dụng (Cho Lương)
                        </label>

                        <div class="apply-method-selector">
                            <label class="method-option">
                                <input type="radio" name="applyMethod" value="FIXED_MONTHLY">
                                <div>
                                    <div class="method-title">💰 Cố định mỗi tháng</div>
                                    <div class="method-description">Cộng số tiền cố định vào lương mỗi tháng (VD: Phụ cấp đi lại 300,000₫/tháng)</div>
                                </div>
                            </label>

                            <label class="method-option">
                                <input type="radio" name="applyMethod" value="PER_WORKDAY">
                                <div>
                                    <div class="method-title">📅 Theo ngày làm việc</div>
                                    <div class="method-description">Cộng theo số ngày đi làm thực tế (VD: Phụ cấp ăn trưa 30,000₫ × số ngày)</div>
                                </div>
                            </label>

                            <label class="method-option">
                                <input type="radio" name="applyMethod" value="MULTIPLIER">
                                <div>
                                    <div class="method-title">✖️ Hệ số nhân</div>
                                    <div class="method-description">Nhân với lương cơ bản (VD: Thưởng 10% = nhập 10)</div>
                                </div>
                            </label>

                            <label class="method-option">
                                <input type="radio" name="applyMethod" value="PER_LATE_INSTANCE">
                                <div>
                                    <div class="method-title">⚠️ Trừ theo lần đi trễ</div>
                                    <div class="method-description">Trừ tiền theo số lần đi muộn (VD: 20,000₫ × số lần trễ)</div>
                                </div>
                            </label>

                            <label class="method-option">
                                <input type="radio" name="applyMethod" value="PERCENT_DEDUCTION">
                                <div>
                                    <div class="method-title">📉 Trừ theo phần trăm</div>
                                    <div class="method-description">Trừ % lương cơ bản (VD: Bảo hiểm 8%)</div>
                                </div>
                            </label>

                            <label class="method-option">
                                <input type="radio" name="applyMethod" value="CONDITIONAL">
                                <div>
                                    <div class="method-title">🎯 Theo điều kiện</div>
                                    <div class="method-description">Áp dụng khi đủ điều kiện (VD: Thưởng chuyên cần khi đủ 26 ngày)</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="form-group-custom" id="conditionalDescGroup" style="display: none;">
                        <label class="form-label-custom">
                            <i class="fas fa-file-alt"></i> Mô tả điều kiện
                        </label>
                        <textarea class="form-control-custom" id="createConditionalDesc" rows="3"
                                  placeholder="VD: Áp dụng khi đi làm đủ 26 ngày và không đi trễ lần nào"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-custom btn-add" onclick="createSetting()">
                    <i class="fas fa-save"></i> Tạo Cấu Hình
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade modal-custom" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Chỉnh Sửa Cấu Hình
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editId">

                    <div class="form-group-custom">
                        <label class="form-label-custom">
                            <i class="fas fa-key"></i> Setting Key <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control-custom" id="editKey" required>
                    </div>

                    <div class="form-group-custom">
                        <label class="form-label-custom">
                            <i class="fas fa-file-signature"></i> Tên Cấu Hình
                        </label>
                        <input type="text" class="form-control-custom" id="editDescription">
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group-custom">
                                <label class="form-label-custom">
                                    <i class="fas fa-money-bill"></i> Giá Trị
                                </label>
                                <input type="text" class="form-control-custom" id="editValue">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group-custom">
                                <label class="form-label-custom">
                                    <i class="fas fa-database"></i> Loại Dữ Liệu
                                </label>
                                <select class="form-control-custom" id="editDataType">
                                    <option value="String">String</option>
                                    <option value="Number">Number</option>
                                    <option value="Decimal">Decimal</option>
                                    <option value="Boolean">Boolean</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group-custom">
                        <label class="form-label-custom">
                            <i class="fas fa-layer-group"></i> Danh Mục
                        </label>
                        <select class="form-control-custom" id="editCategory">
                            <option value="Salary">Salary</option>
                            <option value="Attendance">Attendance</option>
                            <option value="General">General</option>
                        </select>
                    </div>

                    <div class="form-group-custom">
                        <label class="form-label-custom">
                            <i class="fas fa-cogs"></i> Cách Áp Dụng
                        </label>
                        <select class="form-control-custom" id="editApplyMethod">
                            <option value="">-- Không áp dụng --</option>
                            <option value="BASE">BASE - Lương cơ bản</option>
                            <option value="FIXED_MONTHLY">FIXED_MONTHLY - Cố định mỗi tháng</option>
                            <option value="PER_WORKDAY">PER_WORKDAY - Theo ngày làm việc</option>
                            <option value="MULTIPLIER">MULTIPLIER - Hệ số nhân</option>
                            <option value="PER_LATE_INSTANCE">PER_LATE_INSTANCE - Trừ theo lần trễ</option>
                            <option value="PERCENT_DEDUCTION">PERCENT_DEDUCTION - Trừ theo %</option>
                            <option value="CONDITIONAL">CONDITIONAL - Theo điều kiện</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-custom btn-edit" onclick="editSetting()">
                    <i class="fas fa-save"></i> Cập Nhật
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade modal-custom" id="trashModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--warning);">
                <h5 class="modal-title">
                    <i class="fas fa-trash"></i> Thùng Rác
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead style="background: #f9fafb;">
                            <tr>
                                <th>Key</th>
                                <th>Tên</th>
                                <th>Giá Trị</th>
                                <th>Danh Mục</th>
                                <th width="200">Thao Tác</th>
                            </tr>
                        </thead>
                        <tbody id="trashTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade modal-custom" id="backupModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--info);">
                <h5 class="modal-title">
                    <i class="fas fa-history"></i> Backup Files
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead style="background: #f9fafb;">
                            <tr>
                                <th>File Name</th>
                                <th>Size</th>
                                <th>Created</th>
                                <th width="200">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="backupTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ========== GLOBAL VARIABLES ==========
        let stream = null;
        let capturedBlob = null;
        let uploadedFile = null;
        let latitude = null;
        let longitude = null;
        let currentAddress = '';
        let isGettingLocation = false;
        let isLocationLocked = false; // Fix lỗi GPS biến mất

        // Lấy giờ chuẩn từ Server (ViewBag)
        const STANDARD_START_TIME = "@ViewBag.StandardStartTime"; // Ví dụ: "08:00"
        const STANDARD_END_TIME = "@ViewBag.StandardEndTime";     // Ví dụ: "17:00"

        // ========== TIME UPDATE ==========
        function updateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('vi-VN', options);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('vi-VN');
        }
        setInterval(updateTime, 1000);
        updateTime();

        // ========== PHOTO MODE SWITCH ==========
        document.querySelectorAll('input[name="photoMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'camera') {
                    document.getElementById('cameraMode').style.display = 'block';
                    document.getElementById('uploadMode').style.display = 'none';
                    uploadedFile = null;
                    initCamera();
                } else {
                    document.getElementById('cameraMode').style.display = 'none';
                    document.getElementById('uploadMode').style.display = 'block';
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        stream = null;
                    }
                }
                updateButtonsState();
            });
        });

        // ========== CAMERA INIT & CAPTURE (FIX MOBILE IMAGE) ==========
        async function initCamera() {
            try {
                // Ưu tiên camera trước (user) trên điện thoại
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                document.getElementById('video').srcObject = stream;
            } catch (err) {
                console.error('Camera error:', err);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi Camera',
                    text: 'Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập hoặc chuyển sang chế độ tải ảnh.',
                    confirmButtonText: 'Chuyển sang tải ảnh'
                }).then(() => {
                    document.getElementById('modeUpload').checked = true;
                    document.getElementById('modeUpload').dispatchEvent(new Event('change'));
                });
            }
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const capturedImage = document.getElementById('capturedImage');

            // FIX ẢNH ĐIỆN THOẠI: Resize ảnh về kích thước hợp lý (Max width 1024px)
            // Giúp giảm dung lượng file upload và hiển thị nhanh hơn
            const MAX_WIDTH = 1024;
            let width = video.videoWidth;
            let height = video.videoHeight;

            if (width > MAX_WIDTH) {
                height *= MAX_WIDTH / width;
                width = MAX_WIDTH;
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, width, height);

            // Chuyển sang Blob (JPEG quality 0.8)
            canvas.toBlob(blob => {
                capturedBlob = blob;
                capturedImage.src = URL.createObjectURL(blob);
                capturedImage.style.display = 'block';
                video.style.display = 'none';
                document.getElementById('btnCapture').style.display = 'none';
                document.getElementById('btnRetake').style.display = 'inline-block';
                updateButtonsState();
            }, 'image/jpeg', 0.8);
        }

        function retakePhoto() {
            document.getElementById('video').style.display = 'block';
            document.getElementById('capturedImage').style.display = 'none';
            document.getElementById('btnCapture').style.display = 'inline-block';
            document.getElementById('btnRetake').style.display = 'none';
            capturedBlob = null;
            updateButtonsState();
        }

        // ========== LOCATION (FIX GPS BIẾN MẤT) ==========
        async function getLocation(isRetry = false) {
            // Nếu đã có vị trí và không phải là retry/refresh, không làm gì cả để tránh nhấp nháy
            if (isLocationLocked && !isRetry) return;
            if (isGettingLocation) return;

            if (!navigator.geolocation) {
                showLocationError('Trình duyệt không hỗ trợ GPS');
                return;
            }

            isGettingLocation = true;

            // Chỉ hiện loading nếu chưa có vị trí hoặc đang retry
            document.getElementById('locationInfo').innerHTML = `
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        <div><strong>Đang lấy vị trí GPS...</strong></div>
                    </div>
                </div>
            `;

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });

                latitude = position.coords.latitude;
                longitude = position.coords.longitude;
                const accuracy = position.coords.accuracy;

                // Gọi API lấy địa chỉ
                await getAddressFromServer(latitude, longitude, accuracy);

                isGettingLocation = false;
                isLocationLocked = true; // Khóa vị trí để không bị loading lại

            } catch (error) {
                console.error('Location error:', error);
                isGettingLocation = false;
                isLocationLocked = false;

                let msg = 'Không thể lấy vị trí.';
                if (error.code === 1) msg = 'Vui lòng cho phép truy cập vị trí.';
                else if (error.code === 2) msg = 'Vị trí không khả dụng. Kiểm tra GPS.';
                else if (error.code === 3) msg = 'Hết thời gian chờ lấy vị trí.';

                showLocationError(msg, true);
            }
        }

        function showLocationError(msg, showRetry = false) {
            document.getElementById('locationInfo').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> ${msg}
                    ${showRetry ? `<button class="btn btn-sm btn-outline-warning w-100 mt-2" onclick="getLocation(true)">Thử lại</button>` : ''}
                </div>
            `;
        }

        async function getAddressFromServer(lat, lng, accuracy) {
            try {
                const response = await fetch(`/Staff/GetAddressFromCoordinatesApi?latitude=${lat}&longitude=${lng}`);
                if (response.ok) {
                    const data = await response.json();
                    currentAddress = (data.success && data.address) ? data.address : `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                } else {
                    currentAddress = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                }
            } catch (err) {
                currentAddress = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
            displayLocationSuccess(accuracy);
        }

        function displayLocationSuccess(accuracy) {
            // Fix: Hiển thị ổn định
            document.getElementById('locationInfo').innerHTML = `
                <div class="alert alert-success">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong><i class="fas fa-check-circle"></i> Đã lấy vị trí</strong>
                            <p class="mb-0 mt-1 small"><i class="fas fa-map-marker-alt text-danger"></i> ${currentAddress}</p>
                            <small class="text-muted">Độ chính xác: ±${Math.round(accuracy)}m</small>
                        </div>
                        <button class="btn btn-sm btn-light text-primary" onclick="getLocation(true)" title="Làm mới vị trí">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            `;
            updateButtonsState();
        }

        // ========== FILE UPLOAD ==========
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedFile = file;
                    document.getElementById('uploadPlaceholder').style.display = 'none';
                    document.getElementById('uploadedImage').src = e.target.result;
                    document.getElementById('uploadedImage').style.display = 'block';
                    document.getElementById('btnClearUpload').style.display = 'inline-block';
                    updateButtonsState();
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('uploadPlaceholder').addEventListener('click', () => document.getElementById('fileInput').click());

        function clearUploadedImage() {
            uploadedFile = null;
            document.getElementById('uploadedImage').style.display = 'none';
            document.getElementById('uploadPlaceholder').style.display = 'flex';
            document.getElementById('btnClearUpload').style.display = 'none';
            document.getElementById('fileInput').value = '';
            updateButtonsState();
        }

        function updateButtonsState() {
            const hasPhoto = capturedBlob !== null || uploadedFile !== null;
            const hasLocation = latitude !== null && longitude !== null;

            const btnCheckIn = document.getElementById('btnCheckIn');
            const btnCheckOut = document.getElementById('btnCheckOut');

            if (btnCheckIn) btnCheckIn.disabled = !(hasPhoto && hasLocation);
            if (btnCheckOut) btnCheckOut.disabled = !(hasPhoto && hasLocation);
        }

        // ========== CHECK IN/OUT POPUP LOGIC ==========

        function getCurrentTimeStr() {
            const now = new Date();
            return now.toTimeString().split(' ')[0].substring(0, 5); // HH:mm
        }

        async function checkIn() {
            const photoFile = capturedBlob || uploadedFile;
            if (!photoFile || !latitude || !longitude) {
                Swal.fire('Thiếu thông tin', 'Vui lòng chụp ảnh và đợi lấy vị trí GPS', 'warning');
                return;
            }

            // Tính toán trạng thái hiển thị trên popup
            const nowStr = getCurrentTimeStr(); // HH:mm hiện tại
            let statusHtml = '';
            if (nowStr > STANDARD_START_TIME) {
                statusHtml = `<span class="badge bg-danger fs-6">Đi trễ</span> <small class="text-muted">(Chuẩn: ${STANDARD_START_TIME})</small>`;
            } else {
                statusHtml = `<span class="badge bg-success fs-6">Đúng giờ</span>`;
            }

            // POPUP XÁC NHẬN CHECK-IN
            const result = await Swal.fire({
                title: 'Xác nhận Check-in',
                html: `
                    <div class="text-start p-3 bg-light rounded">
                        <p class="mb-2"><i class="fas fa-clock text-primary me-2"></i><strong>Thời gian:</strong> ${nowStr}</p>
                        <p class="mb-2"><i class="fas fa-info-circle text-info me-2"></i><strong>Trạng thái:</strong> ${statusHtml}</p>
                        <p class="mb-0"><i class="fas fa-map-marker-alt text-danger me-2"></i><strong>Vị trí:</strong><br>${currentAddress}</p>
                    </div>
                    <div class="mt-3 text-center">
                        <img src="${photoFile === capturedBlob ? URL.createObjectURL(capturedBlob) : document.getElementById('uploadedImage').src}"
                             style="max-height: 150px; border-radius: 8px; border: 1px solid #ddd;">
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-check"></i> Xác nhận Check-in',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#198754',
                cancelButtonColor: '#6c757d',
                reverseButtons: true
            });

            if (!result.isConfirmed) return;

            // Gửi dữ liệu
            const formData = new FormData();
            formData.append('Photo', photoFile, 'checkin.jpg');
            formData.append('Latitude', latitude);
            formData.append('Longitude', longitude);
            formData.append('Address', currentAddress);
            formData.append('Notes', document.getElementById('attendanceNotes').value);

            Swal.fire({ title: 'Đang Check-in...', text: 'Vui lòng đợi giây lát', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            try {
                const response = await fetch('/Staff/CheckIn', { method: 'POST', body: formData });
                const data = await response.json();
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Check-in thành công!',
                        html: data.message.replace(/\n/g, '<br>'),
                        confirmButtonText: 'Tuyệt vời'
                    }).then(() => location.reload());
                } else {
                    Swal.fire('Lỗi', data.message, 'error');
                }
            } catch (err) {
                Swal.fire('Lỗi kết nối', err.message, 'error');
            }
        }

        async function checkOut() {
            const photoFile = capturedBlob || uploadedFile;
            if (!photoFile || !latitude || !longitude) {
                Swal.fire('Thiếu thông tin', 'Vui lòng chụp ảnh và đợi lấy vị trí GPS', 'warning');
                return;
            }

            // Tính toán trạng thái hiển thị trên popup
            const nowStr = getCurrentTimeStr();
            let statusHtml = '';
            if (nowStr < STANDARD_END_TIME) {
                statusHtml = `<span class="badge bg-warning text-dark fs-6">Về sớm</span> <small class="text-muted">(Chuẩn: ${STANDARD_END_TIME})</small>`;
            } else {
                statusHtml = `<span class="badge bg-success fs-6">Đúng giờ</span>`;
            }

            // POPUP XÁC NHẬN CHECK-OUT
            const result = await Swal.fire({
                title: 'Xác nhận Check-out',
                html: `
                    <div class="text-start p-3 bg-light rounded">
                        <p class="mb-2"><i class="fas fa-clock text-primary me-2"></i><strong>Thời gian:</strong> ${nowStr}</p>
                        <p class="mb-2"><i class="fas fa-info-circle text-info me-2"></i><strong>Trạng thái:</strong> ${statusHtml}</p>
                        <p class="mb-0"><i class="fas fa-map-marker-alt text-danger me-2"></i><strong>Vị trí:</strong><br>${currentAddress}</p>
                    </div>
                    <div class="mt-3 text-center">
                        <img src="${photoFile === capturedBlob ? URL.createObjectURL(capturedBlob) : document.getElementById('uploadedImage').src}"
                             style="max-height: 150px; border-radius: 8px; border: 1px solid #ddd;">
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-sign-out-alt"></i> Xác nhận Check-out',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                reverseButtons: true
            });

            if (!result.isConfirmed) return;

            const formData = new FormData();
            formData.append('Photo', photoFile, 'checkout.jpg');
            formData.append('Latitude', latitude);
            formData.append('Longitude', longitude);
            formData.append('Address', currentAddress);
            formData.append('Notes', document.getElementById('attendanceNotes').value);

            Swal.fire({ title: 'Đang Check-out...', text: 'Đang tổng hợp công...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            try {
                const response = await fetch('/Staff/CheckOut', { method: 'POST', body: formData });
                const data = await response.json();
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Check-out thành công!',
                        html: data.message.replace(/\n/g, '<br>'),
                        confirmButtonText: 'Hẹn gặp lại'
                    }).then(() => location.reload());
                } else {
                    Swal.fire('Lỗi', data.message, 'error');
                }
            } catch (err) {
                Swal.fire('Lỗi kết nối', err.message, 'error');
            }
        }

        // ========== INIT ==========
        // Giữ nguyên các hàm checkAttendanceStatus, loadMyTasks, renderTasks...
        // ... (Copy lại các hàm loadMyTasks, renderTasks, checkAttendanceStatus từ code cũ của bạn vào đây) ...

        async function checkAttendanceStatus() {
             try {
                const response = await fetch('/Staff/GetTodayAttendance');
                const data = await response.json();

                const statusDiv = document.getElementById('attendanceStatus');
                const checkInSection = document.getElementById('checkInSection');
                const checkOutSection = document.getElementById('checkOutSection');
                const completedSection = document.getElementById('completedSection');

                if (data.hasCheckedIn) {
                    statusDiv.style.display = 'none';
                    if (data.hasCheckedOut) {
                        checkInSection.style.display = 'none';
                        checkOutSection.style.display = 'none';
                        completedSection.style.display = 'block';
                        completedSection.innerHTML = `
                            <div class="alert alert-success">
                                <h5><i class="fas fa-check-double"></i> Đã hoàn tất!</h5>
                                <hr>
                                <div class="row text-center">
                                    <div class="col-6">
                                        <small>Check-in</small>
                                        <br><strong>${data.checkInTime}</strong>
                                    </div>
                                    <div class="col-6">
                                        <small>Check-out</small>
                                        <br><strong>${data.checkOutTime}</strong>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        checkInSection.style.display = 'none';
                        checkOutSection.style.display = 'block';
                        checkInTimeValue = data.checkInTime;
                        updateWorkingHours();
                    }
                } else {
                    statusDiv.style.display = 'none';
                    checkInSection.style.display = 'block';
                }
                updateButtonsState();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function updateWorkingHours() {
            if (!checkInTimeValue) return;
            const updateHours = () => {
                const now = new Date();
                const checkIn = new Date(`${now.toDateString()} ${checkInTimeValue}`);
                const diff = now - checkIn;
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                const el = document.querySelector('.sd-check-info');
                if (el) {
                    el.innerHTML = `
                        <div class="alert alert-info">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-sign-in-alt me-2"></i>
                                    <strong>Đã check-in:</strong> <code>${checkInTimeValue}</code>
                                </div>
                                <div class="badge bg-primary fs-6">
                                    <i class="fas fa-clock me-1"></i>
                                    ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}
                                </div>
                            </div>
                        </div>
                    `;
                }
            };
            updateHours();
            setInterval(updateHours, 1000);
        }

        // Tải công việc và init
        window.onload = async function() {
            console.log('🚀 Initializing Staff Dashboard...');
            await initCamera();
            await getLocation();
            await checkAttendanceStatus();
            // Hàm loadMyTasks bạn giữ nguyên từ code cũ
            if (typeof loadMyTasks === "function") await loadMyTasks();
            console.log('✅ Dashboard initialized');
        };

        window.onbeforeunload = function() {
            if (stream) stream.getTracks().forEach(track => track.stop());
        };
    </script>
}