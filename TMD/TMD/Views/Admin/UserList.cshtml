@model TMD.ViewModels.UserListViewModel
@{
    ViewData["Title"] = "Quản lý người dùng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/css/user-management.css" rel="stylesheet" />

<div class="um-container">
    <header class="um-page-header">
        <div class="um-d-flex um-justify-between um-align-center">
            <div>
                <h2 class="um-page-title"><i class="fas fa-users"></i> Quản lý người dùng</h2>
                <p class="um-page-subtitle">Danh sách tất cả người dùng và công việc của họ</p>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <a href="/Admin/UserTrash" class="um-btn-create" style="background: #ef4444;">
                    <i class="fas fa-trash-alt"></i> Thùng rác
                </a>
                <a href="/Account/Register" class="um-btn-create">
                    <i class="fas fa-user-plus"></i> Tạo người dùng mới
                </a>
                <a href="/Admin/ImportUsers" class="um-btn-create" style="background: #10b981;">
                    <i class="fas fa-file-excel"></i> Import Excel
                </a>
                <button id="btnExportExcel" class="um-btn-create" style="background: #0891b2;">
                    <i class="fas fa-file-download"></i> Xuất Excel
                </button>
            </div>
        </div>
    </header>

    <section class="um-stats-grid">
        <div class="um-stats-card um-stats-primary">
            <div class="um-stats-icon"><i class="fas fa-users"></i></div>
            <div class="um-stats-content">
                <div class="um-stats-label">Tổng người dùng</div>
                <div class="um-stats-value">@ViewBag.TotalUsers</div>
            </div>
        </div>

        <div class="um-stats-card um-stats-success">
            <div class="um-stats-icon"><i class="fas fa-user-check"></i></div>
            <div class="um-stats-content">
                <div class="um-stats-label">Đang hoạt động</div>
                <div class="um-stats-value">@ViewBag.ActiveUsers</div>
            </div>
        </div>

        <div class="um-stats-card um-stats-warning">
            <div class="um-stats-icon"><i class="fas fa-crown"></i></div>
            <div class="um-stats-content">
                <div class="um-stats-label">Vô hiệu hóa</div>
                <div class="um-stats-value">0</div>
            </div>
        </div>

        <div class="um-stats-card um-stats-info">
            <div class="um-stats-icon"><i class="fas fa-building"></i></div>
            <div class="um-stats-content">
                <div class="um-stats-label">Phòng ban</div>
                <div class="um-stats-value">@ViewBag.TotalDepartments</div>
            </div>
        </div>
    </section>

    <section class="um-card um-mb-4">
        <div class="um-filters-header">
            <h6><i class="fas fa-filter"></i> Bộ lọc và tìm kiếm</h6>
        </div>

        <div class="um-card-body">
            <form method="get" action="@Url.Action("UserList")" id="filterForm">
                <div class="um-row">
                    <div class="um-col-4">
                        <label class="um-form-label"><i class="fas fa-search"></i> Tìm kiếm</label>
                        <div class="um-search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" name="search" id="searchInput"
                                   class="um-form-control"
                                   placeholder="Tên, username, email, SĐT..."
                                   value="@Model.Search" />
                        </div>
                    </div>

                    <div class="um-col-2">
                        <label class="um-form-label"><i class="fas fa-building"></i> Phòng ban</label>
                        <select name="departmentId" id="deptFilter" class="um-form-control" onchange="document.getElementById('filterForm').submit()">
                            <option value="">Tất cả phòng ban</option>
                            @{
                                var depts = Model.Departments ?? new List<TMD.Models.Department>();
                                foreach (var dept in depts)
                                {
                                    var isSelected = Model.DepartmentId == dept.DepartmentId;
                                    <option value="@dept.DepartmentId" selected="@isSelected">@dept.DepartmentName</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="um-col-2">
                        <label class="um-form-label"><i class="fas fa-user-tag"></i> Vai trò</label>
                        <select name="roleName" id="roleFilter" class="um-form-control" onchange="document.getElementById('filterForm').submit()">
                            <option value="">Tất cả vai trò</option>
                            @if (Model.Roles != null && Model.Roles.Any())
                            {
                                foreach (var r in Model.Roles)
                                {
                                    var isSelected = Model.RoleName == r.RoleName;
                                    <option value="@r.RoleName" selected="@isSelected">@r.RoleName</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="um-col-4 um-flex-end">
                        <a href="@Url.Action("UserList")" id="resetFilters" class="um-btn um-btn-secondary">
                            <i class="fas fa-redo"></i> Xóa bộ lọc
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </section>

    <section class="um-card">
        <div class="um-card-header">
            <h5 class="um-mb-0">
                <i class="fas fa-table"></i> Danh sách người dùng
                (<span>@Model.Users.Count</span>/<span>@Model.TotalCount</span>)
            </h5>
        </div>

        <div class="um-card-body-table">
            <div class="um-table-wrapper">
                <table class="um-table" id="userTable">
                    <thead>
                        <tr>
                            <th width="5%">STT</th>
                            <th width="20%">Người dùng</th>
                            <th width="12%">Username</th>
                            <th width="13%">Email</th>
                            <th width="12%">Phòng ban</th>
                            <th width="10%">Vai trò</th>
                            <th width="10%">Trạng thái</th>
                            <th width="10%">Đăng nhập cuối</th>
                            <th width="13%">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Users != null && Model.Users.Any())
                        {
                            int itemIndex = (Model.Page - 1) * Model.PageSize + 1;
                            foreach (var user in Model.Users)
                            {
                                <tr>
                                    <td class="um-text-center um-fw-bold">@itemIndex</td>
                                    <td>
                                        <div class="um-user-info">
                                            <div class="um-user-avatar">
                                                @if (!string.IsNullOrEmpty(user.Avatar))
                                                {
                                                    <img src="@user.Avatar" alt="@user.FullName" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                                    <span style="display:none;">@(user.FullName?.Substring(0, 1).ToUpper() ?? "U")</span>
                                                }
                                                else
                                                {
                                                    <span>@(user.FullName != null ? user.FullName.Substring(0, 1).ToUpper() : "U")</span>
                                                }
                                            </div>
                                            <div class="um-user-details">
                                                <div class="um-user-name">@user.FullName</div>
                                                <small class="um-text-muted"><i class="fas fa-phone-alt um-me-1"></i>@(user.PhoneNumber ?? "N/A")</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td><span class="um-username-badge">@@@user.Username</span></td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(user.Email))
                                        {
                                            <span class="um-email"><i class="fas fa-envelope"></i>@user.Email</span>
                                        }
                                        else
                                        {
                                            <span class="um-text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (user.Department != null)
                                        {
                                            <span class="um-badge um-badge-info"><i class="fas fa-building um-me-1"></i>@user.Department.DepartmentName</span>
                                        }
                                        else
                                        {
                                            <span class="um-text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(user.Role?.RoleName))
                                        {
                                            <span class="um-badge @(user.Role.RoleName == "Admin" ? "um-badge-admin" : "um-badge-secondary")">
                                                <i class="fas fa-user um-me-1"></i> @user.Role.RoleName
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="um-badge um-badge-secondary">N/A</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="um-badge um-badge-success"><i class="fas fa-check-circle um-me-1"></i> Hoạt động</span>
                                    </td>
                                    <td>
                                        @if (user.LastLoginAt.HasValue)
                                        {
                                            <div class="um-last-login"><i class="far fa-clock"></i><small>@user.LastLoginAt.Value.ToString("dd/MM/yyyy HH:mm")</small></div>
                                        }
                                        else
                                        {
                                            <span class="um-text-muted"><small>Chưa đăng nhập</small></span>
                                        }
                                    </td>
                                    <td>
                                        <div class="um-action-buttons">
                                            <a href="/Admin/EditUser/@user.UserId" class="um-action-btn" title="Chỉnh sửa"><i class="fas fa-edit"></i></a>
                                            <button class="um-action-btn um-action-view" data-id="@user.UserId" title="Xem chi tiết"><i class="fas fa-eye"></i></button>
                                            <button class="um-action-btn um-action-delete"
                                                    onclick="moveUserToTrash(@user.UserId, '@Html.Raw(user.FullName.Replace("'", "\\'"))')"
                                                    title="Xóa">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                            <a href="/Admin/ResetUserPassword/@user.UserId" class="um-action-btn" title="Reset mật khẩu"><i class="fas fa-key"></i></a>
                                        </div>
                                    </td>
                                </tr>
                                itemIndex++;
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="9" class="um-text-center" style="padding: 20px;">
                                    <div class="text-muted">Không tìm thấy dữ liệu phù hợp</div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        @if (Model.TotalCount > 0)
        {
            <footer class="um-card-footer">
                <nav class="um-pagination" aria-label="User list pagination">
                    <ul class="pagination">
                        @{
                            var totalPages = (int)Math.Ceiling((decimal)Model.TotalCount / Model.PageSize);
                            int startPage = Math.Max(1, Model.Page - 2);
                            int endPage = Math.Min(totalPages, Model.Page + 2);
                        }

                        <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("UserList", new { page = 1, pageSize = Model.PageSize, search = Model.Search, roleName = Model.RoleName, departmentId = Model.DepartmentId })"><i class="fas fa-angle-double-left"></i></a>
                        </li>

                        <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("UserList", new { page = Model.Page - 1, pageSize = Model.PageSize, search = Model.Search, roleName = Model.RoleName, departmentId = Model.DepartmentId })"><i class="fas fa-angle-left"></i></a>
                        </li>

                        @for (int p = startPage; p <= endPage; p++)
                        {
                            <li class="page-item @(p == Model.Page ? "active" : "")">
                                <a class="page-link" href="@Url.Action("UserList", new { page = p, pageSize = Model.PageSize, search = Model.Search, roleName = Model.RoleName, departmentId = Model.DepartmentId })">@p</a>
                            </li>
                        }

                        <li class="page-item @(Model.Page >= totalPages ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("UserList", new { page = Model.Page + 1, pageSize = Model.PageSize, search = Model.Search, roleName = Model.RoleName, departmentId = Model.DepartmentId })"><i class="fas fa-angle-right"></i></a>
                        </li>
                        <li class="page-item @(Model.Page >= totalPages ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("UserList", new { page = totalPages, pageSize = Model.PageSize, search = Model.Search, roleName = Model.RoleName, departmentId = Model.DepartmentId })"><i class="fas fa-angle-double-right"></i></a>
                        </li>
                    </ul>

                    <div class="um-pagination-info">Hiển thị <strong>@Model.Users.Count</strong> / <strong>@Model.TotalCount</strong> người dùng</div>
                </nav>
            </footer>
        }
    </section>
</div>

<div id="um-modal-overlay" class="um-modal-overlay" aria-hidden="true">
    <div class="um-modal-card" role="dialog" aria-modal="true" aria-labelledby="um-modal-title">
        <header class="um-modal-header">
            <h3 id="um-modal-title"><i class="fas fa-user-circle"></i> Chi tiết người dùng</h3>
            <button id="um-modal-close" class="um-modal-close" aria-label="Close">&times;</button>
        </header>
        <div id="um-modal-body" class="um-modal-body">
            <div class="um-loading-inline">
                <div class="um-spinner"></div>
                <p class="um-text-muted">Đang tải dữ liệu...</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // ========================================
        // SERVER-SIDE SEARCH DEBOUNCE
        // ========================================
        let timeout = null;
        const searchInput = document.getElementById('searchInput');
        const filterForm = document.getElementById('filterForm');

        if(searchInput && filterForm) {
            searchInput.addEventListener('keyup', function (e) {
                clearTimeout(timeout);
                timeout = setTimeout(function () {
                    filterForm.submit();
                }, 600);
            });

            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    clearTimeout(timeout);
                    filterForm.submit();
                }
            });
        }

        // ========================================
        // MODAL CONTROLS
        // ========================================
        const modalOverlay = document.getElementById('um-modal-overlay');
        const modalBody = document.getElementById('um-modal-body');
        const modalClose = document.getElementById('um-modal-close');

        function openModal() {
            modalOverlay.setAttribute('aria-hidden', 'false');
            modalOverlay.classList.add('open');
        }
        function closeModal() {
            modalOverlay.setAttribute('aria-hidden', 'true');
            modalOverlay.classList.remove('open');
        }
        if(modalClose) modalClose.addEventListener('click', closeModal);
        if(modalOverlay) modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) closeModal();
        });

        // ========================================
        // VIEW DETAIL BUTTONS
        // ========================================
        document.querySelectorAll('.um-action-view').forEach(btn => {
            btn.addEventListener('click', async function () {
                const userId = this.dataset.id;
                openModal();

                try {
                    const res = await fetch(`/Admin/GetUserDetail?userId=${userId}`);
                    const data = await res.json();
                    if (!data.success) {
                        modalBody.innerHTML = `<div class="um-alert um-alert-error">${data.message}</div>`;
                        return;
                    }

                    const u = data.user;
                    const t = data.tasks;
                    const a = data.attendance;
                    const s = data.salary;

                    const html = `
                        <section class="um-detail">
                            <div class="um-detail-row"><strong>Tên:</strong> ${u.fullName}</div>
                            <div class="um-detail-row"><strong>Username:</strong> ${u.username}</div>
                            <div class="um-detail-row"><strong>Email:</strong> ${u.email || 'N/A'}</div>
                            <div class="um-detail-row"><strong>Phòng ban:</strong> ${u.departmentName}</div>
                            <div class="um-detail-row"><strong>Trạng thái:</strong> ${u.isActive ? 'Hoạt động' : 'Vô hiệu'}</div>
                            <hr/>
                            <div class="um-detail-section"><strong>Công việc</strong>
                                <div class="um-stats-grid-inline">
                                    <div><div class="um-stat-value">${t.total}</div><div class="um-stat-label">Tổng</div></div>
                                    <div><div class="um-stat-value">${t.completed}</div><div class="um-stat-label">Hoàn thành</div></div>
                                    <div><div class="um-stat-value">${t.inProgress}</div><div class="um-stat-label">Đang làm</div></div>
                                    <div><div class="um-stat-value">${t.overdue}</div><div class="um-stat-label">Quá hạn</div></div>
                                </div>
                            </div>
                            <hr/>
                            <div class="um-detail-section"><strong>Chấm công (tháng này)</strong>
                                <div class="um-detail-row">Ngày làm: ${a.totalWorkDays} — Đúng giờ: ${a.onTimeDays} — Muộn: ${a.lateDays}</div>
                                <div class="um-detail-row">Giờ làm: ${a.totalWorkHours} h — Tăng ca đã duyệt: ${a.approvedOvertimeHours} h</div>
                            </div>
                            <hr/>
                            <div class="um-detail-section"><strong>Lương (tháng này)</strong>
                                <div class="um-detail-row">Lương cơ bản: ${s.baseSalary?.toLocaleString('vi-VN')} ₫</div>
                                <div class="um-detail-row">Lương giờ: ${s.workHoursSalary?.toLocaleString('vi-VN')} ₫ — Tăng ca: ${s.overtimeSalary?.toLocaleString('vi-VN')} ₫</div>
                                <div class="um-detail-row">Khấu trừ: ${s.totalDeduction?.toLocaleString('vi-VN')} ₫</div>
                                <div class="um-detail-row"><strong>Lương dự kiến: ${s.estimatedSalary?.toLocaleString('vi-VN')} ₫</strong></div>
                            </div>
                        </section>
                    `;
                    modalBody.innerHTML = html;
                } catch (err) {
                    modalBody.innerHTML = `<div class="um-alert um-alert-error">Lỗi: ${err.message}</div>`;
                }
            });
        });

        // ========================================
        // ✅ CHUYỂN USER VÀO THÙNG RÁC
        // ========================================
        async function moveUserToTrash(userId, fullName) {
            const result = await Swal.fire({
                title: 'Xác nhận xóa',
                html: `Bạn có chắc muốn chuyển<br><strong>"${fullName}"</strong><br>vào thùng rác?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#E74C3C',
                cancelButtonColor: '#95A5A6',
                confirmButtonText: '<i class="fas fa-trash-alt me-2"></i>Xóa',
                cancelButtonText: '<i class="fas fa-times me-2"></i>Hủy'
            });

            if (!result.isConfirmed) return;

            try {
                const res = await fetch('/Admin/MoveUserToTrash', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userId })
                });
                const data = await res.json();
                
                if (data.success) {
                    await Swal.fire({
                        title: 'Thành công!',
                        text: data.message,
                        icon: 'success',
                        confirmButtonColor: '#27AE60'
                    });
                    location.reload();
                } else {
                    await Swal.fire({
                        title: 'Lỗi!',
                        text: data.message,
                        icon: 'error',
                        confirmButtonColor: '#E74C3C'
                    });
                }
            } catch (err) {
                await Swal.fire({
                    title: 'Lỗi!',
                    text: 'Có lỗi xảy ra: ' + err.message,
                    icon: 'error',
                    confirmButtonColor: '#E74C3C'
                });
            }
        }

        // ========================================
        // EXPORT TO EXCEL
        // ========================================
        const btnExport = document.getElementById('btnExportExcel');
        if(btnExport){
            btnExport.addEventListener('click', async function() {
                const btn = this;
                const originalHtml = btn.innerHTML;

                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xuất...';

                    const params = new URLSearchParams({
                        search: document.getElementById('searchInput')?.value || '',
                        roleName: document.getElementById('roleFilter')?.value || '',
                        departmentId: document.getElementById('deptFilter')?.value || ''
                    });

                    const response = await fetch(`/Admin/ExportUsersToExcel?${params.toString()}`);
                    const result = await response.json();

                    if (!result.success) {
                        alert('Lỗi: ' + result.message);
                        return;
                    }

                    const wb = XLSX.utils.book_new();
                    const worksheetData = [
                        ['STT', 'Họ Tên', 'Username', 'Email', 'Số Điện Thoại', 'Phòng Ban', 'Vai Trò', 'Trạng Thái'],
                        ...result.data.map(item => [
                            item.stt || item.STT,
                            item.hoTen || item.HoTen,
                            item.username || item.Username,
                            item.email || item.Email,
                            item.soDienThoai || item.SoDienThoai,
                            item.phongBan || item.PhongBan,
                            item.vaiTro || item.VaiTro,
                            item.trangThai || item.TrangThai
                        ])
                    ];

                    const ws = XLSX.utils.aoa_to_sheet(worksheetData);
                    ws['!cols'] = [
                        { wch: 5 }, { wch: 25 }, { wch: 15 }, { wch: 30 },
                        { wch: 15 }, { wch: 20 }, { wch: 12 }, { wch: 15 }
                    ];

                    XLSX.utils.book_append_sheet(wb, ws, 'Danh sách người dùng');
                    const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,'-');
                    const filename = `DanhSachNguoiDung_${timestamp}.xlsx`;
                    XLSX.writeFile(wb, filename);

                    alert(`✅ Đã xuất ${result.totalRecords} người dùng ra file Excel thành công!`);
                } catch (error) {
                    console.error('Export error:', error);
                    alert('Có lỗi xảy ra: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            });
        }
    </script>
}