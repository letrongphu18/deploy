@{
    ViewData["Title"] = "Báo cáo KPI";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/css/kpi-dashboard.css" />

<div class="kpi-container">
    <!-- Page Header -->
    <div class="kpi-page-header">
        <div class="kpi-header-content">
            <div>
                <h1 class="kpi-page-title">
                    <i class="fas fa-chart-line"></i>
                    Báo cáo KPI
                </h1>
                <p class="kpi-page-subtitle">Theo dõi và đánh giá hiệu suất làm việc toàn hệ thống</p>
            </div>
            <button class="kpi-btn kpi-btn-export" onclick="exportAllKPI()">
                <i class="fas fa-file-excel"></i>
                <span>Xuất Excel</span>
            </button>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="kpi-card kpi-filter-card">
        <div class="kpi-filter-grid">
            <div class="kpi-filter-item">
                <label class="kpi-label">
                    <i class="fas fa-calendar-alt"></i>
                    Từ ngày
                </label>
                <input type="date" class="kpi-input" id="startDate" />
            </div>
            <div class="kpi-filter-item">
                <label class="kpi-label">
                    <i class="fas fa-calendar-alt"></i>
                    Đến ngày
                </label>
                <input type="date" class="kpi-input" id="endDate" />
            </div>
            <div class="kpi-filter-item">
                <label class="kpi-label">
                    <i class="fas fa-building"></i>
                    Phòng ban
                </label>
                <select class="kpi-select" id="departmentFilter">
                    <option value="">Tất cả phòng ban</option>
                </select>
            </div>
            <div class="kpi-filter-item kpi-filter-actions">
                <button class="kpi-btn kpi-btn-primary" onclick="loadKPIData()">
                    <i class="fas fa-search"></i>
                    <span>Xem báo cáo</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="kpi-loading" id="loadingSpinner">
        <div class="kpi-spinner"></div>
        <p>Đang tải dữ liệu...</p>
    </div>

    <!-- Tab Navigation -->
    <div class="kpi-tabs">
        <button class="kpi-tab active" data-tab="overview" onclick="switchTab('overview')">
            <i class="fas fa-chart-pie"></i>
            <span>Tổng quan</span>
        </button>
        <button class="kpi-tab" data-tab="department" onclick="switchTab('department')">
            <i class="fas fa-building"></i>
            <span>So sánh phòng ban</span>
        </button>
        <button class="kpi-tab" data-tab="personal" onclick="switchTab('personal')">
            <i class="fas fa-users"></i>
            <span>KPI cá nhân</span>
        </button>
        <button class="kpi-tab" data-tab="timeline" onclick="switchTab('timeline')">
            <i class="fas fa-chart-line"></i>
            <span>Xu hướng</span>
        </button>
    </div>

    <!-- Overview Tab -->
    <div class="kpi-tab-content active" id="overviewTab">
        <!-- Statistics Cards -->
        <div class="kpi-stats-grid">
            <div class="kpi-stat-card kpi-stat-primary">
                <div class="kpi-stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="kpi-stat-content">
                    <div class="kpi-stat-label">Tổng nhân viên</div>
                    <div class="kpi-stat-value" id="totalUsers">0</div>
                    <div class="kpi-stat-trend up" id="userTrend">
                        <i class="fas fa-arrow-up"></i> 0%
                    </div>
                </div>
            </div>

            <div class="kpi-stat-card kpi-stat-success">
                <div class="kpi-stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="kpi-stat-content">
                    <div class="kpi-stat-label">Tỷ lệ chấm công</div>
                    <div class="kpi-stat-value" id="attendanceRate">0%</div>
                    <div class="kpi-stat-trend up" id="attendanceTrend">
                        <i class="fas fa-arrow-up"></i> 0%
                    </div>
                </div>
            </div>

            <div class="kpi-stat-card kpi-stat-info">
                <div class="kpi-stat-icon">
                    <i class="fas fa-tasks"></i>
                </div>
                <div class="kpi-stat-content">
                    <div class="kpi-stat-label">Tasks hoạt động</div>
                    <div class="kpi-stat-value" id="activeTasks">0</div>
                    <div class="kpi-stat-trend up" id="taskTrend">
                        <i class="fas fa-arrow-up"></i> 0%
                    </div>
                </div>
            </div>

            <div class="kpi-stat-card kpi-stat-warning">
                <div class="kpi-stat-icon">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="kpi-stat-content">
                    <div class="kpi-stat-label">Đề xuất chờ duyệt</div>
                    <div class="kpi-stat-value" id="pendingRequests">0</div>
                    <div class="kpi-stat-trend down" id="requestTrend">
                        <i class="fas fa-arrow-down"></i> 0%
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="kpi-charts-grid">
            <div class="kpi-card kpi-chart-card">
                <div class="kpi-card-header">
                    <h3>
                        <i class="fas fa-chart-bar"></i>
                        Thống kê tháng này
                    </h3>
                </div>
                <div class="kpi-chart-wrapper">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <div class="kpi-card kpi-performers-card">
                <div class="kpi-card-header">
                    <h3>
                        <i class="fas fa-trophy"></i>
                        Top Performers
                    </h3>
                </div>
                <div class="kpi-performers-list" id="topPerformersList">
                    <div class="kpi-empty">Đang tải dữ liệu...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Department Tab -->
    <div class="kpi-tab-content" id="departmentTab">
        <div class="kpi-card">
            <div class="kpi-card-header">
                <h3>
                    <i class="fas fa-building"></i>
                    So sánh KPI giữa các phòng ban
                </h3>
                <button class="kpi-btn kpi-btn-secondary" onclick="exportDepartmentKPI()">
                    <i class="fas fa-download"></i>
                    <span>Xuất Excel</span>
                </button>
            </div>
            <div class="kpi-chart-wrapper">
                <canvas id="departmentChart"></canvas>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-table-wrapper">
                <table class="kpi-table">
                    <thead>
                        <tr>
                            <th>Phòng ban</th>
                            <th>Số nhân viên</th>
                            <th>Tổng chấm công</th>
                            <th>Tỷ lệ muộn</th>
                            <th>Giờ làm TB</th>
                            <th>Tasks hoàn thành</th>
                            <th>Điểm KPI</th>
                        </tr>
                    </thead>
                    <tbody id="departmentTableBody">
                        <tr>
                            <td colspan="7" class="kpi-empty">Đang tải dữ liệu...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Personal Tab -->
    <div class="kpi-tab-content" id="personalTab">
        <div class="kpi-card">
            <div class="kpi-card-header">
                <h3>
                    <i class="fas fa-users"></i>
                    KPI cá nhân (Tất cả nhân viên)
                </h3>
            </div>
            <div class="kpi-table-wrapper">
                <table class="kpi-table">
                    <thead>
                        <tr>
                            <th>Nhân viên</th>
                            <th>Phòng ban</th>
                            <th>Ngày làm việc</th>
                            <th>Đi muộn</th>
                            <th>Tỷ lệ muộn</th>
                            <th>Tổng giờ</th>
                            <th>Tasks</th>
                            <th>Hoàn thành</th>
                            <th>Điểm KPI</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="personalTableBody">
                        <tr>
                            <td colspan="10" class="kpi-empty">Đang tải dữ liệu...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Timeline Tab -->
    <div class="kpi-tab-content" id="timelineTab">
        <div class="kpi-card">
            <div class="kpi-card-header">
                <h3>
                    <i class="fas fa-chart-line"></i>
                    Xu hướng KPI theo thời gian
                </h3>
                <div class="kpi-btn-group">
                    <button class="kpi-btn kpi-btn-sm active" onclick="loadTimeline('day')" data-period="day">Ngày</button>
                    <button class="kpi-btn kpi-btn-sm" onclick="loadTimeline('week')" data-period="week">Tuần</button>
                    <button class="kpi-btn kpi-btn-sm" onclick="loadTimeline('month')" data-period="month">Tháng</button>
                </div>
            </div>
            <div class="kpi-chart-wrapper">
                <canvas id="timelineChart"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let charts = {};
        const API_BASE = '/api/KPI';
        let isLoading = false;
        let allUsers = [];

        // Initialize
        $(document).ready(function() {
            initializeDateFilters();
            loadDepartments();
            loadUsers();
            loadKPIData();
        });

        function initializeDateFilters() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            $('#startDate').val(formatDate(firstDay));
            $('#endDate').val(formatDate(today));
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        async function loadDepartments() {
            try {
                const response = await fetch('/api/departments');
                if (!response.ok) throw new Error('Failed to load departments');
                const data = await response.json();
                const select = $('#departmentFilter');
                select.find('option:not(:first)').remove();
                data.forEach(dept => {
                    select.append(`<option value="${dept.departmentId}">${dept.departmentName}</option>`);
                });
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                if (!response.ok) throw new Error('Failed to load users');
                allUsers = await response.json();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadKPIData() {
            if (isLoading) return;
            showLoading();

            try {
                const date = $('#endDate').val();
                const response = await fetch(`${API_BASE}/overview?date=${date}`);
                if (!response.ok) throw new Error('Failed to load KPI data');
                const data = await response.json();

                updateOverviewCards(data.system);
                updateMonthlyChart(data.monthlyStats);
                updateTopPerformers(data.topPerformers);
            } catch (error) {
                console.error('Error loading KPI data:', error);
                showError('Lỗi khi tải dữ liệu KPI');
            } finally {
                hideLoading();
            }
        }

        function updateOverviewCards(system) {
            $('#totalUsers').text(system.totalUsers || 0);
            $('#attendanceRate').text((system.attendanceRate || 0).toFixed(1) + '%');
            $('#activeTasks').text(system.activeTasks || 0);
            $('#pendingRequests').text(system.pendingRequests || 0);
        }

        function updateMonthlyChart(stats) {
            const ctx = document.getElementById('monthlyChart');
            if (!ctx) return;

            if (charts.monthly) {
                charts.monthly.destroy();
            }

            charts.monthly = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Chấm công', 'Tỷ lệ muộn (%)', 'Giờ làm', 'Tăng ca'],
                    datasets: [{
                        label: 'Thống kê',
                        data: [
                            stats.totalAttendances || 0,
                            stats.averageLateRate || 0,
                            stats.totalWorkHours || 0,
                            stats.totalOvertimeHours || 0
                        ],
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderRadius: 8,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updateTopPerformers(performers) {
            const container = $('#topPerformersList');
            container.empty();

            if (!performers || performers.length === 0) {
                container.html('<div class="kpi-empty">Chưa có dữ liệu</div>');
                return;
            }

            performers.forEach((user, index) => {
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : 'default';
                const html = `
                    <div class="kpi-performer-item">
                        <div class="kpi-performer-rank kpi-rank-${rankClass}">${index + 1}</div>
                        <div class="kpi-performer-info">
                            <div class="kpi-performer-name">${user.fullName || 'N/A'}</div>
                            <div class="kpi-performer-dept">${user.department || 'N/A'}</div>
                        </div>
                        <div class="kpi-performer-score">${(user.kpiScore || 0).toFixed(1)}</div>
                    </div>
                `;
                container.append(html);
            });
        }

        async function loadDepartmentComparison() {
            if (isLoading) return;
            showLoading();

            try {
                const start = $('#startDate').val();
                const end = $('#endDate').val();
                const response = await fetch(`/Admin/GetDepartmentComparison?startDate=${start}&endDate=${end}`);

                if (!response.ok) throw new Error('Failed to load department comparison');
                const data = await response.json();

                if (!Array.isArray(data)) {
                    throw new Error('Invalid data format');
                }

                updateDepartmentChart(data);
                updateDepartmentTable(data);
            } catch (error) {
                console.error('Error loading department comparison:', error);
                showError('Lỗi khi tải so sánh phòng ban');
            } finally {
                hideLoading();
            }
        }

        function updateDepartmentChart(data) {
            const ctx = document.getElementById('departmentChart');
            if (!ctx) return;

            if (charts.department) {
                charts.department.destroy();
            }

            charts.department = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: data.map(d => d.departmentName || 'N/A'),
                    datasets: [{
                        label: 'Điểm KPI',
                        data: data.map(d => d.departmentKPIScore || 0),
                        backgroundColor: 'rgba(99, 102, 241, 0.8)',
                        borderRadius: 8,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function updateDepartmentTable(data) {
            const tbody = $('#departmentTableBody');
            tbody.empty();

            if (data.length === 0) {
                tbody.append('<tr><td colspan="7" class="kpi-empty">Không có dữ liệu</td></tr>');
                return;
            }

            data.forEach(dept => {
                const html = `
                    <tr>
                        <td><strong>${dept.departmentName || 'N/A'}</strong></td>
                        <td>${dept.totalEmployees || 0}</td>
                        <td>${dept.totalAttendances || 0}</td>
                        <td><span class="kpi-badge ${dept.lateRate > 10 ? 'kpi-badge-danger' : 'kpi-badge-success'}">${(dept.lateRate || 0).toFixed(1)}%</span></td>
                        <td>${(dept.avgHoursPerDay || 0).toFixed(1)}h</td>
                        <td>${dept.completedTasks || 0}/${dept.totalTasks || 0} <small class="kpi-muted">(${(dept.taskCompletionRate || 0).toFixed(1)}%)</small></td>
                        <td><strong class="kpi-score">${(dept.departmentKPIScore || 0).toFixed(1)}</strong></td>
                    </tr>
                `;
                tbody.append(html);
            });
        }

        async function loadAllUserKPI() {
            if (isLoading) return;
            showLoading();

            try {
                const start = $('#startDate').val();
                const end = $('#endDate').val();
                const tbody = $('#personalTableBody');
                tbody.empty();

                if (allUsers.length === 0) {
                    tbody.append('<tr><td colspan="10" class="kpi-empty">Không có nhân viên nào</td></tr>');
                    hideLoading();
                    return;
                }

                for (const user of allUsers) {
                    const response = await fetch(`${API_BASE}/user/${user.userId}?startDate=${start}&endDate=${end}`);
                    if (!response.ok) continue;

                    const data = await response.json();
                    const html = `
                        <tr>
                            <td><strong>${user.fullName}</strong></td>
                            <td>${user.departmentName || 'N/A'}</td>
                            <td>${data.attendance.totalDays || 0}</td>
                            <td>${data.attendance.lateDays || 0}</td>
                            <td><span class="kpi-badge ${data.attendance.lateRate > 10 ? 'kpi-badge-danger' : 'kpi-badge-success'}">${(data.attendance.lateRate || 0).toFixed(1)}%</span></td>
                            <td>${(data.attendance.totalWorkHours || 0).toFixed(1)}h</td>
                            <td>${data.tasks.totalAssigned || 0}</td>
                            <td>${data.tasks.completed || 0} <small class="kpi-muted">(${(data.tasks.completionRate || 0).toFixed(1)}%)</small></td>
                            <td><strong class="kpi-score">${(data.overallScore || 0).toFixed(1)}</strong></td>
                            <td>
                                <button class="kpi-btn kpi-btn-sm kpi-btn-secondary" onclick="exportUserKPI(${user.userId})">
                                    <i class="fas fa-download"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(html);
                }
            } catch (error) {
                console.error('Error loading user KPI:', error);
                showError('Lỗi khi tải KPI cá nhân');
            } finally {
                hideLoading();
            }
        }

        async function loadTimeline(groupBy) {
            if (isLoading) return;
            showLoading();

            // Update active button
            $('.kpi-btn-group .kpi-btn').removeClass('active');
            $(`.kpi-btn-group .kpi-btn[data-period="${groupBy}"]`).addClass('active');

            try {
                const start = $('#startDate').val();
                const end = $('#endDate').val();
                const response = await fetch(`${API_BASE}/timeline?startDate=${start}&endDate=${end}&groupBy=${groupBy}`);

                if (!response.ok) throw new Error('Failed to load timeline');
                const data = await response.json();

                const ctx = document.getElementById('timelineChart');
                if (!ctx) return;

                if (charts.timeline) {
                    charts.timeline.destroy();
                }

                const labels = data.map(d => {
                    if (d.date) return new Date(d.date).toLocaleDateString('vi-VN');
                    if (d.year && d.month) return `${d.month}/${d.year}`;
                    if (d.year && d.week) return `Tuần ${d.week}`;
                    return 'N/A';
                });

                charts.timeline = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Tỷ lệ muộn (%)',
                                data: data.map(d => d.lateRate || 0),
                                borderColor: 'rgb(239, 68, 68)',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Giờ làm TB',
                                data: data.map(d => (d.totalAttendances > 0 ? (d.totalHours / d.totalAttendances).toFixed(1) : 0)),
                                borderColor: 'rgb(16, 185, 129)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading timeline:', error);
                showError('Lỗi khi tải xu hướng');
            } finally {
                hideLoading();
            }
        }

        function switchTab(tabName) {
            $('.kpi-tab').removeClass('active');
            $(`.kpi-tab[data-tab="${tabName}"]`).addClass('active');

            $('.kpi-tab-content').removeClass('active');
            $(`#${tabName}Tab`).addClass('active');

            if (tabName === 'department') {
                loadDepartmentComparison();
            } else if (tabName === 'personal') {
                loadAllUserKPI();
            } else if (tabName === 'timeline') {
                loadTimeline('day');
            }
        }

        function exportUserKPI(userId) {
            const start = $('#startDate').val();
            const end = $('#endDate').val();
            window.location.href = `${API_BASE}/export/user/${userId}?startDate=${start}&endDate=${end}`;
        }

        function exportDepartmentKPI() {
            const deptId = $('#departmentFilter').val();
            if (!deptId) {
                alert('Vui lòng chọn phòng ban');
                return;
            }
            const start = $('#startDate').val();
            const end = $('#endDate').val();
            window.location.href = `${API_BASE}/export/department/${deptId}?startDate=${start}&endDate=${end}`;
        }

        function exportAllKPI() {
            const start = $('#startDate').val();
            const end = $('#endDate').val();
            alert('Chức năng xuất tất cả KPI đang được phát triển');
        }

        function showLoading() {
            isLoading = true;
            $('#loadingSpinner').addClass('active');
        }

        function hideLoading() {
            isLoading = false;
            $('#loadingSpinner').removeClass('active');
        }

        function showError(message) {
            alert(message);
        }
    </script>
}