@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/css/dashboard-management.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>

<div class="aihub-dash-container">
    <!-- HEADER -->
    <div class="aihub-dash-page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="aihub-dash-page-title">
                    <i class="fas fa-chart-line"></i> Admin Dashboard
                </h2>
                <p class="aihub-dash-page-subtitle">Tổng quan hệ thống quản lý và hiệu suất làm việc</p>
            </div>
            <div class="aihub-dash-date-badge">
                <i class="fas fa-calendar-alt"></i>
                <span id="currentDate"></span>
            </div>
        </div>
    </div>

    <!-- STATISTICS CARDS -->
    <div class="aihub-dash-stats-grid">
        <div class="aihub-dash-stat-card aihub-dash-stat-primary">
            <div class="aihub-dash-stat-icon">
                <i class="fas fa-tasks"></i>
            </div>
            <div class="aihub-dash-stat-content">
                <div class="aihub-dash-stat-label">Tổng Công Việc</div>
                <div class="aihub-dash-stat-value">@ViewBag.TotalAssignments</div>
                <div class="aihub-dash-stat-change positive">
                    <i class="fas fa-clipboard-list"></i> @ViewBag.TotalTasks task đang hoạt động
                </div>
            </div>
        </div>

        <div class="aihub-dash-stat-card aihub-dash-stat-success">
            <div class="aihub-dash-stat-icon">
                <i class="fas fa-check-double"></i>
            </div>
            <div class="aihub-dash-stat-content">
                <div class="aihub-dash-stat-label">Đã Hoàn Thành</div>
                <div class="aihub-dash-stat-value">@ViewBag.CompletedTasks</div>
                <div class="aihub-dash-stat-change positive">
                    <i class="fas fa-percentage"></i> @ViewBag.TaskCompletionRate%
                </div>
            </div>
        </div>

        <div class="aihub-dash-stat-card aihub-dash-stat-warning">
            <div class="aihub-dash-stat-icon">
                <i class="fas fa-spinner"></i>
            </div>
            <div class="aihub-dash-stat-content">
                <div class="aihub-dash-stat-label">Đang Thực Hiện</div>
                <div class="aihub-dash-stat-value">@ViewBag.InProgressTasks</div>
                <div class="aihub-dash-stat-change">
                    <i class="fas fa-clock"></i> Đang xử lý
                </div>
            </div>
        </div>

        <div class="aihub-dash-stat-card aihub-dash-stat-danger">
            <div class="aihub-dash-stat-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="aihub-dash-stat-content">
                <div class="aihub-dash-stat-label">Task Quá Hạn</div>
                <div class="aihub-dash-stat-value">@ViewBag.OverdueTasks</div>
                <div class="aihub-dash-stat-change negative">
                    <i class="fas fa-calendar-times"></i> Cần xử lý gấp
                </div>
            </div>
        </div>

        <div class="aihub-dash-stat-card aihub-dash-stat-info">
            <div class="aihub-dash-stat-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="aihub-dash-stat-content">
                <div class="aihub-dash-stat-label">Chuyên Cần (Tháng)</div>
                <div class="aihub-dash-stat-value">@ViewBag.OnTimeCount</div>
                <div class="aihub-dash-stat-change positive">
                    <i class="fas fa-percentage"></i> @ViewBag.OnTimeRate%
                </div>
            </div>
        </div>

        <div class="aihub-dash-stat-card aihub-dash-stat-secondary">
            <div class="aihub-dash-stat-icon">
                <i class="fas fa-list"></i>
            </div>
            <div class="aihub-dash-stat-content">
                <div class="aihub-dash-stat-label">Chưa Bắt Đầu</div>
                <div class="aihub-dash-stat-value">@ViewBag.TodoTasks</div>
                <div class="aihub-dash-stat-change">
                    <i class="fas fa-hourglass-start"></i> Cần phân công
                </div>
            </div>
        </div>
    </div>

    <!-- ROW 1: CHARTS -->
    <div class="row g-4 mb-4">
        <!-- TASK STATUS DISTRIBUTION -->
        <div class="col-lg-6">
            <div class="aihub-dash-card">
                <div class="aihub-dash-card-header">
                    <h5 class="aihub-dash-card-title">
                        <i class="fas fa-chart-pie"></i> Phân Bổ Trạng Thái Task
                    </h5>
                </div>
                <div class="aihub-dash-card-body">
                    <canvas id="taskStatusChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <!-- DEPARTMENT PERFORMANCE -->
        <div class="col-lg-6">
            <div class="aihub-dash-card">
                <div class="aihub-dash-card-header">
                    <h5 class="aihub-dash-card-title">
                        <i class="fas fa-building"></i> Hiệu Suất Theo Phòng Ban
                    </h5>
                </div>
                <div class="aihub-dash-card-body">
                    <canvas id="departmentChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ROW 2: UPCOMING TASKS -->
    <div class="row g-4 mb-4">
        <div class="col-lg-12">
            <div class="aihub-dash-card">
                <div class="aihub-dash-card-header">
                    <h5 class="aihub-dash-card-title">
                        <i class="fas fa-calendar-alt"></i> Task Sắp Đến Deadline
                    </h5>
                    <a href="/Admin/TaskList" class="aihub-dash-btn-link">
                        Xem tất cả <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                <div class="aihub-dash-card-body">
                    @if (ViewBag.UpcomingTasks != null && ViewBag.UpcomingTasks.Count > 0)
                    {
                        <div class="aihub-dash-task-progress">
                            @foreach (var task in ViewBag.UpcomingTasks)
                            {
                                DateTime deadline = task.Task.Deadline ?? DateTime.Now;
                                var daysLeft = (deadline - DateTime.Now).Days;
                                var isUrgent = daysLeft <= 3;

                                <div class="aihub-dash-task-item">
                                    <div class="aihub-dash-task-header">
                                        <div class="aihub-dash-task-name">
                                            <i class="fas fa-clipboard-list me-2"></i>
                                            @task.Task.TaskName
                                            @if (isUrgent && daysLeft >= 0)
                                            {
                                                <span class="aihub-dash-badge aihub-dash-badge-danger ms-2">
                                                    <i class="fas fa-exclamation-triangle"></i> Gấp
                                                </span>
                                            }
                                        </div>
                                        <div class="aihub-dash-task-percentage">@task.ProgressPercent%</div>
                                    </div>
                                    <div class="aihub-dash-progress aihub-dash-stat-@(task.ProgressPercent >= 80 ? "success" : task.ProgressPercent >= 50 ? "warning" : "danger")">
                                        <div class="aihub-dash-progress-bar" style="width: @task.ProgressPercent%"></div>
                                    </div>
                                    <div class="aihub-dash-task-meta">
                                        <span>
                                            <i class="fas fa-check-circle text-success me-1"></i> @task.CompletedCount hoàn thành
                                            <i class="fas fa-spinner text-warning mx-2"></i> @task.InProgressCount đang làm
                                            <i class="fas fa-clock text-secondary mx-2"></i> @task.TodoCount chưa bắt đầu
                                        </span>
                                        <span>
                                            <i class="far fa-calendar me-1"></i>
                                            @deadline.ToString("dd/MM/yyyy")
                                            @if (daysLeft >= 0)
                                            {
                                                <span class="@(isUrgent ? "aihub-dash-text-danger" : "aihub-dash-text-success")">
                                                    (Còn @daysLeft ngày)
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="aihub-dash-text-danger">(Quá hạn @Math.Abs(daysLeft) ngày)</span>
                                            }
                                        </span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="aihub-dash-empty-state">
                            <i class="fas fa-calendar-check"></i>
                            <p>Không có task nào sắp đến deadline</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- ROW 3: TOP PERFORMERS & TASK BY PRIORITY -->
    <div class="row g-4 mb-4">
        <!-- TOP PERFORMERS -->
        <div class="col-lg-6">
            <div class="aihub-dash-card">
                <div class="aihub-dash-card-header">
                    <h5 class="aihub-dash-card-title">
                        <i class="fas fa-trophy"></i> Top 5 Nhân Viên Xuất Sắc
                    </h5>
                    <a href="/Admin/UserList" class="aihub-dash-btn-link">
                        Xem tất cả <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                <div class="aihub-dash-card-body">
                    @if (ViewBag.TopPerformers != null && ViewBag.TopPerformers.Count > 0)
                    {
                        <div class="aihub-dash-leaderboard">
                            @for (int i = 0; i < ViewBag.TopPerformers.Count; i++)
                            {
                                var performer = ViewBag.TopPerformers[i];
                                var rankClass = i == 0 ? "rank-1" : i == 1 ? "rank-2" : i == 2 ? "rank-3" : "rank-other";

                                <div class="aihub-dash-leaderboard-item">
                                    <div class="aihub-dash-leaderboard-rank @rankClass">
                                        @if (i < 3)
                                        {
                                            <i class="fas fa-@(i == 0 ? "crown" : i == 1 ? "medal" : "award")"></i>
                                        }
                                        else
                                        {
                                            <span>@(i + 1)</span>
                                        }
                                    </div>

                                    @if (performer.HasAvatar)
                                    {
                                        <img src="@performer.Avatar"
                                             class="aihub-dash-user-avatar"
                                             alt="@performer.User.FullName"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                                        <div class="aihub-dash-user-avatar"
                                             style="display:none;background:linear-gradient(135deg,var(--aihub-terracotta),var(--aihub-clay));color:white;justify-content:center;align-items:center;">
                                            @performer.Initials
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="aihub-dash-user-avatar"
                                             style="background:linear-gradient(135deg,var(--aihub-terracotta),var(--aihub-clay));color:white;display:flex;justify-content:center;align-items:center;">
                                            @performer.Initials
                                        </div>
                                    }

                                    <div class="aihub-dash-leaderboard-info">
                                        <div class="aihub-dash-leaderboard-name">@performer.User.FullName</div>
                                        <div class="aihub-dash-leaderboard-dept">
                                            <i class="fas fa-building me-1"></i>
                                            @performer.User.Department?.DepartmentName
                                        </div>
                                    </div>
                                    <div class="aihub-dash-leaderboard-stat">
                                        <div class="aihub-dash-leaderboard-value">@performer.TotalCompleted</div>
                                        <div class="aihub-dash-leaderboard-label">Task hoàn thành</div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="aihub-dash-empty-state">
                            <i class="fas fa-trophy"></i>
                            <p>Chưa có dữ liệu thống kê</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- TASK PROGRESS BY PRIORITY -->
        <div class="col-lg-6">
            <div class="aihub-dash-card">
                <div class="aihub-dash-card-header">
                    <h5 class="aihub-dash-card-title">
                        <i class="fas fa-chart-bar"></i> Tiến Độ Task Theo Mức Độ
                    </h5>
                    <a href="/Admin/TaskList" class="aihub-dash-btn-link">
                        Xem tất cả <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                <div class="aihub-dash-card-body">
                    @if (ViewBag.TasksByPriority != null && ViewBag.TasksByPriority.Count > 0)
                    {
                        <div class="aihub-dash-task-progress">
                            @foreach (var priority in ViewBag.TasksByPriority)
                            {
                                var percentage = priority.Total > 0 ? Math.Round((double)priority.Completed / priority.Total * 100, 1) : 0;
                                var priorityColor = priority.Priority == "High" ? "danger" : priority.Priority == "Medium" ? "warning" : "success";

                                <div class="aihub-dash-task-item">
                                    <div class="aihub-dash-task-header">
                                        <div class="aihub-dash-task-name">
                                            <span class="aihub-dash-badge aihub-dash-badge-@priorityColor me-2">
                                                <i class="fas fa-@(priority.Priority == "High" ? "arrow-up" : priority.Priority == "Medium" ? "minus" : "arrow-down")"></i>
                                                @priority.Priority
                                            </span>
                                        </div>
                                        <div class="aihub-dash-task-percentage">@percentage%</div>
                                    </div>
                                    <div class="aihub-dash-progress aihub-dash-stat-@priorityColor">
                                        <div class="aihub-dash-progress-bar" style="width: @percentage%"></div>
                                    </div>
                                    <div class="aihub-dash-task-meta">
                                        <span>
                                            <i class="fas fa-check text-success me-1"></i> @priority.Completed hoàn thành
                                            <i class="fas fa-spinner text-warning mx-2"></i> @priority.InProgress đang làm
                                            <i class="fas fa-clock text-secondary mx-2"></i> @priority.Todo chưa bắt đầu
                                        </span>
                                        <span>Tổng: @priority.Total công việc</span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="aihub-dash-empty-state">
                            <i class="fas fa-tasks"></i>
                            <p>Chưa có task nào</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- ROW 4: ATTENDANCE & ACTIVITIES -->
    <div class="row g-4">
        <!-- PUNCTUAL STAFF -->
        <div class="col-lg-4">
            <div class="aihub-dash-card">
                <div class="aihub-dash-card-header">
                    <h5 class="aihub-dash-card-title">
                        <i class="fas fa-user-check"></i> Top 5 Chuyên Cần
                    </h5>
                    <a href="/Admin/AttendanceHistory" class="aihub-dash-btn-link">
                        Chi tiết <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                <div class="aihub-dash-card-body">
                    @if (ViewBag.PunctualStaff != null && ViewBag.PunctualStaff.Count > 0)
                    {
                        <div class="aihub-dash-attendance-grid">
                            @foreach (var staff in ViewBag.PunctualStaff)
                            {
                                <div class="aihub-dash-attendance-item">
                                    <div class="aihub-dash-attendance-icon ontime">
                                        <i class="fas fa-user-check"></i>
                                    </div>
                                    <div class="aihub-dash-user-info justify-content-center">
                                        @if (staff.HasAvatar)
                                        {
                                            <img src="@staff.Avatar"
                                                 class="aihub-dash-user-avatar"
                                                 alt="@staff.User.FullName"
                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                                            <div class="aihub-dash-user-avatar"
                                                 style="display:none;background:linear-gradient(135deg,var(--aihub-terracotta),var(--aihub-clay));color:white;">
                                                @staff.Initials
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="aihub-dash-user-avatar"
                                                 style="background:linear-gradient(135deg,var(--aihub-terracotta),var(--aihub-clay));color:white;">
                                                @staff.Initials
                                            </div>
                                        }

                                        <div class="aihub-dash-user-details text-center">
                                            <div class="aihub-dash-user-name">@staff.User.FullName</div>
                                            <small class="aihub-dash-user-meta">@staff.User.Department?.DepartmentName</small>
                                        </div>
                                    </div>
                                    <div class="aihub-dash-attendance-value">@staff.OnTimeCount</div>
                                    <div class="aihub-dash-attendance-label">Ngày đúng giờ</div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="aihub-dash-empty-state">
                            <i class="fas fa-calendar-check"></i>
                            <p>Chưa có dữ liệu chấm công</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- LATE COMERS -->
        <div class="col-lg-4">
            <div class="aihub-dash-card">
                <div class="aihub-dash-card-header">
                    <h5 class="aihub-dash-card-title">
                        <i class="fas fa-user-clock"></i> Top 5 Đi Trễ Nhiều
                    </h5>
                    <a href="/Admin/AttendanceHistory" class="aihub-dash-btn-link">
                        Chi tiết <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                <div class="aihub-dash-card-body">
                    @if (ViewBag.LateComers != null && ViewBag.LateComers.Count > 0)
                    {
                        <div class="aihub-dash-attendance-grid">
                            @foreach (var late in ViewBag.LateComers)
                            {
                                <div class="aihub-dash-attendance-item">
                                    <div class="aihub-dash-attendance-icon late">
                                        <i class="fas fa-user-clock"></i>
                                    </div>
                                    <div class="aihub-dash-user-info justify-content-center">
                                        @if (late.HasAvatar)
                                        {
                                            <img src="@late.Avatar"
                                                 class="aihub-dash-user-avatar"
                                                 alt="@late.User.FullName"
                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                                            <div class="aihub-dash-user-avatar"
                                                 style="display:none;background:linear-gradient(135deg,var(--aihub-terracotta),var(--aihub-clay));color:white;">
                                                @late.Initials
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="aihub-dash-user-avatar"
                                                 style="background:linear-gradient(135deg,var(--aihub-terracotta),var(--aihub-clay));color:white;">
                                                @late.Initials
                                            </div>
                                        }

                                        <div class="aihub-dash-user-details text-center">
                                            <div class="aihub-dash-user-name">@late.User.FullName</div>
                                            <small class="aihub-dash-user-meta">@late.User.Department?.DepartmentName</small>
                                        </div>
                                    </div>
                                    <div class="aihub-dash-attendance-value aihub-dash-text-danger">@late.LateCount</div>
                                    <div class="aihub-dash-attendance-label">Lần đi trễ</div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="aihub-dash-empty-state">
                            <i class="fas fa-smile"></i>
                            <p>Không có nhân viên nào đi trễ!</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- RECENT ACTIVITIES -->
        <div class="col-lg-4">
            <div class="aihub-dash-card">
                <div class="aihub-dash-card-header">
                    <h5 class="aihub-dash-card-title">
                        <i class="fas fa-history"></i> Hoạt Động Gần Đây
                    </h5>
                    <a href="/Admin/AuditLogs" class="aihub-dash-btn-link">
                        Xem tất cả <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                <div class="aihub-dash-card-body">
                    @if (ViewBag.RecentAudits != null && ViewBag.RecentAudits.Count > 0)
                    {
                        <div class="aihub-dash-leaderboard">
                            @foreach (var audit in ViewBag.RecentAudits)
                            {
                                var iconClass = audit.Action == "CREATE" ? "plus" : audit.Action == "UPDATE" ? "edit" : audit.Action == "DELETE" ? "trash" : "eye";
                                var badgeClass = audit.Action == "CREATE" ? "success" : audit.Action == "UPDATE" ? "warning" : audit.Action == "DELETE" ? "danger" : "info";

                                <div class="aihub-dash-leaderboard-item">
                                    <div class="aihub-dash-user-avatar" style="background:linear-gradient(135deg,var(--aihub-terracotta),var(--aihub-clay));color:white;display:flex;justify-content:center;align-items:center;">
                                        @audit.User?.FullName?.Substring(0, 1)
                                    </div>
                                    <div class="aihub-dash-leaderboard-info">
                                        <div class="aihub-dash-leaderboard-name">@audit.User?.FullName</div>
                                        <div class="aihub-dash-leaderboard-dept">@audit.Description</div>
                                        <small class="aihub-dash-user-meta">
                                            <i class="far fa-clock me-1"></i>
                                            @audit.Timestamp?.ToString("HH:mm dd/MM")
                                        </small>
                                    </div>
                                    <span class="aihub-dash-badge aihub-dash-badge-@badgeClass">
                                        <i class="fas fa-@iconClass"></i>
                                    </span>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="aihub-dash-empty-state">
                            <i class="fas fa-history"></i>
                            <p>Chưa có hoạt động nào</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // SET CURRENT DATE
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const today = new Date().toLocaleDateString('vi-VN', options);
        document.getElementById('currentDate').textContent = today;

        // TASK STATUS PIE CHART
        const taskStatusCtx = document.getElementById('taskStatusChart');
        if (taskStatusCtx) {
            new Chart(taskStatusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Chưa bắt đầu', 'Đang làm', 'Hoàn thành'],
                    datasets: [{
                        data: [@ViewBag.TodoTasks, @ViewBag.InProgressTasks, @ViewBag.CompletedTasks],
                        backgroundColor: [
                            'rgba(108, 117, 125, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(40, 167, 69, 0.8)'
                        ],
                        borderColor: [
                            'rgba(108, 117, 125, 1)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(40, 167, 69, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 13,
                                    family: "'Inter', sans-serif"
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // DEPARTMENT PERFORMANCE BAR CHART
            const deptCtx = document.getElementById('departmentChart');
        @if (ViewBag.DepartmentPerformance != null && ViewBag.DepartmentPerformance.Count > 0)
        {
            <text>
                    if (deptCtx) {
                        const deptData = @Html.Raw(Json.Serialize(ViewBag.DepartmentPerformance));
                        const deptLabels = deptData.map(d => d.departmentName);
                        const deptCompleted = deptData.map(d => d.completedTasks);
                        const deptTotal = deptData.map(d => d.totalTasks);
                        const deptPending = deptData.map((d, i) => deptTotal[i] - deptCompleted[i]);

                        new Chart(deptCtx, {
                            type: 'bar',
                            data: {
                                labels: deptLabels,
                                datasets: [
                                    {
                                        label: 'Hoàn thành',
                                        data: deptCompleted,
                                        backgroundColor: 'rgba(40, 167, 69, 0.8)',
                                        borderColor: 'rgba(40, 167, 69, 1)',
                                        borderWidth: 2
                                    },
                                    {
                                        label: 'Chưa hoàn thành',
                                        data: deptPending,
                                        backgroundColor: 'rgba(255, 193, 7, 0.8)',
                                        borderColor: 'rgba(255, 193, 7, 1)',
                                        borderWidth: 2
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                scales: {
                                    x: {
                                        stacked: true,
                                        grid: {
                                            display: false
                                        },
                                        ticks: {
                                            font: {
                                                size: 12,
                                                family: "'Inter', sans-serif"
                                            }
                                        }
                                    },
                                    y: {
                                        stacked: true,
                                        beginAtZero: true,
                                        grid: {
                                            color: 'rgba(0, 0, 0, 0.05)'
                                        },
                                        ticks: {
                                            font: {
                                                size: 12,
                                                family: "'Inter', sans-serif"
                                            }
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            padding: 15,
                                            font: {
                                                size: 13,
                                                family: "'Inter', sans-serif"
                                            }
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.dataset.label || '';
                                                const value = context.parsed.y || 0;
                                                return `${label}: ${value} task`;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
            </text>
        }
                document.addEventListener('DOMContentLoaded', function() {

            // ============================================
            // 1. STAT CARDS - REDIRECT KHI CLICK
            // ============================================

            // Tổng công việc → TaskList
            const totalTasksCard = document.querySelector('.aihub-dash-stat-card.aihub-dash-stat-primary');
            if (totalTasksCard) {
                totalTasksCard.addEventListener('click', function() {
                    createRippleEffect(this, event);
                    setTimeout(() => {
                        window.location.href = '/Admin/TaskList';
                    }, 300);
                });
                addTooltip(totalTasksCard, 'Xem tất cả công việc');
            }

            // Đã hoàn thành → TaskList với filter
            const completedCard = document.querySelector('.aihub-dash-stat-card.aihub-dash-stat-success');
            if (completedCard) {
                completedCard.addEventListener('click', function() {
                    createRippleEffect(this, event);
                    setTimeout(() => {
                        window.location.href = '/Admin/TaskList?status=Done';
                    }, 300);
                });
                addTooltip(completedCard, 'Xem task đã hoàn thành');
            }

            // Đang thực hiện → TaskList với filter
            const inProgressCard = document.querySelector('.aihub-dash-stat-card.aihub-dash-stat-warning');
            if (inProgressCard) {
                inProgressCard.addEventListener('click', function() {
                    createRippleEffect(this, event);
                    setTimeout(() => {
                        window.location.href = '/Admin/TaskList?status=InProgress';
                    }, 300);
                });
                addTooltip(inProgressCard, 'Xem task đang thực hiện');
            }

            // Task quá hạn → TaskList với filter
            const overdueCard = document.querySelector('.aihub-dash-stat-card.aihub-dash-stat-danger');
            if (overdueCard) {
                overdueCard.addEventListener('click', function() {
                    createRippleEffect(this, event);
                    setTimeout(() => {
                        window.location.href = '/Admin/TaskList?status=Overdue';
                    }, 300);
                });
                addTooltip(overdueCard, 'Xem task quá hạn');
            }

            // Chuyên cần → AttendanceHistory
            const attendanceCard = document.querySelector('.aihub-dash-stat-card.aihub-dash-stat-info');
            if (attendanceCard) {
                attendanceCard.addEventListener('click', function() {
                    createRippleEffect(this, event);
                    setTimeout(() => {
                        window.location.href = '/Admin/AttendanceHistory';
                    }, 300);
                });
                addTooltip(attendanceCard, 'Xem lịch sử chấm công');
            }

            // Chưa bắt đầu → TaskList với filter
            const todoCard = document.querySelector('.aihub-dash-stat-card.aihub-dash-stat-secondary');
            if (todoCard) {
                todoCard.addEventListener('click', function() {
                    createRippleEffect(this, event);
                    setTimeout(() => {
                        window.location.href = '/Admin/TaskList?status=TODO';
                    }, 300);
                });
                addTooltip(todoCard, 'Xem task chưa bắt đầu');
            }

            // ============================================
            // 2. LEADERBOARD ITEMS - REDIRECT TO USER DETAIL
            // ============================================
            const leaderboardItems = document.querySelectorAll('.aihub-dash-leaderboard-item');
            leaderboardItems.forEach(item => {
                // Tìm userId từ các thuộc tính có thể có
                const userIdElement = item.querySelector('[data-user-id]');
                if (userIdElement) {
                    const userId = userIdElement.getAttribute('data-user-id');
                    item.style.cursor = 'pointer';

                    item.addEventListener('click', function() {
                        createRippleEffect(this, event);
                        setTimeout(() => {
                            // Có thể mở modal hoặc redirect
                            showUserDetailModal(userId);
                        }, 300);
                    });

                    addTooltip(item, 'Xem chi tiết nhân viên');
                }
            });

            // ============================================
            // 3. TASK ITEMS - REDIRECT TO TASK DETAIL
            // ============================================
            const taskItems = document.querySelectorAll('.aihub-dash-task-item');
            taskItems.forEach(item => {
                const taskIdElement = item.querySelector('[data-task-id]');
                if (taskIdElement) {
                    const taskId = taskIdElement.getAttribute('data-task-id');
                    item.style.cursor = 'pointer';

                    item.addEventListener('click', function() {
                        createRippleEffect(this, event);
                        setTimeout(() => {
                            showTaskDetailModal(taskId);
                        }, 300);
                    });

                    addTooltip(item, 'Xem chi tiết task');
                }
            });

            // ============================================
            // 4. ATTENDANCE ITEMS - REDIRECT
            // ============================================
            const attendanceItems = document.querySelectorAll('.aihub-dash-attendance-item');
            attendanceItems.forEach(item => {
                const userIdElement = item.querySelector('[data-user-id]');
                if (userIdElement) {
                    const userId = userIdElement.getAttribute('data-user-id');
                    item.style.cursor = 'pointer';

                    item.addEventListener('click', function() {
                        createRippleEffect(this, event);
                        setTimeout(() => {
                            window.location.href = `/Admin/AttendanceHistory?userId=${userId}`;
                        }, 300);
                    });

                    addTooltip(item, 'Xem chi tiết chấm công');
                }
            });

            // ============================================
            // HELPER FUNCTIONS
            // ============================================

            /**
             * Tạo hiệu ứng ripple khi click
             */
            function createRippleEffect(element, event) {
                const ripple = document.createElement('span');
                const rect = element.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = event.clientX - rect.left - size / 2;
                const y = event.clientY - rect.top - size / 2;

                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                ripple.classList.add('ripple-effect');

                element.appendChild(ripple);

                setTimeout(() => {
                    ripple.remove();
                }, 600);
            }

            /**
             * Thêm tooltip cho element
             */
            function addTooltip(element, text) {
                element.setAttribute('data-tooltip', text);
                element.classList.add('has-tooltip');
            }

            /**
             * Hiển thị modal chi tiết user (sử dụng hàm có sẵn)
             */
            function showUserDetailModal(userId) {
                if (typeof window.showUserDetail === 'function') {
                    window.showUserDetail(userId);
                } else {
                    // Fallback: redirect
                    window.location.href = `/Admin/UserList?userId=${userId}`;
                }
            }

            /**
             * Hiển thị modal chi tiết task (sử dụng hàm có sẵn)
             */
            function showTaskDetailModal(taskId) {
                if (typeof window.showTaskDetail === 'function') {
                    window.showTaskDetail(taskId);
                } else {
                    // Fallback: redirect
                    window.location.href = `/Admin/EditTask/${taskId}`;
                }
            }

            // ============================================
            // 5. CHART INTERACTIONS
            // ============================================

            // Nếu có Chart.js, thêm click handler
            const taskStatusChart = document.getElementById('taskStatusChart');
            if (taskStatusChart && typeof Chart !== 'undefined') {
                taskStatusChart.addEventListener('click', function(evt) {
                    const chart = Chart.getChart(taskStatusChart);
                    if (chart) {
                        const points = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const firstPoint = points[0];
                            const label = chart.data.labels[firstPoint.index];

                            // Redirect dựa trên label
                            let status = 'TODO';
                            if (label.includes('Đang làm')) status = 'InProgress';
                            else if (label.includes('Hoàn thành')) status = 'Done';

                            window.location.href = `/Admin/TaskList?status=${status}`;
                        }
                    }
                });
            }

            const departmentChart = document.getElementById('departmentChart');
            if (departmentChart && typeof Chart !== 'undefined') {
                departmentChart.addEventListener('click', function(evt) {
                    const chart = Chart.getChart(departmentChart);
                    if (chart) {
                        const points = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const firstPoint = points[0];
                            const label = chart.data.labels[firstPoint.index];

                            // Redirect to department detail or user list filtered by department
                            window.location.href = `/Admin/UserList?department=${encodeURIComponent(label)}`;
                        }
                    }
                });
            }

            // ============================================
            // 6. SMOOTH SCROLL TO SECTIONS
            // ============================================
            const cardLinks = document.querySelectorAll('.aihub-dash-btn-link');
            cardLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    // Nếu link có href bắt đầu bằng #, smooth scroll
                    const href = this.getAttribute('href');
                    if (href && href.startsWith('#')) {
                        e.preventDefault();
                        const target = document.querySelector(href);
                        if (target) {
                            target.scrollIntoView({
                                behavior: 'smooth',
                                block: 'start'
                            });
                        }
                    }
                });
            });

            // ============================================
            // 7. AUTO-REFRESH DATA (OPTIONAL)
            // ============================================
            let autoRefreshInterval;

            function startAutoRefresh(intervalMinutes = 5) {
                autoRefreshInterval = setInterval(() => {
                    console.log('Auto-refreshing dashboard data...');
                    location.reload();
                }, intervalMinutes * 60 * 1000);
            }

            function stopAutoRefresh() {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                }
            }

            // Uncomment để bật auto-refresh sau 5 phút
            // startAutoRefresh(5);

            // ============================================
            // 8. KEYBOARD SHORTCUTS
            // ============================================
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + K: Focus search (nếu có)
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    const searchInput = document.querySelector('input[type="search"]');
                    if (searchInput) searchInput.focus();
                }

                // Ctrl/Cmd + T: Go to TaskList
                if ((e.ctrlKey || e.metaKey) && e.key === 't') {
                    e.preventDefault();
                    window.location.href = '/Admin/TaskList';
                }

                // Ctrl/Cmd + U: Go to UserList
                if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
                    e.preventDefault();
                    window.location.href = '/Admin/UserList';
                }

                // Ctrl/Cmd + A: Go to AttendanceHistory
                if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                    e.preventDefault();
                    window.location.href = '/Admin/AttendanceHistory';
                }
            });

            // ============================================
            // 9. LOADING STATE
            // ============================================
            function showLoadingState(element) {
                element.style.opacity = '0.6';
                element.style.pointerEvents = 'none';

                const spinner = document.createElement('div');
                spinner.className = 'loading-spinner';
                spinner.style.position = 'absolute';
                spinner.style.top = '50%';
                spinner.style.left = '50%';
                spinner.style.transform = 'translate(-50%, -50%)';

                element.style.position = 'relative';
                element.appendChild(spinner);
            }

            function hideLoadingState(element) {
                element.style.opacity = '1';
                element.style.pointerEvents = 'auto';

                const spinner = element.querySelector('.loading-spinner');
                if (spinner) spinner.remove();
            }

            // ============================================
            // 10. NOTIFICATION BADGE UPDATE
            // ============================================
            function updateNotificationBadge() {
                fetch('/Admin/GetPendingCount')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.count > 0) {
                            const badge = document.querySelector('.notification-badge');
                            if (badge) {
                                badge.textContent = data.count;
                                badge.style.display = 'flex';

                                // Animation
                                badge.style.animation = 'none';
                                setTimeout(() => {
                                    badge.style.animation = 'pulse-glow 2s infinite';
                                }, 10);
                            }
                        }
                    })
                    .catch(err => console.error('Error fetching notification count:', err));
            }

            // Update notification badge every 30 seconds
            updateNotificationBadge();
            setInterval(updateNotificationBadge, 30000);

            // ============================================
            // 11. PRINT DASHBOARD
            // ============================================
            window.printDashboard = function() {
                window.print();
            };

            // ============================================
            // 12. EXPORT DASHBOARD DATA
            // ============================================
            window.exportDashboardData = function() {
                // Collect all stats
                const stats = {
                    totalTasks: document.querySelector('.aihub-dash-stat-primary .aihub-dash-stat-value')?.textContent,
                    completedTasks: document.querySelector('.aihub-dash-stat-success .aihub-dash-stat-value')?.textContent,
                    inProgressTasks: document.querySelector('.aihub-dash-stat-warning .aihub-dash-stat-value')?.textContent,
                    overdueTasks: document.querySelector('.aihub-dash-stat-danger .aihub-dash-stat-value')?.textContent,
                    exportDate: new Date().toISOString()
                };

                // Convert to CSV or JSON
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(stats, null, 2));
                const downloadAnchor = document.createElement('a');
                downloadAnchor.setAttribute("href", dataStr);
                downloadAnchor.setAttribute("download", `dashboard_${Date.now()}.json`);
                document.body.appendChild(downloadAnchor);
                downloadAnchor.click();
                downloadAnchor.remove();
            };

            console.log('✅ Dashboard interactions loaded successfully!');
        });

        // ============================================
        // CSS cho ripple effect
        // ============================================
        const style = document.createElement('style');
        style.textContent = `
            .ripple-effect {
                position: absolute;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.6);
                transform: scale(0);
                animation: ripple-animation 0.6s ease-out;
                pointer-events: none;
            }

       

            .has-tooltip {
                position: relative;
            }

            .has-tooltip::after {
                content: attr(data-tooltip);
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%) translateY(-8px);
                padding: 0.5rem 0.75rem;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                font-size: 0.875rem;
                font-weight: 500;
                border-radius: 0.5rem;
                white-space: nowrap;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s, transform 0.3s;
                z-index: 1000;
            }

            .has-tooltip:hover::after {
                opacity: 1;
                transform: translateX(-50%) translateY(-12px);
            }

            .loading-spinner {
                border: 3px solid rgba(0, 0, 0, 0.1);
                border-top-color: var(--primary, #6366f1);
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 0.8s linear infinite;
            }

       
            }
        `;
        document.head.appendChild(style);
            // AUTO REFRESH EVERY 5 MINUTES
            setTimeout(() => {
                location.reload();
            }, 300000);
    </script>
}