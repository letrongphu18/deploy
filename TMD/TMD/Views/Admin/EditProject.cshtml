@model TMD.Models.Project

@{
    ViewData["Title"] = $"Chỉnh sửa - {Model.ProjectName}";
}

<link rel="stylesheet" href="~/css/project-management.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
<link href="~/css/sweetalert2-custom.css" rel="stylesheet" />

<div class="pm-container">
    <div class="pm-page-header">
        <div class="pm-header-content">
            <div>
                <h1 class="pm-page-title"><i class="fas fa-edit"></i> Chỉnh sửa dự án</h1>
                <p class="pm-page-subtitle">@Model.ProjectCode - @Model.ProjectName</p>
            </div>
            <a href="@Url.Action("ProjectDetail", "Admin", new { id = Model.ProjectId })" class="pm-btn pm-btn-secondary">
                <i class="fas fa-arrow-left"></i> Quay lại Chi tiết Dự án
            </a>
        </div>
    </div>

    <div class="pm-card">
        <div class="pm-card-header">
            <h5 class="pm-card-title"><i class="fas fa-info-circle"></i> Thông tin dự án</h5>
        </div>
        <div class="pm-card-body">
            <form id="editProjectForm">
                <input type="hidden" id="projectId" value="@Model.ProjectId" />

                <div class="pm-form-row">
                    <div class="pm-form-group">
                        <label class="pm-form-label">Mã dự án</label>
                        <input type="text" class="pm-form-control" value="@Model.ProjectCode" disabled style="background: #f1f5f9;" />
                    </div>
                    <div class="pm-form-group">
                        <label class="pm-form-label required">Tên dự án</label>
                        <input type="text" id="projectName" class="pm-form-control" value="@Model.ProjectName" required />
                    </div>
                </div>

                <div class="pm-form-group">
                    <label class="pm-form-label">Mô tả</label>
                    <textarea id="description" class="pm-form-textarea">@Model.Description</textarea>
                </div>

                <div class="pm-form-row">
                    <div class="pm-form-group">
                        <label class="pm-form-label">Leader</label>
                        <select id="leaderId" class="pm-form-select">
                            <option value="">-- Chọn Leader --</option>
                            @foreach (var user in ViewBag.Users as List<TMD.Models.User>)
                            {
                                @if (user.UserId == Model.LeaderId)
                                {
                                    <option value="@user.UserId" selected>@user.FullName</option>
                                }
                                else
                                {
                                    <option value="@user.UserId">@user.FullName</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="pm-form-group">
                        <label class="pm-form-label">Phòng ban</label>
                        <select id="departmentId" class="pm-form-select">
                            @foreach (var dept in ViewBag.Departments as List<TMD.Models.Department>)
                            {
                                @if (dept.DepartmentId == Model.DepartmentId)
                                {
                                    <option value="@dept.DepartmentId" selected>@dept.DepartmentName</option>
                                }
                                else
                                {
                                    <option value="@dept.DepartmentId">@dept.DepartmentName</option>
                                }
                            }
                        </select>
                    </div>
                </div>

                <div class="pm-form-row">
                    <div class="pm-form-group">
                        <label class="pm-form-label">Trạng thái</label>
                        <select id="status" class="pm-form-select">
                            @{
                                var statuses = new Dictionary<string, string> {
                            {"Planning", "Lên kế hoạch"},
                            {"InProgress", "Đang triển khai"},
                            {"Completed", "Hoàn thành"},
                            {"OnHold", "Tạm dừng"}
                            };
                            }
                            @foreach (var status in statuses)
                            {
                                @if (Model.Status == status.Key)
                                {
                                    <option value="@status.Key" selected>@status.Value</option>
                                }
                                else
                                {
                                    <option value="@status.Key">@status.Value</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="pm-form-group">
                        <label class="pm-form-label">Độ ưu tiên</label>
                        <select id="priority" class="pm-form-select">
                            @{
                                var priorities = new List<string> { "Low", "Medium", "High" };
                            }
                            @foreach (var priority in priorities)
                            {
                                @if (Model.Priority == priority)
                                {
                                    <option value="@priority" selected>@priority</option>
                                }
                                else
                                {
                                    <option value="@priority">@priority</option>
                                }
                            }
                        </select>
                    </div>
                </div>

                <div class="pm-d-flex pm-gap-2 pm-mt-3">
                    <button type="submit" class="pm-btn pm-btn-primary"><i class="fas fa-save"></i> Lưu thay đổi</button>
                    <a href="@Url.Action("ProjectDetail", "Admin", new { id = Model.ProjectId })" class="pm-btn pm-btn-info">
                        <i class="fas fa-tasks"></i> Quản lý Task/Thành viên
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const projectId = @Model.ProjectId;

        // --- UPDATE PROJECT FORM ---
        document.getElementById('editProjectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const data = {
                projectId: projectId,
                projectName: document.getElementById('projectName').value.trim(),
                description: document.getElementById('description').value.trim(),
                leaderId: parseInt(document.getElementById('leaderId').value) || null,
                departmentId: parseInt(document.getElementById('departmentId').value) || null,
                status: document.getElementById('status').value,
                priority: document.getElementById('priority').value
            };

            try {
                const response = await fetch('@Url.Action("UpdateProject", "Admin")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const res = await response.json();
                if(res.success) {
                    Swal.fire({ icon: 'success', title: 'Thành công', text: res.message, timer: 1500, showConfirmButton: false });
                } else {
                    Swal.fire('Lỗi', res.message, 'error');
                }
            } catch(e) { Swal.fire('Lỗi', e.message, 'error'); }
        });
    </script>
}