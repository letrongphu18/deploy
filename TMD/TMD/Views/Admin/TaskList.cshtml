@model List<TMD.Models.Task>
@{
    ViewData["Title"] = "Quản lý Task";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/css/tasklist-ad.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">

<div class="tl-container">
    <!-- Header Section -->
    <div class="tl-page-header">
        <div class="tl-d-flex tl-justify-between tl-align-center">
            <div>
                <h1 class="tl-page-title">
                    <i class="fas fa-tasks"></i> Quản lý Task
                </h1>
                <p class="tl-page-subtitle">Theo dõi và quản lý tất cả các task của hệ thống</p>
            </div>
            <a asp-action="CreateTask" class="tl-btn-create">
                <i class="fas fa-plus"></i> Tạo Task mới
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="tl-stats-grid">
        <div class="tl-stats-card tl-stats-secondary">
            <div class="tl-stats-icon"><i class="fas fa-inbox"></i></div>
            <div class="tl-stats-content">
                <div class="tl-stats-label">TODO</div>
                <div class="tl-stats-value">@ViewBag.TodoTasks</div>
            </div>
        </div>

        <div class="tl-stats-card tl-stats-warning">
            <div class="tl-stats-icon"><i class="fas fa-spinner"></i></div>
            <div class="tl-stats-content">
                <div class="tl-stats-label">Đang làm</div>
                <div class="tl-stats-value">@ViewBag.InProgressTasks</div>
            </div>
        </div>

        <div class="tl-stats-card tl-stats-info">
            <div class="tl-stats-icon"><i class="fas fa-vial"></i></div>
            <div class="tl-stats-content">
                <div class="tl-stats-label">Chờ test</div>
                <div class="tl-stats-value">@ViewBag.TestingTasks</div>
            </div>
        </div>

        <div class="tl-stats-card tl-stats-success">
            <div class="tl-stats-icon"><i class="fas fa-check-circle"></i></div>
            <div class="tl-stats-content">
                <div class="tl-stats-label">Hoàn thành</div>
                <div class="tl-stats-value">@ViewBag.CompletedTasks</div>
            </div>
            <div class="tl-stats-trend">
                <span class="tl-completion-rate">@ViewBag.TaskCompletionRate%</span>
            </div>
        </div>

        <div class="tl-stats-card tl-stats-danger">
            <div class="tl-stats-icon"><i class="fas fa-redo"></i></div>
            <div class="tl-stats-content">
                <div class="tl-stats-label">Reopen</div>
                <div class="tl-stats-value">@ViewBag.ReopenTasks</div>
            </div>
        </div>

        <div class="tl-stats-card tl-stats-primary">
            <div class="tl-stats-icon"><i class="fas fa-tasks"></i></div>
            <div class="tl-stats-content">
                <div class="tl-stats-label">Tổng tasks</div>
                <div class="tl-stats-value">@ViewBag.TotalTasks</div>
            </div>
        </div>
    </div>

    <!-- Filters & Sorting Card -->
    <div class="tl-card tl-mb-4">
        <div class="tl-filters-header">
            <h6><i class="fas fa-filter"></i> Bộ lọc & Sắp xếp</h6>
        </div>
        <div class="tl-card-body">
            <form id="filterForm">
                <div class="tl-row">
                    <!-- Search -->
                    <div class="tl-col-3">
                        <label class="tl-form-label">Tìm kiếm</label>
                        <div class="tl-search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchTask" class="tl-form-control" placeholder="Tên task, mô tả...">
                        </div>
                    </div>

                    <!-- Platform Filter -->
                    <div class="tl-col-2">
                        <label class="tl-form-label">Platform</label>
                        <select id="filterPlatform" class="tl-form-control">
                            <option value="">Tất cả</option>
                            <option value="Web">Web</option>
                            <option value="Mobile">Mobile</option>
                            <option value="Desktop">Desktop</option>
                            <option value="API">API</option>
                        </select>
                    </div>

                    <!-- Priority Filter -->
                    <div class="tl-col-2">
                        <label class="tl-form-label">Priority</label>
                        <select id="filterPriority" class="tl-form-control">
                            <option value="">Tất cả</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>

                    <!-- Status Filter -->
                    <div class="tl-col-2">
                        <label class="tl-form-label">Trạng thái</label>
                        <select id="filterStatus" class="tl-form-control">
                            <option value="">Tất cả</option>
                            <option value="TODO">TODO</option>
                            <option value="InProgress">Đang làm</option>
                            <option value="Testing">Chờ test</option>
                            <option value="Done">Hoàn thành</option>
                            <option value="Reopen">Reopen</option>
                        </select>
                    </div>

                    <!-- Active Filter -->
                    <div class="tl-col-2">
                        <label class="tl-form-label">Active</label>
                        <select id="filterActive" class="tl-form-control">
                            <option value="">Tất cả</option>
                            <option value="true">Có</option>
                            <option value="false">Không</option>
                        </select>
                    </div>

                    <!-- Deadline Filter -->
                    <div class="tl-col-2">
                        <label class="tl-form-label">Deadline</label>
                        <select id="filterDeadline" class="tl-form-control">
                            <option value="">Tất cả</option>
                            <option value="overdue">Quá hạn</option>
                            <option value="today">Hôm nay</option>
                            <option value="week">Tuần này</option>
                            <option value="month">Tháng này</option>
                        </select>
                    </div>

                    <!-- Sort By -->
                    <div class="tl-col-2">
                        <label class="tl-form-label">Sắp xếp theo</label>
                        <select id="sortBy" class="tl-form-control">
                            <option value="id-desc">ID (Mới nhất)</option>
                            <option value="id-asc">ID (Cũ nhất)</option>
                            <option value="name-asc">Tên (A-Z)</option>
                            <option value="name-desc">Tên (Z-A)</option>
                            <option value="deadline-asc">Deadline (Gần nhất)</option>
                            <option value="deadline-desc">Deadline (Xa nhất)</option>
                            <option value="priority-desc">Priority (High-Low)</option>
                            <option value="priority-asc">Priority (Low-High)</option>
                        </select>
                    </div>

                    <!-- Reset Button -->
                    <div class="tl-col-1 tl-flex-end">
                        <button type="button" id="resetFilters" class="tl-btn-secondary w-100">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Task Table Card -->
    <div class="tl-card">
        <div class="tl-card-header">
            <h5 class="tl-mb-0"><i class="fas fa-list"></i> Danh sách Task</h5>
        </div>
        <div class="tl-card-body-table">
            <div class="tl-table-wrapper">
                <table class="tl-table" id="taskTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th width="5%">ID</th>
                            <th width="22%">Tên Task</th>
                            <th width="10%">Platform</th>
                            <th width="12%">Deadline</th>
                            <th width="8%">Priority</th>
                            <th width="28%">Người làm & Trạng thái</th>
                            <th width="7%">Active</th>
                            <th width="8%">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var task in Model)
                        {
                            var totalAssigned = task.UserTasks.Count;
                            var completedCount = task.UserTasks.Count(ut => ut.Status == "Done");
                            var isTaskCompleted = totalAssigned > 0 && completedCount == totalAssigned;
                            var isOverdue = task.Deadline.HasValue && !isTaskCompleted && DateTime.Now > task.Deadline.Value;
                            var rowClass = isOverdue ? "tl-row-overdue" : "";

                            // Determine task status
                            var taskStatus = "";
                            if (totalAssigned > 0)
                            {
                                var statuses = task.UserTasks.Select(ut => ut.Status).ToList();
                                if (statuses.All(s => s == "Done")) taskStatus = "Done";
                                else if (statuses.Any(s => s == "Reopen")) taskStatus = "Reopen";
                                else if (statuses.Any(s => s == "Testing")) taskStatus = "Testing";
                                else if (statuses.Any(s => s == "InProgress")) taskStatus = "InProgress";
                                else taskStatus = "TODO";
                            }

                            <tr class="@rowClass task-row"
                                data-task-id="@task.TaskId"
                                data-platform="@(task.Platform ?? "")"
                                data-priority="@task.Priority"
                                data-status="@taskStatus"
                                data-active="@task.IsActive.ToString().ToLower()"
                                data-deadline="@(task.Deadline?.ToString("yyyy-MM-dd") ?? "")"
                                data-task-name="@task.TaskName.ToLower()"
                                data-description="@(task.Description?.ToLower() ?? "")">
                                <td class="tl-text-center">
                                    <span class="tl-task-id">#@task.TaskId</span>
                                </td>
                                <td>
                                    <div class="tl-task-info">
                                        <div class="tl-task-icon">
                                            <i class="fas fa-clipboard-list"></i>
                                        </div>
                                        <div class="tl-task-details">
                                            <div class="tl-task-name">@task.TaskName</div>
                                            @if (!string.IsNullOrEmpty(task.Description))
                                            {
                                                <div class="tl-task-description">@task.Description</div>
                                            }
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(task.Platform))
                                    {
                                        <span class="tl-badge tl-badge-info">
                                            <i class="fas fa-globe"></i>@task.Platform
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="tl-text-muted">—</span>
                                    }
                                </td>
                                <td>
                                    @if (task.Deadline.HasValue)
                                    {
                                        <div class="tl-deadline-wrapper @(isOverdue ? "is-overdue" : "")">
                                            <div class="tl-deadline-date">
                                                <i class="far fa-calendar-alt"></i>
                                                @task.Deadline.Value.ToString("dd/MM/yyyy")
                                            </div>
                                            <div class="tl-deadline-time">@task.Deadline.Value.ToString("HH:mm")</div>
                                            @if (isOverdue)
                                            {
                                                <span class="tl-badge tl-badge-danger tl-mt-1">
                                                    <i class="fas fa-exclamation-circle"></i>Quá hạn
                                                </span>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="tl-text-muted">Không có</span>
                                    }
                                </td>
                                <td>
                                    @{
                                        var priorityClass = task.Priority switch
                                        {
                                            "High" => "tl-badge-danger",
                                            "Medium" => "tl-badge-warning",
                                            "Low" => "tl-badge-success",
                                            _ => "tl-badge-secondary"
                                        };
                                    }
                                    <span class="tl-badge @priorityClass">
                                        @task.Priority
                                    </span>
                                </td>

                                <td>
                                    @if (totalAssigned > 0)
                                    {
                                        <div class="tl-user-status-list">
                                            @foreach (var ut in task.UserTasks.Take(3))
                                            {
                                                var statusClass = ut.Status switch
                                                {
                                                    "TODO" => "secondary",
                                                    "InProgress" => "warning",
                                                    "Testing" => "info",
                                                    "Done" => "success",
                                                    "Reopen" => "danger",
                                                    _ => "secondary"
                                                };

                                                var statusText = ut.Status switch
                                                {
                                                    "TODO" => "Chưa bắt đầu",
                                                    "InProgress" => "Đang làm",
                                                    "Testing" => "Chờ test",
                                                    "Done" => "Hoàn thành",
                                                    "Reopen" => "Reopen",
                                                    _ => "Chưa bắt đầu"
                                                };

                                                <div class="tl-user-status-item">
                                                    <div class="tl-user-avatar-wrapper">
                                                        @if (!string.IsNullOrEmpty(ut.User.Avatar) && ut.User.Avatar != "/images/default-avatar.png")
                                                        {
                                                            <img src="@ut.User.Avatar"
                                                                 alt="@ut.User.FullName"
                                                                 class="tl-user-avatar-sm"
                                                                 onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                                                            <div class="tl-user-avatar-sm"
                                                                 style="display:none;background:linear-gradient(135deg,#667eea,#764ba2);color:white;align-items:center;justify-content:center;font-weight:700;font-size:11px;">
                                                                @ut.User.FullName.Substring(0, 1).ToUpper()
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <div class="tl-user-avatar-sm"
                                                                 style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;">
                                                                @ut.User.FullName.Substring(0, 1).ToUpper()
                                                            </div>
                                                        }
                                                        <span class="tl-user-name">@ut.User.FullName</span>
                                                    </div>
                                                    <span class="tl-badge tl-badge-@statusClass tl-badge-sm">
                                                        @statusText
                                                    </span>
                                                </div>
                                            }
                                            @if (task.UserTasks.Count > 3)
                                            {
                                                <div class="tl-text-muted tl-text-sm">
                                                    +@(task.UserTasks.Count - 3) người khác
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="tl-text-muted">Chưa assign</span>
                                    }
                                </td>

                                <td>
                                    <span class="tl-badge @(task.IsActive == true ? "tl-badge-success" : "tl-badge-secondary")">
                                        @(task.IsActive == true ? "Có" : "Không")
                                    </span>
                                </td>
                                <td onclick="event.stopPropagation();">
                                    <div class="tl-action-buttons">
                                        @if (task.IsActive == true)
                                        {
                                            <a asp-action="EditTask" asp-route-id="@task.TaskId"
                                               class="tl-btn-action tl-btn-action-warning" title="Chỉnh sửa">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="tl-btn-action tl-btn-action-danger btn-delete"
                                                    data-id="@task.TaskId" data-name="@task.TaskName" title="Ẩn">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        }
                                        else
                                        {
                                            <button type="button" class="tl-btn-action tl-btn-action-success btn-restore"
                                                    data-id="@task.TaskId" data-name="@task.TaskName" title="Khôi phục">
                                                <i class="fas fa-undo"></i>
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Task Detail Modal -->
<div class="modal fade tl-modal" id="taskDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="tl-modal-header">
                <h5 class="tl-modal-title">
                    <i class="fas fa-info-circle"></i> Chi tiết Task
                </h5>
                <button type="button" class="tl-btn-close" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="tl-modal-body" id="taskDetailContent">
                <div class="tl-loading">
                    <div class="spinner-border" role="status"></div>
                    <p class="tl-mt-3 tl-text-muted">Đang tải...</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ✅ INIT DATATABLE
            let table;
            if (typeof $ !== 'undefined' && $.fn.DataTable) {
                table = $('#taskTable').DataTable({
                    language: {
                        url: '//cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json',
                        paginate: {
                            first: "Đầu",
                            last: "Cuối",
                            next: "Sau",
                            previous: "Trước"
                        },
                        info: "Hiển thị _START_ đến _END_ của _TOTAL_ task",
                        infoEmpty: "Không có dữ liệu",
                        emptyTable: "Chưa có task nào",
                        search: "Tìm kiếm:",
                        lengthMenu: "Hiển thị _MENU_ task"
                    },
                    order: [[0, 'desc']],
                    pageLength: 10,
                    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Tất cả"]],
                    responsive: true,
                    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
                    drawCallback: function() {
                        attachEventListeners();
                        applyFilters();
                    }
                });

                console.log('✅ DataTable initialized');
            }

            // ✅ FILTER & SORT FUNCTIONALITY
            function applyFilters() {
                const searchVal = document.getElementById('searchTask').value.toLowerCase();
                const platformVal = document.getElementById('filterPlatform').value;
                const priorityVal = document.getElementById('filterPriority').value;
                const statusVal = document.getElementById('filterStatus').value;
                const activeVal = document.getElementById('filterActive').value;
                const deadlineVal = document.getElementById('filterDeadline').value;
                const sortVal = document.getElementById('sortBy').value;

                // Get all rows
                let rows = Array.from(document.querySelectorAll('.task-row'));

                // Filter rows
                rows.forEach(row => {
                    let show = true;

                    // Search filter
                    if (searchVal) {
                        const name = row.dataset.taskName || '';
                        const desc = row.dataset.description || '';
                        if (!name.includes(searchVal) && !desc.includes(searchVal)) {
                            show = false;
                        }
                    }

                    // Platform filter
                    if (platformVal && row.dataset.platform !== platformVal) {
                        show = false;
                    }

                    // Priority filter
                    if (priorityVal && row.dataset.priority !== priorityVal) {
                        show = false;
                    }

                    // Status filter
                    if (statusVal && row.dataset.status !== statusVal) {
                        show = false;
                    }

                    // Active filter
                    if (activeVal && row.dataset.active !== activeVal) {
                        show = false;
                    }

                    // Deadline filter
                    if (deadlineVal && row.dataset.deadline) {
                        const deadline = new Date(row.dataset.deadline);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        const isOverdue = row.classList.contains('tl-row-overdue');

                        if (deadlineVal === 'overdue' && !isOverdue) show = false;
                        if (deadlineVal === 'today') {
                            const isSameDay = deadline.toDateString() === today.toDateString();
                            if (!isSameDay) show = false;
                        }
                        if (deadlineVal === 'week') {
                            const weekLater = new Date(today);
                            weekLater.setDate(today.getDate() + 7);
                            if (deadline < today || deadline > weekLater) show = false;
                        }
                        if (deadlineVal === 'month') {
                            const monthLater = new Date(today);
                            monthLater.setMonth(today.getMonth() + 1);
                            if (deadline < today || deadline > monthLater) show = false;
                        }
                    }

                    row.style.display = show ? '' : 'none';
                });

                // Sort rows
                const tbody = document.querySelector('#taskTable tbody');
                const visibleRows = rows.filter(row => row.style.display !== 'none');

                visibleRows.sort((a, b) => {
                    const [field, order] = sortVal.split('-');
                    let aVal, bVal;

                    switch(field) {
                        case 'id':
                            aVal = parseInt(a.dataset.taskId);
                            bVal = parseInt(b.dataset.taskId);
                            break;
                        case 'name':
                            aVal = a.dataset.taskName;
                            bVal = b.dataset.taskName;
                            break;
                        case 'deadline':
                            aVal = a.dataset.deadline || '9999-12-31';
                            bVal = b.dataset.deadline || '9999-12-31';
                            break;
                        case 'priority':
                            const priorityOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
                            aVal = priorityOrder[a.dataset.priority] || 0;
                            bVal = priorityOrder[b.dataset.priority] || 0;
                            break;
                    }

                    if (order === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });

                // Reorder in DOM
                visibleRows.forEach(row => tbody.appendChild(row));
            }

            // Filter event listeners
            ['searchTask', 'filterPlatform', 'filterPriority', 'filterStatus', 'filterActive', 'filterDeadline', 'sortBy'].forEach(id => {
                document.getElementById(id).addEventListener('change', applyFilters);
                document.getElementById(id).addEventListener('keyup', applyFilters);
            });

            // Reset filters
            document.getElementById('resetFilters').addEventListener('click', function() {
                document.getElementById('searchTask').value = '';
                document.getElementById('filterPlatform').value = '';
                document.getElementById('filterPriority').value = '';
                document.getElementById('filterStatus').value = '';
                document.getElementById('filterActive').value = '';
                document.getElementById('filterDeadline').value = '';
                document.getElementById('sortBy').value = 'id-desc';
                applyFilters();
            });

            // ✅ ATTACH EVENT LISTENERS
            function attachEventListeners() {
                // ROW CLICK TO VIEW DETAIL
                document.querySelectorAll('.task-row').forEach(row => {
                    row.removeEventListener('click', handleRowClick);
                    row.addEventListener('click', handleRowClick);
                });

                // DELETE & RESTORE BUTTONS
                document.querySelectorAll('.btn-delete, .btn-restore').forEach(btn => {
                    btn.removeEventListener('click', handleDeleteRestore);
                    btn.addEventListener('click', handleDeleteRestore);
                });
            }

            function handleRowClick(e) {
                if (e.target.closest('.tl-action-buttons') ||
                    e.target.closest('a') ||
                    e.target.closest('button')) {
                    return;
                }
                const taskId = this.dataset.taskId;
                viewTaskDetail(taskId);
            }

            function handleDeleteRestore(e) {
                e.preventDefault();
                e.stopPropagation();

                const isDelete = this.classList.contains('btn-delete');
                const taskId = this.dataset.id;
                const taskName = this.dataset.name;
                const msg = isDelete ? `Ẩn task "${taskName}"?` : `Khôi phục task "${taskName}"?`;

                if (confirm(`Bạn có chắc muốn ${msg}`)) {
                    isDelete ? deleteTask(taskId) : restoreTask(taskId);
                }
            }

            attachEventListeners();

            function showToast(message, type = 'info') {
                const toastClass = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
                const toast = document.createElement('div');
                toast.className = toastClass;
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                toast.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);
            }

            function viewTaskDetail(taskId) {
                const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
                const content = document.getElementById('taskDetailContent');

                content.innerHTML = '<div class="tl-loading"><div class="spinner-border" role="status"></div><p class="tl-mt-3 tl-text-muted">Đang tải...</p></div>';

                modal.show();

                fetch(`/Admin/GetTaskDetails?id=${taskId}`)
                    .then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json();
                    })
                    .then(data => {
                        if (!data || !data.success) {
                            content.innerHTML = `<div class="alert alert-danger m-3">Lỗi: ${data?.message || 'Không thể tải dữ liệu'}</div>`;
                            return;
                        }

                        const t = data.task || {};

                        // Safe value extraction with defaults
                        const taskId = t.taskId || t.TaskId || 'N/A';
                        const taskName = t.taskName || t.TaskName || 'Không có tên';
                        const description = t.description || t.Description || 'Không có mô tả';
                        const platform = t.platform || t.Platform || 'N/A';
                        const priority = t.priority || t.Priority || 'Medium';
                        const deadlineStr = t.deadlineStr || t.DeadlineStr || '';
                        const isActive = t.isActive !== undefined ? t.isActive : (t.IsActive !== undefined ? t.IsActive : false);
                        const createdAtStr = t.createdAtStr || t.CreatedAtStr || 'N/A';
                        const updatedAtStr = t.updatedAtStr || t.UpdatedAtStr || 'N/A';

                        // Statistics
                        const todoCount = t.todoCount || t.TodoCount || 0;
                        const inProgressCount = t.inProgressCount || t.InProgressCount || 0;
                        const testingCount = t.testingCount || t.TestingCount || 0;
                        const doneCount = t.doneCount || t.DoneCount || 0;
                        const reopenCount = t.reopenCount || t.ReopenCount || 0;

                        const priorityBg = priority === 'High' ? 'danger' : priority === 'Medium' ? 'warning' : 'success';
                        const statusBg = isActive ? 'success' : 'secondary';

                        // Assigned users
                        const assignedUsers = t.assignedUsers || t.AssignedUsers || [];

                        let usersHTML = '';
                        if (assignedUsers.length > 0) {
                            usersHTML = assignedUsers.map(u => {
                                const statusClass = u.statusClass || u.StatusClass || 'secondary';
                                const statusBg = statusClass === 'success' ? 'bg-success' :
                                                 statusClass === 'warning' ? 'bg-warning' :
                                                 statusClass === 'info' ? 'bg-info' :
                                                 statusClass === 'danger' ? 'bg-danger' : 'bg-secondary';

                                const fullName = u.fullName || u.FullName || 'N/A';
                                const deptName = u.departmentName || u.DepartmentName || 'N/A';
                                const statusText = u.statusText || u.StatusText || 'N/A';
                                const reportLink = u.reportLink || u.ReportLink || '';
                                const updatedAt = u.updatedAtStr || u.UpdatedAtStr || 'Chưa cập nhật';
                                const avatar = u.avatar || u.Avatar;

                                let avatarHTML = avatar ?
                                    `<img src="${avatar}" alt="${fullName}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;margin-right:10px;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                                     <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:white;display:none;align-items:center;justify-content:center;font-weight:700;margin-right:10px;font-size:14px;">${fullName.substring(0,1).toUpperCase()}</div>` :
                                    `<div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;margin-right:10px;font-size:14px;">${fullName.substring(0,1).toUpperCase()}</div>`;

                                return `
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                ${avatarHTML}
                                                <div>
                                                    <div class="fw-bold">${fullName}</div>
                                                    <small class="text-muted">${deptName}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td><span class="badge ${statusBg}">${statusText}</span></td>
                                        <td>${reportLink ? `<a href="${reportLink}" target="_blank" class="link-primary"><i class="fas fa-external-link-alt"></i> Xem</a>` : '<span class="text-muted">—</span>'}</td>
                                        <td><small class="text-muted">${updatedAt}</small></td>
                                    </tr>
                                `;
                            }).join('');
                        } else {
                            usersHTML = '<tr><td colspan="4" class="text-center text-muted py-3">Chưa có người được giao</td></tr>';
                        }

                        content.innerHTML = `
                            <div class="p-4">
                                <div class="mb-4 pb-3 border-bottom">
                                    <h5 class="mb-2 fw-bold">${taskName}</h5>
                                    <p class="text-muted mb-3">${description}</p>

                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <small class="text-muted d-block mb-1"><i class="fas fa-globe me-1"></i>Platform</small>
                                            <strong>${platform}</strong>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block mb-1"><i class="fas fa-flag me-1"></i>Priority</small>
                                            <span class="badge bg-${priorityBg}">${priority}</span>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block mb-1"><i class="far fa-calendar me-1"></i>Deadline</small>
                                            <strong>${deadlineStr || '<span class="text-muted">Không có</span>'}</strong>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block mb-1"><i class="fas fa-toggle-on me-1"></i>Status</small>
                                            <span class="badge bg-${statusBg}">${isActive ? 'Hoạt động' : 'Ẩn'}</span>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block mb-1"><i class="fas fa-info-circle me-1"></i>Thời gian</small>
                                            <small class="text-muted">Tạo: ${createdAtStr}<br>Cập nhật: ${updatedAtStr}</small>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block mb-1"><i class="fas fa-chart-pie me-1"></i>Statistics</small>
                                            <small>TODO: ${todoCount} | Đang làm: ${inProgressCount} | Testing: ${testingCount}<br>Done: ${doneCount} | Reopen: ${reopenCount}</small>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <h6 class="mb-3 fw-bold"><i class="fas fa-users me-2"></i>Danh sách người làm (${assignedUsers.length})</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Người làm</th>
                                                    <th>Trạng thái</th>
                                                    <th>Báo cáo</th>
                                                    <th>Cập nhật</th>
                                                </tr>
                                            </thead>
                                            <tbody>${usersHTML}</tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    })
                    .catch(err => {
                        console.error('❌ Error:', err);
                        content.innerHTML = `<div class="alert alert-danger m-3">Lỗi tải dữ liệu: ${err.message}</div>`;
                    });
            }

            function deleteTask(taskId) {
                fetch('@Url.Action("DeleteTask", "Admin")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ taskId: parseInt(taskId) })
                })
                .then(r => r.json())
                .then(data => {
                    showToast(data.message, data.success ? 'success' : 'danger');
                    if (data.success) setTimeout(() => location.reload(), 1000);
                })
                .catch(() => showToast('Lỗi xảy ra!', 'danger'));
            }

            function restoreTask(taskId) {
                fetch('@Url.Action("ToggleTaskStatus", "Admin")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ taskId: parseInt(taskId) })
                })
                .then(r => r.json())
                .then(data => {
                    showToast(data.message, data.success ? 'success' : 'danger');
                    if (data.success) setTimeout(() => location.reload(), 1000);
                })
                .catch(() => showToast('Lỗi xảy ra!', 'danger'));
            }
        });
    </script>
}