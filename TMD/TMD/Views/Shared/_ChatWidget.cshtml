<!-- ============================================
     CHAT WIDGET - OPTIMIZED & FIXED VERSION
     ============================================ -->

<style>
    /* ========== CHAT WIDGET STYLES ========== */
    :root {
        --widget-primary: #6366f1;
        --widget-success: #10b981;
        --widget-danger: #ef4444;
    }

    /* Chat Float Button */
    .chat-widget-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        transition: all 0.3s ease;
        z-index: 9998;
        border: none;
    }

        .chat-widget-btn:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.6);
        }

        .chat-widget-btn i {
            color: white;
            font-size: 26px;
        }

    .chat-widget-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: linear-gradient(135deg, var(--widget-danger), #dc2626);
        color: white;
        min-width: 22px;
        height: 22px;
        border-radius: 11px;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 700;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

        .chat-widget-badge.show {
            display: flex;
            animation: badgePulse 2s infinite;
        }

    keyframes badgePulse {
        0%, 100%

    {
        transform: scale(1);
    }

    50% {
        transform: scale(1.1);
    }

    }

    /* Chat Popup Window */
    .chat-widget-popup {
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 420px;
        height: 600px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2);
        display: none;
        flex-direction: column;
        z-index: 9999;
        overflow: hidden;
        animation: slideUpFade 0.3s ease;
    }

    body.staff-dark-mode .chat-widget-popup,
    body.dark-mode .chat-widget-popup {
        background: #1e293b;
    }

    .chat-widget-popup.show {
        display: flex;
    }

    keyframes slideUpFade {
        from

    {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }

    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }

    }

    /* Popup Header */
    .chat-widget-header {
        padding: 20px;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

        .chat-widget-header h5 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

    .chat-widget-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

        .chat-widget-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

    /* Tabs */
    .chat-widget-tabs {
        display: flex;
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
    }

    body.staff-dark-mode .chat-widget-tabs,
    body.dark-mode .chat-widget-tabs {
        background: #0f172a;
        border-bottom-color: #334155;
    }

    .chat-widget-tab {
        flex: 1;
        padding: 14px;
        text-align: center;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        color: #64748b;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
        position: relative;
    }

        .chat-widget-tab:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .chat-widget-tab.active {
            color: #6366f1;
            border-bottom-color: #6366f1;
            background: white;
        }

    body.staff-dark-mode .chat-widget-tab.active,
    body.dark-mode .chat-widget-tab.active {
        background: #1e293b;
    }

    .chat-widget-tab-badge {
        position: absolute;
        top: 8px;
        right: 20px;
        background: #ef4444;
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: 700;
    }

    /* Search Box */
    .chat-widget-search {
        padding: 12px;
        border-bottom: 1px solid #e2e8f0;
        position: relative;
    }

    body.staff-dark-mode .chat-widget-search,
    body.dark-mode .chat-widget-search {
        border-bottom-color: #334155;
    }

    .chat-widget-search input {
        width: 100%;
        padding: 10px 12px 10px 38px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 14px;
        background: white;
        color: #334155;
        transition: all 0.3s;
    }

    body.staff-dark-mode .chat-widget-search input,
    body.dark-mode .chat-widget-search input {
        background: #0f172a;
        border-color: #334155;
        color: #e2e8f0;
    }

    .chat-widget-search input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .chat-widget-search i {
        position: absolute;
        left: 24px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        pointer-events: none;
    }

    /* Body */
    .chat-widget-body {
        flex: 1;
        overflow-y: auto;
        background: #f8fafc;
    }

    body.staff-dark-mode .chat-widget-body,
    body.dark-mode .chat-widget-body {
        background: #0f172a;
    }

    /* Conversation List */
    .chat-widget-list {
        padding: 8px;
    }

    .chat-widget-conv {
        padding: 12px;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 4px;
        transition: all 0.2s;
        border: 2px solid transparent;
    }

        .chat-widget-conv:hover {
            background: rgba(99, 102, 241, 0.05);
            border-color: rgba(99, 102, 241, 0.2);
        }

        .chat-widget-conv.unread {
            background: rgba(99, 102, 241, 0.08);
        }

    .chat-widget-avatar {
        position: relative;
        flex-shrink: 0;
    }

        .chat-widget-avatar img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e2e8f0;
        }

    body.staff-dark-mode .chat-widget-avatar img,
    body.dark-mode .chat-widget-avatar img {
        border-color: #334155;
    }

    .chat-widget-online {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 12px;
        height: 12px;
        background: #10b981;
        border: 2px solid white;
        border-radius: 50%;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
    }

    body.staff-dark-mode .chat-widget-online,
    body.dark-mode .chat-widget-online {
        border-color: #0f172a;
    }

    .chat-widget-info {
        flex: 1;
        min-width: 0;
    }

    .chat-widget-name {
        font-weight: 700;
        font-size: 14px;
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #1e293b;
    }

    body.staff-dark-mode .chat-widget-name,
    body.dark-mode .chat-widget-name {
        color: #e2e8f0;
    }

    .chat-widget-time {
        font-size: 11px;
        color: #94a3b8;
        font-weight: 600;
    }

    .chat-widget-preview {
        font-size: 13px;
        color: #64748b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .chat-widget-unread {
        background: #ef4444;
        color: white;
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 10px;
        font-weight: 700;
        min-width: 20px;
        text-align: center;
    }

    /* Empty State */
    .chat-widget-empty {
        padding: 60px 20px;
        text-align: center;
        color: #94a3b8;
    }

        .chat-widget-empty i {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .chat-widget-empty p {
            font-size: 14px;
            margin: 0;
        }

    /* Loading State */
    .chat-widget-loading {
        padding: 40px 20px;
        text-align: center;
        color: #94a3b8;
    }

        .chat-widget-loading i {
            font-size: 32px;
            margin-bottom: 12px;
            animation: spin 1s linear infinite;
        }

    keyframes spin {
        from

    {
        transform: rotate(0deg);
    }

    to {
        transform: rotate(360deg);
    }

    }

    /* Message Popup */
    .chat-message-popup {
        position: fixed;
        bottom: 100px;
        right: 110px;
        width: 340px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        display: none;
        flex-direction: column;
        z-index: 10000;
        overflow: hidden;
        animation: messagePopIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    body.staff-dark-mode .chat-message-popup,
    body.dark-mode .chat-message-popup {
        background: #1e293b;
    }

    .chat-message-popup.show {
        display: flex;
    }

    keyframes messagePopIn {
        from

    {
        opacity: 0;
        transform: scale(0.8) translateY(20px);
    }

    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }

    }

    .chat-message-popup-header {
        padding: 16px;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .chat-message-popup-user {
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .chat-message-popup-user img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid white;
        }

    .chat-message-popup-user-name {
        font-weight: 700;
        font-size: 14px;
    }

    .chat-message-popup-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

        .chat-message-popup-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

    .chat-message-popup-body {
        padding: 16px;
        background: #f8fafc;
    }

    body.staff-dark-mode .chat-message-popup-body,
    body.dark-mode .chat-message-popup-body {
        background: #0f172a;
    }

    .chat-message-popup-content {
        background: white;
        padding: 12px 14px;
        border-radius: 12px;
        font-size: 14px;
        line-height: 1.5;
        color: #1e293b;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    body.staff-dark-mode .chat-message-popup-content,
    body.dark-mode .chat-message-popup-content {
        background: #1e293b;
        color: #e2e8f0;
    }

    .chat-message-popup-time {
        font-size: 11px;
        color: #94a3b8;
        margin-top: 8px;
        text-align: center;
    }

    .chat-message-popup-actions {
        padding: 12px 16px;
        display: flex;
        gap: 8px;
        border-top: 1px solid #e2e8f0;
    }

    body.staff-dark-mode .chat-message-popup-actions,
    body.dark-mode .chat-message-popup-actions {
        border-top-color: #334155;
    }

    .chat-message-popup-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .chat-message-popup-btn-reply {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
    }

        .chat-message-popup-btn-reply:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

    .chat-message-popup-btn-dismiss {
        background: #f1f5f9;
        color: #64748b;
    }

    body.staff-dark-mode .chat-message-popup-btn-dismiss,
    body.dark-mode .chat-message-popup-btn-dismiss {
        background: #334155;
        color: #94a3b8;
    }

    .chat-message-popup-btn-dismiss:hover {
        background: #e2e8f0;
    }

    body.staff-dark-mode .chat-message-popup-btn-dismiss:hover,
    body.dark-mode .chat-message-popup-btn-dismiss:hover {
        background: #475569;
    }

    /* Scrollbar */
    .chat-widget-body::-webkit-scrollbar {
        width: 6px;
    }

    .chat-widget-body::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-widget-body::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

        .chat-widget-body::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

    /* Responsive */
    media (max-width: 768px) {
        .chat-widget-popup

    {
        width: calc(100vw - 20px);
        right: 10px;
        height: calc(100vh - 140px);
    }

    .chat-message-popup {
        width: calc(100vw - 20px);
        right: 10px;
        bottom: 20px;
    }

    .chat-widget-btn {
        bottom: 20px;
        right: 20px;
        width: 56px;
        height: 56px;
    }

    }
</style>

<!-- CHAT WIDGET BUTTON -->
<button class="chat-widget-btn" id="chatWidgetBtn" onclick="toggleChatWidget()">
    <i class="fas fa-comments"></i>
    <span class="chat-widget-badge" id="chatWidgetBadge">0</span>
</button>

<!-- CHAT WIDGET POPUP -->
<div class="chat-widget-popup" id="chatWidgetPopup">
    <div class="chat-widget-header">
        <h5><i class="fas fa-comments me-2"></i>Tin nhắn</h5>
        <button class="chat-widget-close" onclick="toggleChatWidget()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div class="chat-widget-tabs">
        <div class="chat-widget-tab active" onclick="switchChatTab(event, 'recent')">
            <span>Gần đây</span>
            <span class="chat-widget-tab-badge" id="recentBadge" style="display:none;">0</span>
        </div>
        <div class="chat-widget-tab" onclick="switchChatTab(event, 'online')">
            <span>Online</span>
            <span class="chat-widget-tab-badge" id="onlineBadge" style="display:none;">0</span>
        </div>
        <div class="chat-widget-tab" onclick="switchChatTab(event, 'all')">
            <span>Tất cả</span>
        </div>
    </div>

    <div class="chat-widget-search">
        <i class="fas fa-search"></i>
        <input type="text" id="chatWidgetSearch" placeholder="Tìm kiếm người dùng...">
    </div>

    <div class="chat-widget-body" id="chatWidgetBody">
        <div class="chat-widget-loading">
            <i class="fas fa-spinner"></i>
            <p>Đang tải...</p>
        </div>
    </div>
</div>

<!-- MESSAGE NOTIFICATION POPUP -->
<div class="chat-message-popup" id="chatMessagePopup">
    <div class="chat-message-popup-header">
        <div class="chat-message-popup-user">
            <img id="popupUserAvatar" src="/images/default-avatar.png" alt="">
            <span class="chat-message-popup-user-name" id="popupUserName">User</span>
        </div>
        <button class="chat-message-popup-close" onclick="closeChatMessagePopup()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="chat-message-popup-body">
        <div class="chat-message-popup-content" id="popupMessageContent">
            Message content here...
        </div>
        <div class="chat-message-popup-time" id="popupMessageTime">Vừa xong</div>
    </div>
    <div class="chat-message-popup-actions">
        <button class="chat-message-popup-btn chat-message-popup-btn-reply" onclick="replyFromChatPopup()">
            <i class="fas fa-reply me-1"></i> Trả lời
        </button>
        <button class="chat-message-popup-btn chat-message-popup-btn-dismiss" onclick="closeChatMessagePopup()">
            Đóng
        </button>
    </div>
</div>

<script>
    // ===== CHAT WIDGET JAVASCRIPT =====
    (function() {
        // Variables
        let chatWidgetOpen = false;
        let currentChatTab = 'recent';
        let chatConversations = [];
        let allUsers = []; // ✅ THÊM BIẾN LƯU TẤT CẢ USERS
        let chatMessagePopupTimeout;
        let lastPopupConversationId = null;
        let chatHubConnection = null;

        // Toggle chat widget
        window.toggleChatWidget = function() {
            chatWidgetOpen = !chatWidgetOpen;
            const popup = document.getElementById('chatWidgetPopup');

            if (chatWidgetOpen) {
                popup.classList.add('show');
                loadChatWidgetData(); // ✅ LOAD CẢ CONVERSATIONS VÀ USERS
            } else {
                popup.classList.remove('show');
            }
        };

        // Switch tab - ✅ FIX EVENT PARAMETER
        window.switchChatTab = function(event, tab) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }

            currentChatTab = tab;
            document.querySelectorAll('.chat-widget-tab').forEach(t => t.classList.remove('active'));

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }

            renderChatWidgetList();
        };

        // ✅ LOAD BOTH CONVERSATIONS AND USERS
        async function loadChatWidgetData() {
            try {
                // Load conversations
                const convResponse = await fetch('/Chat/GetConversations');
                const convData = await convResponse.json();

                if (convData.success) {
                    chatConversations = convData.conversations || [];
                }

                // ✅ LOAD ALL USERS FOR "ALL" TAB
                const usersResponse = await fetch('/Chat/SearchUsers?query=');
                const usersData = await usersResponse.json();

                if (usersData.success || usersData.users) {
                    allUsers = usersData.users || [];
                    console.log('✅ Loaded users:', allUsers.length);
                }

                renderChatWidgetList();
                updateChatWidgetBadge();
            } catch (error) {
                console.error('❌ Error loading chat data:', error);
                showErrorState();
            }
        }

        // ✅ IMPROVED RENDER FUNCTION
        function renderChatWidgetList() {
            const body = document.getElementById('chatWidgetBody');
            const searchQuery = document.getElementById('chatWidgetSearch').value.toLowerCase();

            let filtered = [];
            let emptyMessage = 'Không có kết quả';

            // ✅ HANDLE DIFFERENT TABS
            if (currentChatTab === 'recent') {
                filtered = chatConversations;

                if (searchQuery) {
                    filtered = filtered.filter(c =>
                        c.otherUser.fullName.toLowerCase().includes(searchQuery)
                    );
                }

                emptyMessage = searchQuery ? 'Không tìm thấy cuộc trò chuyện' : 'Chưa có tin nhắn nào';

            } else if (currentChatTab === 'online') {
                filtered = chatConversations.filter(c => c.isOnline);

                if (searchQuery) {
                    filtered = filtered.filter(c =>
                        c.otherUser.fullName.toLowerCase().includes(searchQuery)
                    );
                }

                // ✅ UPDATE ONLINE BADGE
                const onlineBadge = document.getElementById('onlineBadge');
                if (onlineBadge) {
                    const onlineCount = chatConversations.filter(c => c.isOnline).length;
                    if (onlineCount > 0) {
                        onlineBadge.textContent = onlineCount;
                        onlineBadge.style.display = 'block';
                    } else {
                        onlineBadge.style.display = 'none';
                    }
                }

                emptyMessage = searchQuery ? 'Không tìm thấy người online' : 'Không có ai online';

            } else if (currentChatTab === 'all') {
                // ✅ SHOW ALL USERS
                filtered = allUsers;

                if (searchQuery) {
                    filtered = filtered.filter(u =>
                        u.fullName.toLowerCase().includes(searchQuery) ||
                        (u.email && u.email.toLowerCase().includes(searchQuery))
                    );
                }

                emptyMessage = searchQuery ? 'Không tìm thấy người dùng' : 'Không có người dùng nào';
            }

            // ✅ RENDER EMPTY STATE
            if (filtered.length === 0) {
                body.innerHTML = `
                    <div class="chat-widget-empty">
                        <i class="fas fa-${currentChatTab === 'online' ? 'user-slash' : currentChatTab === 'all' ? 'users' : 'comments'}"></i>
                        <p>${emptyMessage}</p>
                    </div>
                `;
                return;
            }

            // ✅ RENDER LIST
            if (currentChatTab === 'all') {
                // Render all users
                body.innerHTML = `
                    <div class="chat-widget-list">
                        ${filtered.map(user => `
                            <div class="chat-widget-conv" onclick="startChatFromWidget(${user.userId})">
                                <div class="chat-widget-avatar">
                                    <img src="${user.avatar || '/images/default-avatar.png'}" alt="">
                                    ${user.isOnline ? '<div class="chat-widget-online"></div>' : ''}
                                </div>
                                <div class="chat-widget-info">
                                    <div class="chat-widget-name">
                                        <span>${escapeHtmlForChat(user.fullName)}</span>
                                        <span class="chat-widget-time">
                                            ${user.roleName || 'User'}
                                        </span>
                                    </div>
                                    <div class="chat-widget-preview">
                                        ${user.departmentName || 'Bấm để bắt đầu chat'}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                // Render conversations
                body.innerHTML = `
                    <div class="chat-widget-list">
                        ${filtered.map(conv => `
                            <div class="chat-widget-conv ${conv.unreadCount > 0 ? 'unread' : ''}" onclick="openChatFromWidget(${conv.conversationId})">
                                <div class="chat-widget-avatar">
                                    <img src="${conv.otherUser.avatar || '/images/default-avatar.png'}" alt="">
                                    ${conv.isOnline ? '<div class="chat-widget-online"></div>' : ''}
                                </div>
                                <div class="chat-widget-info">
                                    <div class="chat-widget-name">
                                        <span>${escapeHtmlForChat(conv.otherUser.fullName)}</span>
                                        ${conv.unreadCount > 0 ?
                                            `<span class="chat-widget-unread">${conv.unreadCount}</span>` :
                                            '<span class="chat-widget-time">Vừa xong</span>'
                                        }
                                    </div>
                                    <div class="chat-widget-preview">
                                        ${conv.lastMessage ? escapeHtmlForChat(conv.lastMessage.content) : 'Bắt đầu trò chuyện'}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        // ✅ ERROR STATE
        function showErrorState() {
            const body = document.getElementById('chatWidgetBody');
            body.innerHTML = `
                <div class="chat-widget-empty">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Không thể tải dữ liệu</p>
                    <button onclick="location.reload()" style="margin-top:10px; padding:8px 16px; background:#6366f1; color:white; border:none; border-radius:8px; cursor:pointer;">
                        Tải lại
                    </button>
                </div>
            `;
        }

        // Update badge
        function updateChatWidgetBadge() {
            const totalUnread = chatConversations.reduce((sum, c) => sum + c.unreadCount, 0);
            const badge = document.getElementById('chatWidgetBadge');
            const recentBadge = document.getElementById('recentBadge');

            if (totalUnread > 0) {
                badge.textContent = totalUnread > 99 ? '99+' : totalUnread;
                badge.classList.add('show');

                if (recentBadge) {
                    recentBadge.textContent = totalUnread;
                    recentBadge.style.display = 'block';
                }
            } else {
                badge.classList.remove('show');
                if (recentBadge) recentBadge.style.display = 'none';
            }
        }

        // ✅ START CHAT FROM USER LIST
        window.startChatFromWidget = async function(userId) {
            try {
                const response = await fetch('/Chat/StartConversation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userId)
                });

                const data = await response.json();

                if (data.success) {
                    // Redirect to chat page
                    window.location.href = `/Chat/Index?conversationId=${data.conversationId}`;
                } else {
                    alert('Không thể bắt đầu cuộc trò chuyện. Vui lòng thử lại.');
                }
            } catch (error) {
                console.error('Error starting chat:', error);
                alert('Đã xảy ra lỗi. Vui lòng thử lại.');
            }
        };

        // Open chat page from conversation
        window.openChatFromWidget = function(conversationId) {
            window.location.href = `/Chat/Index?conversationId=${conversationId}`;
        };

        // Show message popup
        function showChatMessagePopup(senderName, senderAvatar, message, conversationId) {
            // Don't show if already on chat page or widget is open
            if (window.location.pathname === '/Chat/Index' || chatWidgetOpen) {
                return;
            }

            const popup = document.getElementById('chatMessagePopup');

            document.getElementById('popupUserAvatar').src = senderAvatar || '/images/default-avatar.png';
            document.getElementById('popupUserName').textContent = senderName;
            document.getElementById('popupMessageContent').textContent = message;
            document.getElementById('popupMessageTime').textContent = 'Vừa xong';

            lastPopupConversationId = conversationId;
            popup.classList.add('show');

            // Play sound
            const audio = document.getElementById('notifSound') || document.getElementById('adminNotifSound');
            if (audio) audio.play().catch(e => console.log('Audio play blocked'));

            // Auto hide after 8 seconds
            clearTimeout(chatMessagePopupTimeout);
            chatMessagePopupTimeout = setTimeout(() => {
                closeChatMessagePopup();
            }, 8000);
        }

        // Close message popup
        window.closeChatMessagePopup = function() {
            document.getElementById('chatMessagePopup').classList.remove('show');
            clearTimeout(chatMessagePopupTimeout);
            lastPopupConversationId = null;
        };

        // Reply from popup
        window.replyFromChatPopup = function() {
            if (lastPopupConversationId) {
                window.location.href = `/Chat/Index?conversationId=${lastPopupConversationId}`;
            } else {
                closeChatMessagePopup();
                toggleChatWidget();
            }
        };

        // Search input handler
        const searchInput = document.getElementById('chatWidgetSearch');
        if (searchInput) {
            searchInput.addEventListener('input', () => {
                renderChatWidgetList();
            });
        }

        // Helper function
        function escapeHtmlForChat(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ✅ SETUP SIGNALR FOR CHAT
        function setupChatWidgetSignalR() {
            // Wait for ChatHub connection
            if (typeof chatHubConnection !== 'undefined' && chatHubConnection) {
                console.log('✅ Chat Widget: Using existing ChatHub connection');
                setupChatHandlers(chatHubConnection);
                return;
            }

            // Try to create new connection to ChatHub
            try {
                chatHubConnection = new signalR.HubConnectionBuilder()
                    .withUrl("/chatHub")
                    .withAutomaticReconnect()
                    .build();

                chatHubConnection.start()
                    .then(() => {
                        console.log('✅ Chat Widget: Connected to ChatHub');
                        setupChatHandlers(chatHubConnection);
                    })
                    .catch(err => {
                        console.error('❌ Chat Widget: Failed to connect to ChatHub:', err);
                        // Retry after 3 seconds
                        setTimeout(setupChatWidgetSignalR, 3000);
                    });
            } catch (error) {
                console.error('❌ Chat Widget SignalR error:', error);
                setTimeout(setupChatWidgetSignalR, 3000);
            }
        }

        // ✅ SETUP CHAT MESSAGE HANDLERS
        function setupChatHandlers(connection) {
            // Listen for new messages
            connection.on('ReceiveMessage', function(messageData) {
                console.log('📨 Chat Widget: Received message', messageData);

                // Show popup if not on chat page and widget is closed
                if (!chatWidgetOpen && window.location.pathname !== '/Chat/Index') {
                    showChatMessagePopup(
                        messageData.senderName,
                        messageData.senderAvatar,
                        messageData.message || messageData.content,
                        messageData.conversationId
                    );
                }

                // Reload conversations
                loadChatWidgetData();
            });

            // Listen for user online/offline
            connection.on('UserOnline', function(userId) {
                console.log('✅ User online:', userId);
                loadChatWidgetData();
            });

            connection.on('UserOffline', function(userId) {
                console.log('❌ User offline:', userId);
                loadChatWidgetData();
            });
        }

        // ✅ AUTO RELOAD EVERY 30 SECONDS
        setInterval(() => {
            if (!chatWidgetOpen) {
                loadChatWidgetData();
            }
        }, 30000);

        // ✅ INITIALIZE ON PAGE LOAD
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Chat Widget: Initializing...');

            // Initial load
            loadChatWidgetData();

            // Setup SignalR after a short delay
            setTimeout(() => {
                setupChatWidgetSignalR();
            }, 1000);
        });

        // Also try to setup on window load
        window.addEventListener('load', function() {
            if (!chatHubConnection) {
                setupChatWidgetSignalR();
            }
        });
    })();
</script>